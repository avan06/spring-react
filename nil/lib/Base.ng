var global=this;

Object.extend=function(dest,src){
	for(var i=1,l=arguments.length;i<l;i++){
		for each(let [n,v] in Iterator(arguments[i]||{})) dest[n]=v;
	}
	return(dest);
};
Object.update=function(dest,src){
	for each(let [n,v] in Iterator(src||{})){
		if((n in dest) && (typeof(v)=='object')){
			Object.update(dest[n],v);
		}else{
			dest[n]=v;
		}
	}
	return(dest);
};

Object.copy=function OC(dest,src){
	var itr=null;
	if('__iterator__' in src){
		if(src.hasOwnProperty('__iterator__')){
			itr=dest.__iterator__=src.__iterator__;
			delete src.__iterator__;
		}else{
			itr=true;
			dest.__iterator__=src.__iterator__;
			src.__iterator__={}.__iterator__;
		}
	}
	for(let n in src){
		let g=src.__lookupGetter__(n),s=src.__lookupSetter__(n);
		if(typeof(g)=='function'){
			dest.__defineGetter__(n,g);
			if(typeof(s)=='function'){
				dest.__defineSetter__(n,s);
			}
		}else{
			delete dest[n];
			if(dest.__lookupGetter__(n)){
				OC.__defAltGSetter__(dest,n,src[n]);
			}else{
				dest[n]=src[n];
			}
		}
	}
	if(itr){
		if(typeof(itr)=='function'){
			src.__iterator__=itr;
		}else{
			delete src.__iterator__;
		}
	}
	return(dest);
};
Object.copy.__defAltGSetter__=function D(o,n,v){
	o.__defineGetter__(n,function()v);
	o.__defineSetter__(n,function(V)((this===o)?(v=V):D(this,n,V)));
};


var deserialize,unserialize,serialize;
Object.toJSON=serialize=function(obj){
	switch(typeof(obj)){
		case('undefined'):case('unknown'):	return('void(0)');
		case('boolean'):case('number'):		return(obj.toString());
		case('string'):						return(obj.quote());
		default:							return(obj===null?'null':obj.toSource());
	}
};
Object.fromJSON=deserialize=unserialize=function(str) eval(str);
Object.clone=function(obj) eval(serialize(obj));
Object.isSame=function(a,b) serialize(a)==serialize(b);
Object.keys=function(obj) [n for(n in obj)];
Object.values=function(obj) [v for each(v in obj)];

Object.isUndefined=	function(o) typeof(o)=='undefined';
Object.isString=	function(o) typeof(o)=='string';
Object.isNumber=	function(o) typeof(o)=='number';
Object.isFunction=	function(o) typeof(o)=='function';
Object.isNumeric=	function(o) !isNaN(o*1);


Object.repeat=function(obj,count){
	if(count){
		for(var i=0;i<count;i++){
			yield(obj);
		}
	}else{
		while(true){
			yield(obj);
		}
	}
};

let(gp=(o for(o in {})).__proto__){
	Object.isGenerator=function(o)(o.__proto__===gp);
	var $I=function(o){
		if(arguments.length>1){
			let c=arguments.callee,a=arguments,l=arguments.length;
			return((function(){
				for(var i=0;i<l;i++){
					for(let o in c(a[i])){
						yield(o);
					}
				}
			})());
		}else if(typeof(o)=='undefined'){
			return((o for(o in {})));
		}else if(o.__proto__===gp){
			return(o);
		}else if((typeof(o.toArray)=='function') && !(o instanceof Array) && !('__iterator__' in o)){
			arguments.callee.call(this,o.toArray());
		}else{
			return((function(){
				if(typeof(o.next)=='function'){
					try{
						for(var i=0;;){
							o.next();
							yield(i++);
						}
					}finally{
						if(typeof(o.close)=='function'){
							o.close();
						}
					}
				}else if((typeof(o.item)=='function') && ('count' in o)){
					for(var i=0,l=o.count;i<l;i++){
						yield(i);
					}
				}else if('next' in o){
					for(var i=0;o;o=o.next){
						yield(i++);
					}
				}else{
					for(let i in Iterator(o,true)){
						yield(i);
					}
				}
			})());
		}
	};
	var $E=function(o){
		if(arguments.length>1){
			let c=arguments.callee,a=arguments,l=arguments.length;
			return((function(){
				for(var i=0;i<l;i++){
					for(let o in c(a[i])){
						yield(o);
					}
				}
			})());
		}else if(typeof(o)=='undefined'){
			return((o for(o in {})));
		}else if(o.__proto__===gp){
			return(o);
		}else if((typeof(o.toArray)=='function') && !(o instanceof Array) && !('__iterator__' in o)){
			arguments.callee.call(this,o.toArray());
		}else{
			return((function(){
				if(typeof(o.next)=='function'){
					try{
						for(var i=0;;){
							yield([i++,o.next()]);
						}
					}finally{
						if(typeof(o.close)=='function'){
							o.close();
						}
					}
				}else if((typeof(o.item)=='function') && ('count' in o)){
					for(var i=0,l=o.count;i<l;i++){
						yield([i,o.item(i)]);
					}
				}else if('next' in o){
					for(var i=0;o;o=o.next){
						yield([i,o.next]);
					}
				}else{
					for each(let [n,v] in Iterator(o)){
						yield([n,v]);
					}
				}
			})());
		}
	};
	var $G=function(o){
		if(arguments.length>1){
			let c=arguments.callee,a=arguments,l=arguments.length;
			return((function(){
				for(var i=0;i<l;i++){
					for(let o in c(a[i])){
						yield(o);
					}
				}
			})());
		}else if(typeof(o)=='undefined'){
			return((o for(o in {})));
		}else if(o.__proto__===gp){
			return(o);
		}else if((typeof(o.toArray)=='function') && !(o instanceof Array) && !('__iterator__' in o)){
			arguments.callee.call(this,o.toArray());
		}else{
			return((function(){
				if(typeof(o.next)=='function'){
					try{
						while(true){
							yield(o.next());
						}
					}finally{
						if(typeof(o.close)=='function'){
							o.close();
						}
					}
				}else if((typeof(o.item)=='function') && ('count' in o)){
					for(var i=0,l=o.count;i<l;i++){
						yield(o.item(i));
					}
				}else if('next' in o){
					for(var i=0;o;o=o.next){
						yield(o);
					}
				}else{
					for each(let [n,v] in Iterator(o)){
						yield(v);
					}
				}
			})());
		}
	};
	var $D=function(root,cn,orSelf){
		if(root){
			if(orSelf){
				yield(root);
			}
			var g=$G(cn?root[cn]:root), s=[],o;
			while(g){
				try{
					yield(o=g.next());
					if(!cn){
						if(o){
							s.push(g);
							g=$G(o);
						}
					}else if(o[cn]){
						s.push(g);
						g=$G(o[cn]);
					}
				}catch(e if e===StopIteration){
					g=s.pop();
				}
			}
		}
	};
	
	gp.all=function(){
		try{
			while(true){
				yield(this.next());
			}
		}finally{
			for(let o in this){
			}
		}
	};
	
	gp.first=function(){
		for(let i in this){
			return(i);
		}
	};
	gp.last=function(){
		var res;
		for(let i in this){
			res=i;
		}
		return(res);
	};
	gp.item=function(count){
		var i=0;count=(typeof(count)=='undefined')?0:count;
		for(let o in this){
			if(i++>=count){
				return(o);
			}
		}
	};
	
	gp.head=function(count){
		var i=0;count=(typeof(count)=='undefined')?0:count;
		for(let o in this){
			yield(o);
			if(++i>=count){
				break;
			}
		}
	};
	gp.tail=function(count){
		if((count=(typeof(count)=='undefined')?0:count)>0){
			var i=0,a=new Array(count);
			for(let o in this){
				a[(i++)%count]=o;
			}
			if(i<count){
				i=0;
			}
			for(var j=0;j<count;j++){
				yield(a[(i+j)%count]);
			}
		}
	};
	gp.reverse=function(){
		var a=[];
		for(let o in this){
			a.push(o);
		}
		while(a.length){
			yield(a.pop());
		}
	};
	gp.shuffle=function(count){
		if(count){
			var a=[];
			for(let o in this){
				a.push(o);
			}
			var l=a.length,c=((typeof(count)=='number')&&(count>0))?Math.max(0,a.length-count):0;
			while(l>c){
				yield(a.splice(Math.floor(Math.random()*(l--)),1));
			}
		}else{
			var list=[this.next(),null];
			list[1]=list;
			var a=[list],i=1;
			for(let o in this){
				var r=Math.floor(Math.random()*(i++));
				a.push(a[r][1]=[o,a[r][1]]);
			}
			var r=Math.floor(Math.random()*(i));
			var list=a[r][1];a[r][1]=null;
			while(list){
				yield(list[0]);
				list=list[1];
			}
		}
	};
	gp.slice=function(start,end){
		start=start||0;
		if(start>=0){
			if(typeof(end)=='undefined'){
				var i=0;
				for(let o in this){
					if((i++)>=start){
						yield(o);
					}
				}
			}else if(end>=0){
				var i=0;
				for(let o in this){
					if((i++)>=start){
						yield(o);
					}
					if(i>=end){
						break;
					}
				}
			}else{
				var a=[];
				var i=0;
				for(let o in this){
					if((i++)>=start){
						a.push(o);
					}
				}
				a=a.slice(0,end);
				for(var i=0,l=a.length;i<l;i++){
					yield(a[i]);
				}
			}
		}else{
			var a=[];
			for(let o in this){
				a.push(o);
			}
			a=a.slice(start,end);
			for(var i=0,l=a.length;i<l;i++){
				yield(a[i]);
			}
		}
	};
	gp.devide=function(count){
		var _this=this;
		try{
			while(true){
				let top=this.next(),remain=false, cur=(function(){
					yield(top);
					for(let i=1;i<count;i++){
						yield(_this.next());
					}
					remain=true;
				})();
				yield(cur)
				for(var o in cur){
				};
				if(!remain){
					break;
				}
			}
		}finally{
			this.close();
		}
	};
	gp.repeat=function(count){
		var a=[],_this=this;
		var openCount=0, opend=true;
		var gen=function(){
			try{
				var i=0;
				while(true){
					while(i>=a.length){
						a.push(_this.next());
					}
					yield(a[i++]);
				}
			}finally{
				openCount--;
				if((openCount==0)&&!opend){
					_this.close();
				}
			}
		};
		try{
			if(count){
				for(var i=0;i<count;i++){
					openCount++;
					yield(gen());
				}
			}else{
				while(true){
					openCount++;
					yield(gen());
				}
			}
		}finally{
			opend=false;
			if(openCount==0){
				_this.close();
			}
		}
	};
	gp.loop=function(){
		var a=[];
		for(let o in this){
			yield(o);
			a.push(o);
		}
		var i=0,l=a.length;
		while(true){
			yield(a[i++]);
			i=i%l;
		}
	};
	gp.toArray=function(){
		var a=[];
		for(let o in this){
			a.push(o);
		}
		return(a);
	};
	gp.toString=function(s)(this.toArray().join((typeof(s)=='undefined')?',':s));
	
	gp.reduce=function(func,init){
		var prev=init,flag=(typeof(init)=='undefined');
		var i=0;
		for(let o in this){
			if(flag){
				prev=o;
				flag=false;
			}else{
				prev=func(prev,o,i);
			}
			i++;
		}
		return(prev);
	};
	
	gp.interval=function(ms){
		var f;
		for(let o in this){
			if(f){
				sleep(ms);
			}
			yield(o);
			f=true;
		}
	};
	gp.invoke=function(func,con){
		var args=Array.slice(arguments,1);
		for(let o in this){
			if(typeof(o[func])=='function'){
				yield(o[func].apply(o,args));
			}
		}
	};
	gp.execute=function(func,con){
		var args=Array.slice(arguments,1);
		if(typeof(func)=='function'){
			for(let o in this){
				func.call(con,o);
			}
		}else{
			for(let o in this){
				if(typeof(o[func])=='function'){
					o[func].apply(o,args);
				}
			}
		}
	};
	
	let __selector__=function(sel,context){
		if(typeof(sel)=='undefined'){
			return(function(a)(a));
		}else if(typeof(sel)=='function'){
			return(sel);
		}else if (typeof(sel)=='string'){
			return(function(a)(a[sel]));
		}else if(sel instanceof Array){
			for(var i=0,l=sel.length;i<l;i++){
				if(typeof(sel[i])=='undefined'){
					sel[i]=function(a)(a);
				}else if(typeof(sel[i])!='function'){
					let name=String(sel[i]);
					sel[i]=function(a)(a[name]);
				}
			}
			return(function(a){
				var res=[];
				for(var i=0,l=sel.length;i<l;i++){
					res.push(sel[i].call(this,a));
				}
				return(res);
			});
		}else{
			for each(let [n,v] in Iterator(sel)){
				if(typeof(v)=='undefined'){
					sel[n]=function(a)(a);
				}else if(typeof(v)!='function'){
					let name=String(v);
					sel[n]=function(a)(a[name]);
				}
			}
			return(function(a){
				var res={};
				for each(let [n,v] in Iterator(sel)){
					res[n]=v.call(this, a);
				}
				return(res);
			});
		}
	};
	
	gp.expand=function(sel,con){
		sel=__selector__(sel);
		for(let o in this){
			for(let c in $G(sel.call(con,o))){
				yield(c);
			}
		}
	};
	
	
	
	gp.union=function(g,sel,con){
		sel=__selector__(sel);
		var a=[];
		for(let o in this){
			var v=sel.call(con,o);
			if(a.indexOf(v)==-1){
				a.push(v);
				yield(o);
			}
		}
		for(let o in $G(g)){
			var v=sel.call(con,o);
			if(a.indexOf(v)==-1){
				a.push(v);
				yield(o);
			}
		}
	};
	gp.unionAll=function(g,pos){
		var i=0,f;
		for(let o in this){
			if(!f&&(f=((i++)==pos))){
				f=true;
				for(let c in $G(g)){
					yield(c);
				}
			}
			yield(o);
		}
		if(!f){
			for(let c in $G(g)){
				yield(c);
			}
		}
	};
	
	
	
	gp.innerJoin=function(rg,cond,sel){
		sel=(typeof(sel)=='function')?sel:function(l,r)([l,r]);
		var lg=this;
		rg=$G(rg);
		if(typeof(cond)!='function'){
			if(!(cond instanceof Array)){
				cond=[cond,cond];
			}
			let lsel=__selector__(cond[0]),rsel=__selector__(cond[1]);
			lg=lg.map(function(a)({v:a,c:lsel.call(null,a)}));
			rg=rg.map(function(a)({v:a,c:rsel.call(null,a)}));
			cond=function(l,r)(l.c===r.c);
			sel=let(org=sel)(function(l,r)(org(l.v,r.v)));
		}
		try{
			var g=rg.repeat();
			for(let l in lg){
				for(let r in g.next()){
					if(cond(l,r)){
						yield(sel(l,r));
					}
				}
			}
		}finally{
			g.close();
		}
	};
	
	gp.leftJoin=function(rg,cond,sel){
		sel=(typeof(sel)=='function')?sel:function(l,r)([l,r]);
		var lg=this;
		rg=$G(rg);
		if(typeof(cond)!='function'){
			if(!(cond instanceof Array)){
				cond=[cond,cond];
			}
			let lsel=__selector__(cond[0]),rsel=__selector__(cond[1]);
			lg=lg.map(function(a)({v:a,c:lsel.call(null,a)}));
			rg=rg.map(function(a)({v:a,c:rsel.call(null,a)}));
			cond=function(l,r)(l.c===r.c);
			sel=let(org=sel)(function(l,r)(org(l.v,(r||{}).v)));
		}
		try{
			var g=rg.repeat();
			for(let l in lg){
				var f=false;
				for(let r in g.next()){
					if(cond(l,r)){
						f=true;
						yield(sel(l,r));
					}
				}
				if(!f){
					yield(sel(l));
				}
			}
		}finally{
			g.close();
		}
	};
	gp.rightJoin=function(rg,cond,sel){
		sel=(typeof(sel)=='function')?sel:function(l,r)([l,r]);
		var lg=this;
		rg=$G(rg);
		if(typeof(cond)!='function'){
			if(!(cond instanceof Array)){
				cond=[cond,cond];
			}
			let lsel=__selector__(cond[0]),rsel=__selector__(cond[1]);
			lg=lg.map(function(a)({v:a,c:lsel.call(null,a)}));
			rg=rg.map(function(a)({v:a,c:rsel.call(null,a)}));
			cond=function(l,r)(l.c===r.c);
			sel=let(org=sel)(function(l,r)(org((l||{}).v,r.v)));
		}
		try{
			var g=lg.repeat();
			for(let r in rg){
				var f=false;
				for(let l in g.next()){
					if(cond(l,r)){
						f=true;
						yield(sel(l,r));
					}
				}
				if(!f){
					yield(sel(void(0),r));
				}
			}
		}finally{
			g.close();
		}
	};
	
	gp.crossJoin=function(rg,sel){
		sel=(typeof(sel)=='function')?sel:function(l,r)([l,r]);
		try{
			var g=$G(rg).repeat();
			for(let l in this){
				for(let r in g.next()){
					yield(sel(l,r));
				}
			}
		}finally{
			g.close();
		}
	};
	
	
	
	
	gp.zip=function(rg,sel){
		sel=(typeof(sel)=='function')?sel:function(l,r,i)([l,r,i]);
		try{
			var g=$G(rg);
			var i=0;
			var end=false;
			for(let l in this){
				if(end){
					yield(sel(l,void(0),i++));
				}else{
					try{
						var r=g.next();
						yield(sel(l,r,i++));
					}catch(e if e===StopIteration){
						end=true;
						yield(sel(l,void(0),i++));
					}
				}
			}
		}finally{
			if(!end){
				for(let r in g){
					yield(sel(void(0),r,i++));
				}
			}
		}
	};
	gp.innerZip=function(rg,sel){
		sel=(typeof(sel)=='function')?sel:function(l,r,i)([l,r,i]);
		try{
			var g=$G(rg);
			var i=0;
			for(let l in this){
				yield(sel(l,g.next(),i++));
			}
		}finally{
			g.close();
		}
	};
	
	gp.leftZip=function(rg,sel){
		sel=(typeof(sel)=='function')?sel:function(l,r,i)([l,r,i]);
		try{
			var g=$G(rg);
			var i=0;
			for(let r in g){
				yield(sel(this.next(),r,i++));
			}
		}finally{
			for(let l in this){
				yield(sel(l,void(0),i++));
			}
		}
	};
	
	gp.rightZip=function(rg,sel){
		sel=(typeof(sel)=='function')?sel:function(l,r,i)([l,r,i]);
		try{
			var g=$G(rg);
			var i=0;
			for(let l in this){
				yield(sel(l,g.next(),i++));
			}
		}finally{
			for(let r in g){
				yield(sel(void(0),r,i++));
			}
		}
	};
	
	
	gp.groupBy=function(sel,gsel){
		sel=__selector__(sel);
		gsel=(typeof(gsel)=='function')?gsel:function(l,r)([l,r]);
		var groups=new Dictionary(), stocks=[], count=1, closed=false;
		try{
			var g=this,read=function(){
				var o=g.next(), v=sel(o), a=groups.get(v);
				if(a){
					if(!a.closed){
						a.push(o);
					}
				}else{
					let items=groups.set(v,[o]);
					if(closed){
						items.closed=true;
					}else{
						count++;
						stocks.push(gsel(v,(function(){
							try{
								while(true){
									while(0==items.length){
										read();
									}
									yield(items.shift());
								}
							}finally{
								items.closed=true;
								if(!(--count)){
									this.close();
								}
							}
						})()));
					}
				}
			};
			while(true){
				while(0==stocks.length){
					read();
				}
				yield(stocks.shift());
			}
		}finally{
			closed=true;
			if(!(--count)){
				this.close();
			}
		}
	};
	
	
	
	gp.map=function(sel,con){
		sel=__selector__(sel);
		for(let o in this){
			yield(sel.call(con,o));
		}
	};
	gp.unique=function(sel,con){
		sel=__selector__(sel);
		var a=[];
		for(let o in this){
			var v=sel.call(con,o);
			if(a.indexOf(v)==-1){
				a.push(v);
				yield(o);
			}
		}
	};
	gp.max=function(sel,con){
		sel=__selector__(sel);
		var m,mv=Number.NEGATIVE_INFINITY;
		for(let o in this){
			var v=Number(sel.call(con,o));
			if(mv<v){
				m=o;
				mv=v;
			}
		}
		return(m);
	};
	gp.min=function(sel,con){
		sel=__selector__(sel);
		var m,mv=Number.POSITIVE_INFINITY;
		for(let o in this){
			var v=Number(sel.call(con,o));
			if(mv>v){
				m=o;
				mv=v;
			}
		}
		return(m);
	};
	gp.sum=function(sel,con){
		sel=__selector__(sel);
		var sum=0;
		for(let o in this){
			var v=Number(sel.call(con,o));
			if(!isNaN(v)){
				sum+=v;
			}
		}
		return(sum);
	};
	gp.avg=function(sel,con){
		sel=__selector__(sel);
		var i=0,sum=0;
		for(let o in this){
			var v=Number(sel.call(con,o));
			if(!isNaN(v)){
				sum+=v;
				i++;
			}
		}
		return(sum/i);
	};
	gp.count=function(){
		var i=0;
		for(let o in this){
			i++;
		}
		return(i);
	};
	gp.addIndex=function(){
		var i=0;
		for(let o in this){
			yield([i++,o]);
		}
	};
	
	let __condition__=function(cond,val){
		if(typeof(cond)=='undefined'){
			if(typeof(val)=='undefined'){
				return(function(a)(this));
			}else{
				return(function(a)(this==val));
			}
		}else if(typeof(cond)=='function'){
			if(typeof(val)=='undefined'){
				return(cond);
			}else{
				return(function(a)(cond.call(val,a)));
			}
		}else{
			if(typeof(val)=='undefined'){
				return(function(a)(a[cond]));
			}else{
				return(function(a)(a[cond]===val));
			}
		}
	};
	gp.during=function(cond,val){
		cond=__condition__(cond,val);
		for(let o in this){
			if(!cond(o)){
				break;
			}
			yield(o);
		}
	};
	gp.until=function(cond,val){
		cond=__condition__(cond,val);
		for(let o in this){
			if(cond(o)){
				break;
			}
			yield(o);
		}
	};
	gp.every=function(cond,val){
		cond=__condition__(cond,val);
		for(let o in this){
			if(!cond(o)){
				return(false);
			}
		}
		return(true);
	};
	gp.some=function(cond,val){
		cond=__condition__(cond,val);
		for(let o in this){
			if(cond(o)){
				return(true);
			}
		}
		return(false);
	};
	gp.find=function(cond,val,def){
		cond=__condition__(cond,val);
		for(let o in this){
			if(cond(o)){
				return(o);
			}
		}
		return(def);
	};
	gp.filter=function(cond,val){
		cond=__condition__(cond,val);
		for(let o in this){
			if(cond(o)){
				yield(o);
			}
		}
	};
	gp.reject=function(cond,val){
		cond=__condition__(cond,val);
		for(let o in this){
			if(!cond(o)){
				yield(o);
			}
		}
	};
	
	gp.sort=function(comp){
		return($G(this.toArray().sort(comp)));
	};
	gp.orderBy=function(sel,context){
		if(sel instanceof Array){
			var len=sel.length;
			sel=__selector__(sel);
			return($G(this.map(function(a)({v:a,c:sel.call(this,a)}),context).toArray().sort(function(l,r){
				l=l.c;r=r.c;
				for(var i=0,ll=len;i<ll;i++){
					if(l[i]<r[i]){
						return(-1);
					}else if(l[i]>r[i]){
						return(1);
					}
				}
				return(0);
			})).map('v'));
		}else{
			sel=__selector__(sel);
			return($G(this.map(function(a)({v:a,c:sel.call(this,a)}),context).toArray()
						.sort(function(l,r)(((l=l.c)<(r=r.c))?-1:((l>r)?1:0)))).map('v'));
		}
	};
	gp.orderByDesc=function(sel,context){
		if(sel instanceof Array){
			var len=sel.length;
			sel=__selector__(sel);
			return($G(this.map(function(a)({v:a,c:sel.call(this,a)}),context).toArray().sort(function(l,r){
				l=l.c;r=r.c;
				for(var i=0,ll=len;i<ll;i++){
					if(l[i]>r[i]){
						return(-1);
					}else if(l[i]<r[i]){
						return(1);
					}
				}
				return(0);
			})).map('v'));
		}else{
			sel=__selector__(sel);
			return($G(this.map(function(a)({v:a,c:sel.call(this,a)}),context).toArray()
						.sort(function(l,r)(((l=l.c)>(r=r.c))?-1:((l<r)?1:0)))).map('v'));
		}
	};
	gp.sortBy=gp.orderBy;
	gp.sortByDesc=gp.orderByDesc;
}


String.random=function(len,cc){
	var s='0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz!"#$%&\'()*+,-./:;<=>?@[\\]^_`{|}~';
	if(!cc){
		cc=36;
	}else if(typeof(cc)=='string'){
		s=cc;
		cc=s.length;
	}else if(typeof(cc)!='number'){
		cc=62;
	}
	var res=new Array(len);
	for(var i=0;i<len;i++){
		res[i]=s.charAt(Math.floor(Math.random()*cc));
	}
	return(res.join(''));
};
String.compare=function(a,b){
	a=String(a);b=String(b);
	return((a==b)?0:((a>b)?1:-1));
};

let(sp=String.prototype){
	sp.escapeHTML=function(noBR){
		var res=this.replace(/&/g,'&amp;')
					.replace(/</g,'&lt;')
					.replace(/>/g,'&gt;')
					.replace(/\t/g,'&#x9;')
					.replace(/ /g,'&#32;')
					.replace(/"/g,'&quot;');
		return(noBR?res:res.replace(/\r?\n/g,'<br />'));
	};
	sp.unescapeHTML=function(noBR){
		var table={aelig:"\u00C6",aacute:"\u00C1",acirc:"\u00C2",agrave:"\u00C0",alpha:"\u0391",aring:"\u00C5",atilde:"\u00C3",auml:"\u00C4",beta:"\u0392",ccedil:"\u00C7",chi:"\u03A7",dagger:"\u2021",delta:"\u0394",eth:"\u00D0",eacute:"\u00C9",ecirc:"\u00CA",egrave:"\u00C8",epsilon:"\u0395",eta:"\u0397",euml:"\u00CB",gamma:"\u0393",iacute:"\u00CD",icirc:"\u00CE",igrave:"\u00CC",iota:"\u0399",iuml:"\u00CF",kappa:"\u039A",lambda:"\u039B",mu:"\u039C",ntilde:"\u00D1",nu:"\u039D",oelig:"\u0152",oacute:"\u00D3",ocirc:"\u00D4",ograve:"\u00D2",omega:"\u03A9",omicron:"\u039F",oslash:"\u00D8",otilde:"\u00D5",ouml:"\u00D6",phi:"\u03A6",pi:"\u03A0",prime:"\u2033",psi:"\u03A8",rho:"\u03A1",scaron:"\u0160",sigma:"\u03A3",thorn:"\u00DE",tau:"\u03A4",theta:"\u0398",uacute:"\u00DA",ucirc:"\u00DB",ugrave:"\u00D9",upsilon:"\u03A5",uuml:"\u00DC",xi:"\u039E",yacute:"\u00DD",yuml:"\u0178",zeta:"\u0396",aacute:"\u00E1",acirc:"\u00E2",acute:"\u00B4",aelig:"\u00E6",agrave:"\u00E0",alefsym:"\u2135",alpha:"\u03B1",amp:"\u0026",and:"\u2227",ang:"\u2220",aring:"\u00E5",asymp:"\u2248",atilde:"\u00E3",auml:"\u00E4",bdquo:"\u201E",beta:"\u03B2",brvbar:"\u00A6",bull:"\u2022",cap:"\u2229",ccedil:"\u00E7",cedil:"\u00B8",cent:"\u00A2",chi:"\u03C7",circ:"\u02C6",clubs:"\u2663",cong:"\u2245",copy:"\u00A9",crarr:"\u21B5",cup:"\u222A",curren:"\u00A4",darr:"\u21D3",dagger:"\u2020",darr:"\u2193",deg:"\u00B0",delta:"\u03B4",diams:"\u2666",divide:"\u00F7",eacute:"\u00E9",ecirc:"\u00EA",egrave:"\u00E8",empty:"\u2205",emsp:"\u2003",ensp:"\u2002",epsilon:"\u03B5",equiv:"\u2261",eta:"\u03B7",eth:"\u00F0",euml:"\u00EB",euro:"\u20AC",exist:"\u2203",fnof:"\u0192",forall:"\u2200",frac12:"\u00BD",frac14:"\u00BC",frac34:"\u00BE",frasl:"\u2044",gamma:"\u03B3",ge:"\u2265",gt:"\u003E",harr:"\u21D4",harr:"\u2194",hearts:"\u2665",hellip:"\u2026",iacute:"\u00ED",icirc:"\u00EE",iexcl:"\u00A1",igrave:"\u00EC",image:"\u2111",infin:"\u221E",int:"\u222B",iota:"\u03B9",iquest:"\u00BF",isin:"\u2208",iuml:"\u00EF",kappa:"\u03BA",larr:"\u21D0",lambda:"\u03BB",lang:"\u2329",laquo:"\u00AB",larr:"\u2190",lceil:"\u2308",ldquo:"\u201C",le:"\u2264",lfloor:"\u230A",lowast:"\u2217",loz:"\u25CA",lrm:"\u200E",lsaquo:"\u2039",lsquo:"\u2018",lt:"\u003C",macr:"\u00AF",mdash:"\u2014",micro:"\u00B5",middot:"\u00B7",minus:"\u2212",mu:"\u03BC",nabla:"\u2207",nbsp:"\u00A0",ndash:"\u2013",ne:"\u2260",ni:"\u220B",not:"\u00AC",notin:"\u2209",nsub:"\u2284",ntilde:"\u00F1",nu:"\u03BD",oacute:"\u00F3",ocirc:"\u00F4",oelig:"\u0153",ograve:"\u00F2",oline:"\u203E",omega:"\u03C9",omicron:"\u03BF",oplus:"\u2295",or:"\u2228",ordf:"\u00AA",ordm:"\u00BA",oslash:"\u00F8",otilde:"\u00F5",otimes:"\u2297",ouml:"\u00F6",para:"\u00B6",part:"\u2202",permil:"\u2030",perp:"\u22A5",phi:"\u03C6",pi:"\u03C0",piv:"\u03D6",plusmn:"\u00B1",pound:"\u00A3",prime:"\u2032",prod:"\u220F",prop:"\u221D",psi:"\u03C8",quot:"\u0022",rarr:"\u21D2",radic:"\u221A",rang:"\u232A",raquo:"\u00BB",rarr:"\u2192",rceil:"\u2309",rdquo:"\u201D",real:"\u211C",reg:"\u00AE",rfloor:"\u230B",rho:"\u03C1",rlm:"\u200F",rsaquo:"\u203A",rsquo:"\u2019",sbquo:"\u201A",scaron:"\u0161",sdot:"\u22C5",sect:"\u00A7",shy:"\u00AD",sigma:"\u03C3",sigmaf:"\u03C2",sim:"\u223C",spades:"\u2660",sub:"\u2282",sube:"\u2286",sum:"\u2211",sup:"\u2283",sup1:"\u00B9",sup2:"\u00B2",sup3:"\u00B3",supe:"\u2287",szlig:"\u00DF",tau:"\u03C4",there4:"\u2234",theta:"\u03B8",thetasym:"\u03D1",thinsp:"\u2009",thorn:"\u00FE",tilde:"\u02DC",times:"\u00D7",trade:"\u2122",uarr:"\u21D1",uacute:"\u00FA",uarr:"\u2191",ucirc:"\u00FB",ugrave:"\u00F9",uml:"\u00A8",upsih:"\u03D2",upsilon:"\u03C5",uuml:"\u00FC",weierp:"\u2118",xi:"\u03BE",yacute:"\u00FD",yen:"\u00A5",yuml:"\u00FF",zeta:"\u03B6",zwj:"\u200D",zwnj:"\u200C"};
		if(noBR){
			return(this.replace(/[\s+]/g,' ')
						.replace(/<(script|style)[^>]*>.*?<\/\1>|<!--.*?-->|<[^>]*>/ig,'')
						.replace(/&(\w+);/g,function($0,$1)(table[$1]||'?'))
						.replace(/&#(\d+);/g,function($0,$1)(String.fromCharCode(parseInt($1,10))))
						.replace(/&#x([0-9a-f]+);/ig,function($0,$1)(String.fromCharCode(parseInt($1,16))))
			);
		}else{
			return(this.replace(/\r?\n/g,'').replace(/<br[^>]*>/ig,'\n').unescapeHTML(true));
		}
	};
	
	sp.times=function(c)((new Array(Math.max(0,(c||0)+1))).join(this));
	sp.indent=function(width)(" ".times(width||4)+this.replace(/\n/g,'\n'+(" ".times(width||4))));
	sp.splitCompound=function()(this.replace(/[a-z0-9](?=[A-Z])|[A-Z0-9]+(?=[A-Z][a-z0-9]+)/g,'$& ').replace(/^[^a-zA-Z0-9]+|[^a-zA-Z0-9]+$/g,'').split(/[^a-zA-Z0-9]+/g));
	sp.camelize=function(){
		var a=this.splitCompound();
		a[0]=(a[0]||'').toLowerCase();
		for(var i=1,l=a.length;i<l;i++){
			a[i]=a[i].replace(/^[a-z]/,function($0)($0.toUpperCase()));
		}
		return(a.join(''));
	}
	sp.dasherize=function()(this.splitCompound().join('-').toLowerCase());
	sp.underscore=function()(this.splitCompound().join('_').toLowerCase());
	sp.include=function(s)(this.indexOf(s)>-1)
	sp.includes=function(s)(this.indexOf(s)>-1)
	sp.startsWith=function(s)(this.indexOf(s)===0);
	sp.endsWith=function(s,o)((o=this.length-s.length)>=0&&(this.lastIndexOf(s)===o));
	
	sp.grep=function(re){
		re=(re||/.*/);
		re=new RegExp(re.source,"g"+(re.ignoreCase?'i':'')+(re.multiline?'m':''));
		var m;
		while(m=re.exec(this)){
			yield(m);
		}
	};
	
	sp.separate=function(sep,includeSeparator){
		sep=sep||/\r?\n/;
		if(!(sep instanceof RegExp)){
			sep=new RegExp(sep);
		}
		sep=new RegExp("(.*?)("+sep.source+"|$)","g"+(sep.multiline?"m":"")+(sep.ignoreCase?"i":""));
		var m;
		if(includeSeparator){
			while(m=sep.exec(this)){
				yield(m[0]);
				if(!m[2]){
					break;
				}
			}
		}else{
			while(m=sep.exec(this)){
				yield(m[1]);
				if(!m[2]){
					break;
				}
			}
		}
	};
	sp.expand=function(){
		var g,m=this.match(/^(.*?)(?:\{(.*?)\}|\[(.*?)\])(.*)/);
		if(!m){
			return($G([this]));
		}else if(m[3]=m[3]||m[2]){
			var m2,type=16,uc=false;
			if(m2=m[3].match(/^(\d+)-(\d*)(?:\:(\d+))?$/i)){
				type=10;
			}else if(m2=m[3].match(/^([0-9a-f]+)-([0-9a-f]*)(?:\:(\d+))?$/i)){
				uc=!!m[3].match(/[A-F]/);
			}else if(m2=m[3].match(/^([0-9a-f]+)~([0-9a-f]*)(?:\:(\d+))?$/i)){
				uc=true;
			}else if(!(m2=m[3].match(/^([0-9a-f]+)_([0-9a-f]*)(?:\:(\d+))?$/i))){
				g=$G(m[3].split(/,/g));
			}
			if(!g){
				var start=m2[1], end=m2[2];
				g=Number.rangeTo(parseInt(start,type),end?parseInt(end,type):void(0),Number(m2[3]||1));
				if(!end||((start.length==end.length)&&(start.match(/^0/)||end.match(/^0/)))){
					var width=-start.length;
					if(type==10){
						g=g.map(function(n)(('0000000000000000'+n.toString(type)).slice(width)));
					}else if(uc){
						g=g.map(function(n)(('0000000000000000'+n.toString(type)).slice(width).toUpperCase()));
					}else{
						g=g.map(function(n)(('0000000000000000'+n.toString(type)).slice(width).toLowerCase()));
					}
				}else{
					if(type==10){
						g=g.map(function(n)(n.toString(type)));
					}else if(uc){
						g=g.map(function(n)(n.toString(type).toUpperCase()));
					}else{
						g=g.map(function(n)(n.toString(type).toLowerCase()));
					}
				}
			}
			var h=m[1];
			return(g.crossJoin(m[4].expand(),function(l,r)(h+l+r)));
		}
	};
	
	sp.format=function(opt){
		opt=String(opt||"V");
		var res=this;
		if(opt.match(/a/)){
			res=res.replace(/[ａ-ｚＡ-Ｚ０-９]/g,function($0)(String.fromCharCode($0.charCodeAt(0)-65248)));
		}else if(opt.match(/A/)){
			res=res.replace(/[a-zA-Z0-9]/g,function($0)(String.fromCharCode($0.charCodeAt(0)+65248)));
		}else{
			if(opt.match(/r/)){
				res=res.replace(/[ａ-ｚＡ-Ｚ]/g,function($0)(String.fromCharCode($0.charCodeAt(0)-65248)));
			}else if(opt.match(/R/)){
				res=res.replace(/[a-zA-Z]/g,function($0)(String.fromCharCode($0.charCodeAt(0)+65248)));
			}
			if(opt.match(/n/)){
				res=res.replace(/[０-９]/g,function($0)(String.fromCharCode($0.charCodeAt(0)-65248)));
			}else if(opt.match(/N/)){
				res=res.replace(/[0-9]/g,function($0)(String.fromCharCode($0.charCodeAt(0)+65248)));
			}
		}
		if(opt.match(/s/)){
			res=res.replace(/　/g,' ');
		}else if(opt.match(/S/)){
			res=res.replace(/ /g,'　');
		}
		if(opt.match(/m/)){
			res=res.replace(/[！-／：-＠［-｀｛-〜￥]/g,function($0)(String.fromCharCode(($0=='￥')?'\\':($0.charCodeAt(0)-65248))));
		}else if(opt.match(/M/)){
			if(opt.match(/Y/)){
				res=res.replace(/[\!-\/\:-\@\[-\`\{-\~]/g,function($0)(($0=='\\')?'￥':String.fromCharCode($0.charCodeAt(0)+65248)));
			}else{
				res=res.replace(/[\!-\/\:-\@\[-\`\{-\~]/g,function($0)(String.fromCharCode($0.charCodeAt(0)+65248)));
			}
		}else{
			if(opt.match(/E/)){
				if(opt.match(/Y/)){
					res=res.replace(/[\\\:\/\"\*\?\<\>\|]/g,function($0)(($0=='\\')?'￥':String.fromCharCode($0.charCodeAt(0)+65248)));
				}else{
					res=res.replace(/[\\\:\/\"\*\?\<\>\|]/g,function($0)(String.fromCharCode($0.charCodeAt(0)+65248)));
				}
			}
			if(opt.match(/f/)){
				res=res.replace(/[！＃＄％＆（）＋，−．；＝＠［］＾＿｀｛｝〜]/g,function($0)(String.fromCharCode($0.charCodeAt(0)-65248)));
			}
		}
		var _K_={"ｧ":"ァ","ｱ":"ア","ｨ":"ィ","ｲ":"イ","ｩ":"ゥ","ｳ":"ウ","ｪ":"ェ","ｴ":"エ","ｫ":"ォ","ｵ":"オ","ｶ":"カ","ｷ":"キ","ｸ":"ク","ｹ":"ケ","ｺ":"コ","ｻ":"サ","ｼ":"シ","ｽ":"ス","ｾ":"セ","ｿ":"ソ","ﾀ":"タ","ﾁ":"チ","ｯ":"ッ","ﾂ":"ツ","ﾃ":"テ","ﾄ":"ト","ﾅ":"ナ","ﾆ":"ニ","ﾇ":"ヌ","ﾈ":"ネ","ﾉ":"ノ","ﾊ":"ハ","ﾋ":"ヒ","ﾌ":"フ","ﾍ":"ヘ","ﾎ":"ホ","ﾏ":"マ","ﾐ":"ミ","ﾑ":"ム","ﾒ":"メ","ﾓ":"モ","ｬ":"ャ","ﾔ":"ヤ","ｭ":"ュ","ﾕ":"ユ","ｮ":"ョ","ﾖ":"ヨ","ﾗ":"ラ","ﾘ":"リ","ﾙ":"ル","ﾚ":"レ","ﾛ":"ロ","ヮ":"ヮ","ﾜ":"ワ","ｦ":"ヲ","ﾝ":"ン","ﾞ":"゛","ﾟ":"゜","ｶﾞ":"ガ","ｷﾞ":"ギ","ｸﾞ":"グ","ｹﾞ":"ゲ","ｺﾞ":"ゴ","ｻﾞ":"ザ","ｼﾞ":"ジ","ｽﾞ":"ズ","ｾﾞ":"ゼ","ｿﾞ":"ゾ","ﾀﾞ":"ダ","ﾁﾞ":"ヂ","ﾂﾞ":"ヅ","ﾃﾞ":"デ","ﾄﾞ":"ド","ﾊﾞ":"バ","ﾊﾟ":"パ","ﾋﾞ":"ビ","ﾋﾟ":"ピ","ﾌﾞ":"ブ","ﾌﾟ":"プ","ﾍﾞ":"ベ","ﾍﾟ":"ペ","ﾎﾞ":"ボ","ﾎﾟ":"ポ","ｳﾞ":"ヴ","ｰ":"ー"};
		if(opt.match(/V/)){
			res=res.replace(/([ｦ-ﾝﾞﾟ])([ﾞﾟ]?)/g,function($0,$1,$2)(_K_[$0]||((_K_[$1]||$1)+(_K_[$2]||$2))));
		}else if(opt.match(/K/)){
			res=res.replace(/[ｦ-ﾝﾞﾟｰ]/g,function($0)(_K_[$0]||$0));
		}else if(opt.match(/k/)){
			var _k_={"ァ":"ｧ","ア":"ｱ","ィ":"ｨ","イ":"ｲ","ゥ":"ｩ","ウ":"ｳ","ェ":"ｪ","エ":"ｴ","ォ":"ｫ","オ":"ｵ","カ":"ｶ","ガ":"ｶﾞ","キ":"ｷ","ギ":"ｷﾞ","ク":"ｸ","グ":"ｸﾞ","ケ":"ｹ","ゲ":"ｹﾞ","コ":"ｺ","ゴ":"ｺﾞ","サ":"ｻ","ザ":"ｻﾞ","シ":"ｼ","ジ":"ｼﾞ","ス":"ｽ","ズ":"ｽﾞ","セ":"ｾ","ゼ":"ｾﾞ","ソ":"ｿ","ゾ":"ｿﾞ","タ":"ﾀ","ダ":"ﾀﾞ","チ":"ﾁ","ヂ":"ﾁﾞ","ッ":"ｯ","ツ":"ﾂ","ヅ":"ﾂﾞ","テ":"ﾃ","デ":"ﾃﾞ","ト":"ﾄ","ド":"ﾄﾞ","ナ":"ﾅ","ニ":"ﾆ","ヌ":"ﾇ","ネ":"ﾈ","ノ":"ﾉ","ハ":"ﾊ","バ":"ﾊﾞ","パ":"ﾊﾟ","ヒ":"ﾋ","ビ":"ﾋﾞ","ピ":"ﾋﾟ","フ":"ﾌ","ブ":"ﾌﾞ","プ":"ﾌﾟ","ヘ":"ﾍ","ベ":"ﾍﾞ","ペ":"ﾍﾟ","ホ":"ﾎ","ボ":"ﾎﾞ","ポ":"ﾎﾟ","マ":"ﾏ","ミ":"ﾐ","ム":"ﾑ","メ":"ﾒ","モ":"ﾓ","ャ":"ｬ","ヤ":"ﾔ","ュ":"ｭ","ユ":"ﾕ","ョ":"ｮ","ヨ":"ﾖ","ラ":"ﾗ","リ":"ﾘ","ル":"ﾙ","レ":"ﾚ","ロ":"ﾛ","ヮ":"ヮ","ワ":"ﾜ","ヲ":"ｦ","ン":"ﾝ","ヴ":"ｳﾞ","ー":"ｰ"};
			res=res.replace(/[ァ-ワヲンヴー]/g,function($0)(_k_[$0]||$0));
		}
		return(res);
	};
	
}

var $A=Array.from=function(o){
	if(!o){
		return([]);
	}else if(o.toArray){
		return(o.toArray());
	}else if(('next' in o)||((typeof(o.item)=='function') && ('count' in o))){
		return($G(o).toArray());
	}else if('length' in o){
		var l=Number(o.length||0),r=new Array(l);
		while(l--){
			r[l]=o[l];
		}
		return(r);
	}else{
		return([i for each(i in o)]);
	}
}


let(ap=Array.prototype){
	//Arrayの汎用ユーティリティメソッドはここで追加
	ap.toArray=function()this;
	
	ap.insert=function(pos){
		var l=arguments.length;
		var a=new Array(l+1);
		a[0]=pos||0;
		a[1]=0;
		for(var i=1;i<l;i++){
			a[i+1]=arguments[i];
		}
		this.splice.apply(this,a);
		return(this);
	};
	ap.remove=function(obj){
		var i;
		while((i=this.indexOf(obj))!=-1){
			this.splice(i,1);
		}
		return(this);
	};
	ap.replace=function(from,to){
		var i;
		while((i=this.indexOf(from))!=-1){
			this.splice(i,1,to);
		}
		return(this);
	};
	ap.contains=function(o)(this.indexOf(o)!=-1);
	
	ap.range=function(from,to,step){
		from=Number(from);
		to=Number(to||(this.length));
		step=Number(step||1);
		from=(from>0)?from:(this.length+from);
		to=(to>0)?to:(this.length+to);
		if(from<to){
			for(var i=Math.max(0,from),l=Math.min(this.length,to);i<l;i+=step){
				yield(this[i]);
			}
		}else{
			for(var i=Math.min(this.length-1,from),l=Math.max(-1,to);i>l;i-=step){
				yield(this[i]);
			}
		}
	};
	ap.random=function()(this[Math.floor(Math.random()*this.length)]);
	
	ap.choice=function(count){
		var l=this.length;
		if(count){
			for(var i=0;i<count;i++){
				yield(this[Math.floor(Math.random()*l)]);
			}
		}else{
			while(true){
				yield(this[Math.floor(Math.random()*l)]);
			}
		}
	};
	
	ap.clone=function()	this.slice(0);
	ap.first=function()	this[0];
	ap.last=function()	this[this.length-1];
	ap.head=function(c)	this.slice(0,c);
	ap.tail=function(c)	this.slice(-c);
	ap.count=function()	this.length;
	ap.sum=function(a1,a2)	((arguments.length>0)?$G(this).sum(a1,a2):(this.reduce(function(l,r)l+r)));
	ap.avg=function(a1,a2)	((arguments.length>0)?$G(this).avg(a1,a2):(this.sum()/this.length));
	ap.min=function(a1,a2)	((arguments.length>0)?$G(this).min(a1,a2):Math.min.apply(Math,this));
	ap.max=function(a1,a2)	((arguments.length>0)?$G(this).max(a1,a2):Math.max.apply(Math,this));
	
	ap.pluck=function(n){
		var r=new Array(this.length),i=this.length;
		while(i--){
			r[i]=this[i][n];
		}
		return(r);
	};
	
}
Array.range=function(ary,from,to,step)($A(ary).range(from,to,step));

let(np=Number.prototype){
	np.toChar=function()String.fromCharCode(this);
	np.abs=function()	Math.abs(this);
	np.round=function()	Math.round(this);
	np.ceil=function()	Math.ceil(this);
	np.floor=function()	Math.floor(this);
	np.format=function(w,d)((d&&d<0)?(d=(this*Math.pow(10,-d)).format(w-d),d.slice(0,w)+'.'+d.slice(w)):(d=Math.floor(this).toString(d||10),(new Array(1+Math.max(0,(w||0)-d.length))).join('0')+d));
}

Number.random=function(r1,r2,inc){
	switch(arguments.length){
		case(0):{
			return(this.random(0x100000000));
		}case(1):{
			r2=0;
		}default:{
			[r1,r2]=(r1>r2)?[r2,r1]:[r1,r2];
			if(r1==r2){
				return(r1);
			}else if(inc){
				r2++;
			}
			return(r1+Math.floor(Math.random()*(r2-r1)));
		}
	}
};

var $R=Number.range=function(from,to,step){
	step=step||1;
	from=Number(from);
	if(typeof(to)=='undefined'){
		var i=from;
		while(true){
			yield(i);
			i+=step;
		}
	}else{
		to=Number(to);
		step=Math.abs(step);
		if(from<to){
			for(var i=from;i<to;i+=step){
				yield(i);
			}
		}else{
			for(var i=from;i>to;i-=step){
				yield(i);
			}
		}
	}
};

Number.rangeTo=function(from,to,step){
	step=step||1;
	from=Number(from);
	if(typeof(to)=='undefined'){
		var i=from;
		while(true){
			yield(i);
			i+=step;
		}
	}else{
		to=Number(to);
		step=Math.abs(step);
		if(from<to){
			for(var i=from;i<=to;i+=step){
				yield(i);
			}
		}else{
			for(var i=from;i>=to;i-=step){
				yield(i);
			}
		}
	}
};





/*
TODO  MSDOSのバイナリ表現のデコード
*/
Date.from=function(str,_tz){
	if((typeof(str)=='object')&&(str instanceof Date)){
		return(str);
	}
	var __monthNames__={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};
	var __wdayNames__={sun:1,mon:2,tue:3,wed:4,thu:5,fri:6,sat:7};
	var __tzNames__={gmt:0,utc:0,edt:-4,est:-5,cdt:-5,cst:-6,mdt:-6,mst:-7,pdt:-7,pst:-8,jst:9};
	var __tzChars__={z:0,a:-1,b:-2,c:-3,d:-4,e:-5,f:-6,g:-7,h:-8,i:-9,k:-10,l:-11,m:-12,n:1,o:2,p:3,q:4,r:5,s:6,t:7,u:8,v:9,w:10,x:11,y:12};
	
	var now=(new Date()), tzo=now.getTimezoneOffset()*60000, nms=now.getTime()+tzo, ny=now.getFullYear();
	var x, res, min, a=[], y=0, m=0, w=0, tz=(typeof(_tz)=="undefined")?-tzo:((_tz||0)*60000), ms=0, v=0;
	
	
	str=(String(str).toLowerCase()
		.replace(/\b(?:19|20)\d\d\b/								,function($0)(y=true,$0))
		.replace(/\d{5,}/											,function($0)(a.push($0*1-tz,$0*1000-tz),$0))
		.replace(/\b(?:jan|feb|mar|apr|may|jun|jul|aug|sep)/		,function($0)('0'+(m=__monthNames__[$0])))
		.replace(/\b(?:oct|nov|dec)/								,function($0)((m=__monthNames__[$0])))
		.replace(/\b(?:sun|mon|tue|wed|thu|fri|sat)/				,function($0)((w=__wdayNames__[$0]),""))
		.replace(/\b(?:gmt|utc|edt|est|cdt|cst|mst|mdt|pdt|pst|jst)/,function($0)((tz=__tzNames__[$0]),""))
		.replace(/\b[a-ik-y]\b/i									,function($0)((tz=__tzChars__[$0]),""))
		.replace(/\+([012]?\d)(?:[^\d]*([0-5]?\d))?[^\d]*$|-([012]?\d)(?:[^\-\d]*([0-5]?\d))?[^\d]*$/,function($0,$1,$2,$3,$4)((tz=(($1||0)*3600000+($2||0)*60000)||-($3*3600000+($4||0)*60000)),""))
		.replace(/([^\.]\d\d?)\.(\d)\b/,"$1.00$2").replace(/([^\.]\d\d?)\.(\d\d)\b/,"$1.0$2")
		.replace(/\b(\d)\b/g,"0$1").replace(/[^\d]/g,'')+"00000000000000000").slice(0,17);
	
	if(x=str.match(/^(\d{4})(0\d|1[012])([012]\d|3[01])([01]\d|2[0-3])([0-5]\d)([0-5]\d)(\d{3})/)){
		a.push(Date.UTC(x[1],x[2]-1,x[3],x[4],x[5],x[6],x[7])-tz);
	}
	if(x=str.match(/^(0\d|1[012])([012]\d|3[01])(\d{4})([01]\d|2[0-3])([0-5]\d)([0-5]\d)(\d{3})/)){
		a.push(Date.UTC(x[3],x[1]-1,x[2],x[4],x[5],x[6],x[7])-tz);
	}
	if(x=str.match(m?/^([012]\d|3[01])(0\d|1[012])(\d{4})([01]\d|2[0-3])([0-5]\d)([0-5]\d)(\d{3})/
					:/^([012]\d|3[01])(0\d|1[012])(19\d\d|20\d\d)([01]\d|2[0-3])([0-5]\d)([0-5]\d)(\d{3})/)){
		a.push(Date.UTC(x[3],x[2]-1,x[1],x[4],x[5],x[6],x[7])-tz);
	}
	if(x=str.match(/^(0\d|1[012])([012]\d|3[01])([01]\d|2[0-3])([0-5]\d)([0-5]\d)(19\d\d|20\d\d)(\d{3})/)){
		a.push(Date.UTC(x[6],x[1]-1,x[2],x[3],x[4],x[5],x[7]));
	}
	if(x=str.match(/^([01]\d|2[0-3])([0-5]\d)([012]\d|3[01])(0\d|1[012])(19\d\d|20\d\d)/)){
		a.push(Date.UTC(x[5],x[4]-1,x[3],x[1],x[2],0,0));
	}
	if(!y){
		if(x=str.match(/^(\d{2})(0\d|1[012])([012]\d|3[01])([01]\d|2[0-3])([0-5]\d)([0-5]\d)(\d{3})/)){
			x[1]=Number(20+x[1]);(x[1]>ny)&&(x[1]-=100);
			a.push(Date.UTC(x[1],x[2]-1,x[3],x[4],x[5],x[6],x[7])-tz);
		}
		if(x=str.match(/^(0\d|1[012])([012]\d|3[01])(\d{2})([01]\d|2[0-3])([0-5]\d)([0-5]\d)(\d{3})/)){
			x[3]=Number(20+x[3]);(x[3]>ny)&&(x[3]-=100);
			a.push(Date.UTC(x[3],x[1]-1,x[2],x[4],x[5],x[6],x[7])-tz);
		}
		if(x=str.match(/^([012]\d|3[01])(0\d|1[012])(\d{2})([012]\d|2[0-3])([0-5]\d)([0-5]\d)(\d{3})/)){
			x[3]=Number(20+x[3]);(x[3]>ny)&&(x[3]-=100);
			a.push(Date.UTC(x[3],x[2]-1,x[1],x[4],x[5],x[6],x[7])-tz);
		}
	}
	for(var i=0,l=a.length;i<l;i++){
		var o=Math.abs(nms-a[i]);
		var time=new Date(a[i]+tz);
		if(!res||(min>o)){
			if((!m||(time.getUTCMonth()==(m-1)))&&(!w||(time.getUTCDay()==(w-1)))){
				res=new Date(a[i]);
				min=o;
			}
		}
	}
	return(res||new Date(0));
};

Date.weeks=7*24*3600000;
Date.days=24*3600000;
Date.hours=3600000;
Date.minutes=60000;
Date.seconds=1000;
Date.now=function() new Date;
var now=Date.now;
Date.range=function(from,to,step){
	step=Math.abs(step||24*3600000);
	from=Date.from(from,true);
	from=from.getTime();
	to=Date.from(to,true);
	to=to.getTime();
	if(from<to){
		for(var ms=from;ms<to;ms+=step){
			yield(new Date(ms));
		}
	}else{
		for(var ms=from;ms>to;ms-=step){
			yield(new Date(ms));
		}
	}
}

let(dp=Date.prototype){
	//Dateの汎用ユーティリティメソッドはここで追加
	dp.getLocalDate=dp.getDate;
	dp.getLocalDay=dp.getDay;
	dp.getLocalFullYear=dp.getFullYear;
	dp.getLocalHours=dp.getHours;
	dp.getLocalMilliseconds=dp.getMilliseconds;
	dp.getLocalMinutes=dp.getMinutes;
	dp.getLocalMonth=dp.getMonth;
	dp.getLocalSeconds=dp.getSeconds;
	dp.getLocalDate=dp.getDate;
	
	dp.getMonthName=function()(({0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"})[this.getMonth()]);
	dp.getLocalMonthName=function()(({0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"})[this.getMonth()]);
	dp.getUTCMonthName=function()(({0:"January",1:"February",2:"March",3:"April",4:"May",5:"June",6:"July",7:"August",8:"September",9:"October",10:"November",11:"December"})[this.getUTCMonth()]);
	dp.getMonthShorthName=function()(this.getMonthName().slice(0,3));
	dp.getLocalMonthShorthName=function()(this.getMonthName().slice(0,3));
	dp.getUTCMonthShortName=function()(this.getUTCMonthName().slice(0,3));
	dp.getDayName=function()(({0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday"})[this.getDay()]);
	dp.getLocalDayName=function()(({0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday"})[this.getDay()]);
	dp.getUTCDayName=function()(({0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday"})[this.getUTCDay()]);
	dp.getDayShortName=function()(this.getDayName().slice(0,3));
	dp.getLocalDayShortName=function()(this.getDayName().slice(0,3));
	dp.getUTCDayShortName=function()(this.getUTCDayName().slice(0,3));
	dp.getUTCTime=function()(this.getTime());
	dp.getLocalTime=function()(this.getTime()-60000*this.getTimezoneOffset());
	dp.add=function(ms)(new Date(this.getTime()+60000*this.getTimezoneOffset()+(ms||0)));
	dp.subtract=function(d)(this.getTime()-((d instanceof this.constructor)?d:this.constructor.from(d)).getTime());
	dp.format=function(str,tz)(let(t=new Date(this.getTime()+60000*(((typeof(tz)=="undefined")?-this.getTimezoneOffset():(tz||0)))))(
		(String(str||'yyyy/mm/dd hh:nn:ss').toLowerCase()).replace(/([dhmnpswy])\1*/g,function(s){
			switch(s.slice(0,1)){
				case('y'):return(t.getUTCFullYear());
				case('m'):return(('0'+(t.getUTCMonth()+1)).slice(-2));
				case('d'):return(('0'+(t.getUTCDate())).slice(-2));
				case('h'):return(('0'+(t.getUTCHours())).slice(-2));
				case('n'):return(('0'+(t.getUTCMinutes())).slice(-2));
				case('s'):return(('0'+(t.getUTCSeconds())).slice(-2));
				case('p'):return(('00'+(t.getUTCMilliseconds())).slice(-3));
				default:return(s);
			}
		})
	));
	dp.toRFCFormat=function(sec,week)(let(o=-this.getTimezoneOffset())(
		this.getDayShortName()+', '+this.format('d')+' '+this.getMonthShorthName()
		+this.format('y h:n:s')+((o>0)?" GMT+":" GMT-")+Math.floor(o/60).format(2)+(o%60).format(2)
	));
	dp.toW3CFormat=function(prec){
		var tzo=-this.getTimezoneOffset();
		var tz=((tzo>0)?"+":"-")+Math.floor(tzo/60).format(2)+':'+(tzo%60).format(2);
		switch((prec||'').toLowerCase()){
			case('year'):case('y'):{
				return(this.format('y'));
			}case('month'):case('m'):case('mon'):{
				return(this.format('y-m'));
			}case('day'):case('d'):{
				return(this.format('y-m-d'));
			}case('minutes'):case('min'):{
				return(this.format('y-m-d')+'T'+this.format('h:n')+tz);
			}default:{
				return(this.format('y-m-d')+'T'+this.format('h:n:s')+tz);
			}
		}
	};
}




//RegExp
RegExp.escape=function(str) String(str)
							.replace(/(?=[\.*+?^=!:${}()|[\]\/\\])/g,"\\$1")
							.replace(/\n/,'\\n')
							.replace(/\r/,'\\r')
							.replace(/\t/,'\\t')
							.replace(/\v/,'\\v')
							.replace(/\f/,'\\f');
RegExp.from=function(s,o){
	if(!(s instanceof Array)){
		s=[s];
	}
	var a=[];
	for(var i=0,l=s.length;i<l;i++){
		a[a.length]=RegExp.escape(s[i]);
	}
	return(new RegExp(a.join('|'),o||""));
}

let(rp=RegExp.prototype){
	rp.match=rp.test;
}

Function.from=function(str){
	str=String(str);
	var args,m=str.match(/^\s*([\$\w\,\s]*)\s*:\s*(.*)$/);
	if(m){
		args=m[1].split(/\s*\,\s*/);
		str=m[2];
	}else{
		args=["$1","$2","$3","$4","$5","$6","$7","$8","$9"];
	}
	return(eval('function('+args.join(',')+')('+str+')'));
};
var $L=Function.from;

Function.doNothing=function(){};
let(fp=Function.prototype){
	fp.loop=function(){
		while(true){
			yield(this.apply(null,arguments));
		}
	};
	
	fp.loopApply=function(thisObj,args,count){
		args=$A(args);
		if(count){
			for(var i=0;i<count;i++){
				yield(this.apply(thisObj,args));
			}
		}else{
			while(true){
				yield(this.apply(thisObj,args));
			}
		}
	}
	
	fp.__defineGetter__('parameters',function(){
		var names = this.toString().match(/^[\s\(]*function[^\(]*\(([^\)]*)\)/)[1].split(/\s*,\s*/);
		return names.length == 1 && !names[0] ? [] : names;
	});
	fp.__defineGetter__('statements',function(){
		return(this.toString().replace(/^[\s\(]*function[^\(]*\([^\)]*\)\s*((\{[\n\r]*)([\s\S]*)\}|[\s\S]*)/m,function($0,$1,$2,$3){
			return($2?$3:('    return '+$1+';\n'));
		}));
		
	});
	fp.isGenerator=function(){
		try{
			eval('throw("not a generator");'+this.statements.replace(/\breturn\b/g,''));
		}catch(e){
			return(e instanceof SyntaxError);
		}
	};
	fp.unclose=function() eval(this.toString());
	fp.bind=function(){
		var thisFunc=this,obj=arguments[0],args=Array.slice(arguments,1);
		return(function(){
			var a=args.slice(0);
			for(var i=0,l=arguments.length;i<l;i++){
				a.push(arguments[i]);
			}
			return(thisFunc.apply(obj,a));
		});
	};
	fp.curry=function(){
		if(arguments.length<1){
			return(this);
		}
		var thisFunc=this,a=Array.slice(arguments,0);
		return(function(){
			var args=a.slice(0);
			for(var i=0,l=arguments.length;i<l;i++){
				args.push(arguments[i]);
			}
			return(thisFunc.apply(this,args));
		});
	};
	fp.wrap=function(wrapFunc){
		var thisFunc=this;
		return(function(){
			var thisObj=this,a=[function()(thisFunc.apply(thisObj,arguments))];
			for(var i=0,l=arguments.length;i<l;i++){
				a.push(arguments[i]);
			}
			return(wrapFunc.apply(this,a));
		});
	};
	fp.methodize=function(){
		if(!this.__methodized__){
			var thisFunc=this;
			this.__methodized__=function(){
				var a=[this];
				for(var i=0,l=arguments.length;i<l;i++){
					a.push(arguments[i]);
				}
				return(thisFunc.apply(null,a));
			};
		}
		return(this.__methodized__);
	};
	
	fp.__toProceed__=function(t,e,a,i)let(f=this)((i<0)?(function()f.apply(t,e)):(function()a[i].call(t,e,f.__toProceed__(t,e,a,i-1))));
	fp.__toAdvisedFunction__=function(obj,op,nm){
		var F=this.valueOf(),f=(function(){
			if(this===obj){
				let A=f.__advised__,env=Array.slice(arguments);env.original=F;env.operation=op;env.name=nm;
				try{
					for(var i=0,b=A.before,l=b.length;i<l;i++){b[i].call(this,env);}
					env.result=F.__toProceed__(this,env,A.around,A.around.length-1)();
					for(var i=0,r=A.returning,l=r.length;i<l;i++){r[i].call(this,env);}
				}catch(e){
					env.exception=e;
					for(var i=0,t=A.throwing,l=t.length;i<l;i++){t[i].call(this,env);}
					if(!env.caught){throw(env.exception);}
				}finally{
					for(var i=0,a=A.after,l=a.length;i<l;i++){a[i].call(this,env);}
				}
				return(env.result);
			}else{
				return(F.apply(this,arguments));
			}
		});
		f.__advised__={before:[],around:[],returning:[],throwing:[],after:[]};f.valueOf=F.valueOf.bind(F);f.toString=F.toString.bind(F);
		return(f);
	};
};
let(oa=(Object.advise=function(obj,step,op,name,func){
	var g,s,own=obj.hasOwnProperty(name);
	if(!(g=obj.__lookupGetter__(name))||(!own&&g.valueOf().__isAlt__)){
		[g,s]=oa.mkAltGSetter(obj,name);g.__isAlt__=true;
	}else{
		s=obj.__lookupSetter__(name)||oa.throwNoSetterError;
	}
	if(!g.__advised__||!own){
		obj.__defineGetter__(name,g=g.__toAdvisedFunction__(obj,'get',name));
		obj.__defineSetter__(name,s=s.__toAdvisedFunction__(obj,'set',name));
		g.__advised__.returning.push(oa.mkAfterGetAdvice(name,g));
		s.__advised__.before.push(oa.mkBeforeSetAdvice(name,g));
	}
	((op=='call')?(g.__onCall__||(g.__onCall__={before:[],around:[],returning:[],throwing:[],after:[]})):((op=='get')?g:s).__advised__)[step].push(func);
})){
	oa.mkAltGSetter=function(o,n)(let(v=o[n])[function()v, function(V)((this===o)?(v=V):Object.copy.__defAltGSetter__(this,n,V))]);
	oa.throwNoSetterError=function(){throw(new TypeError('setting a property that has only a getter'));};
	oa.mkBeforeSetAdvice=function(n,g)(function(a)let(oc=g.__onCall__)(
		(oc&&(typeof(a[0])=='function')&&a[0].__advised__!==oc)&&((a[0]=a[0].__toAdvisedFunction__(this,'call',n)).__advised__=oc)
	));
	oa.mkAfterGetAdvice=function(n,g)(function(e)(let(oc=g.__onCall__)
		(oc&&(typeof(e.result)=='function')&&e.result.__advised__!==oc)&&((e.result=e.result.__toAdvisedFunction__(this,'call',n)).__advised__=oc)
	));
}

var Class=function(){
	var c=function(){
		c.maybeInitialize();
		if(this.constructor!=c){
			return((c.__call__||c.create).apply(c,arguments));
		}else{
			return(this.__new__.apply(this,arguments)||this);
		}
	};
	c.prototype.constructor=c;
	c.initialized=false;
	c.__subclasses__=[];
	c.__mixee__=[];
	c.__classMembers__={};
	c.__prototypeMembers__={};
	if(arguments[0] instanceof Class){
		arguments[0].__transmit__(c);
		arguments=Array.slice(arguments,1);
	}else{
		c.prototype.__new__=Function.doNothing;
		c.__proto__=Class.prototype;
	}
	for(let i=0,l=arguments.length;i<l;i++)c.addMembers(arguments[i]);
	return(c);
};
Class.prototype={
	__proto__:Function.prototype,
	constructor:Class,
	initialize:Function.doNothing,
	__transmit__:function(d){
		this.__subclasses__.push(d);
		d.prototype.__proto__=(d.__proto__=d.superClass=this).prototype;
	},
	
	create:function()eval('new this('+['arguments['+i+']' for each([i,v] in Iterator($A(arguments)))].join(',')+')'),
	
	maybeInitialize:function(){
		if(!this.initialized){
			this.initialized=true;
			if(this.superClass)this.superClass.maybeInitialize();
			this.initialize();
		}
		return(this);
	},
	$:function(op,a1,a2,a3)let(p=this.prototype)((op=='get')?((op=p.__lookupGetter__(a1))?op.call(a2):p[a1])
													:((op=='set')?((op=p.__lookupSetter__(a1))&&op.call(a2,a3))
													:p[op].apply(a1,Array.slice(arguments,2)))),
	addMembers:function(src){
		for(var i=0,l=arguments.length;i<l;i++){
			if(arguments[i] instanceof Class){
				arguments[i].mixInto(this);
			}else{
				if('__class__' in arguments[i]){
					this.addClassMembers(arguments[i].__class__);
					delete arguments[i].__class__;
				}
				this.addPrototypeMembers(arguments[i]);
			}
		}
		return(this);
	},
	addClassMembers:function(src){
		Object.copy(this.__classMembers__,src);Object.copy(this,src);
		for(var i=0,m=this.__mixee__,l=m.length;i<l;i++)if(m[i] instanceof Class) m[i].addClassMembers(src);
		return(this);
	},
	addPrototypeMembers:function(src){
		Object.copy(this.__prototypeMembers__,src);
		Object.copy(this.prototype,src);
		for(var i=0,m=this.__mixee__,l=m.length;i<l;i++){
			if(m[i] instanceof Class){
				m[i].addPrototypeMembers(src);
			}else{
				Object.copy(m[i],src);
			}
		}
		return(this);
	},
	
	addAliases:function(pair){
		var mems={};
		var p=this.__prototypeMembers__;
		for each(let [a,n] in Iterator(pair)){
			let name=n;
			mems.__defineGetter__(a,function()this[name]);
			if(!p.__lookupGetter__(n) || p.__lookupSetter__(n)){
				mems.__defineSetter__(a,function(val)this[name]=val);
			}
		}
		this.addPrototypeMembers(mems);
		return(this);
	},
	addClassAliases:function(){
		var mems={};
		var p=this.__classMembers__;
		for each(let [a,n] in Iterator(pair)){
			let name=n;
			mems.__defineGetter__(a,function()this[name]);
			if(!p.__lookupGetter__(n) || p.__lookupSetter__(n)){
				mems.__defineSetter__(a,function(val)this[name]=val);
			}
		}
		this.addClassMembers(mems);
		return(this);
	},
	classMethodize:function(){
		var p=this.__prototypeMembers__;
		var argc=(p.__new__||{parameters:[]}).parameters.length;
		var names=Array.join(arguments,",").split(/,/);
		var mems;
		
		for(var i=0,l=names.length;i<l;i++){
			let name=names[i];
			if(name.match(/\(\)$/)){
				name=name.replace(/\(\)$/,'');
				(mems||(mems={}))[name]=function()(this.prototype[name].apply(this.create.apply(this,Array.slice(arguments,0,argc)),Array.slice(arguments,argc)));
			}else{
				(mems||(mems={}))[name]=function()(this.create.apply(this,arguments)[name]);
			}
		}
		if(mems){
			this.addClassMembers(mems);
		}
		return(this);
	},
	
	
	
	mixInto:function(t){
		if(this.superClass)this.superClass.mixInto(t);
		if(t instanceof Class){
			t.addClassMembers(this.__classMembers__);
			t.addPrototypeMembers(this.__prototypeMembers__);
		}else{
			Object.copy(t,this.__prototypeMembers__);
		}
		this.__mixee__.push(t);
		return(this);
	},
	singletonize:function()((new Class(Singleton,{__class__:this.prototype})).maybeInitialize()),
};
Class.__proto__=Class.prototype;
Class.__subclasses__=[];

var Advice=function(s,o,m,f){
	this.execute=(typeof(m)=='string')?(function(t,l)((m in (l||t))&&Object.advise(t,s,o,m,f)))
		:let(filter=(typeof(m)=='function')?m:(function(o,n)m.test(n)))(function(t,l){for(let n in l||t)if(filter(t,n))Object.advise(t,s,o,n,f);});
};
var Aspect=new Class({__class__:{
	__transmit__:function(d){
		Class.__transmit__.call(this,d);
		for(let n in d)if(!d.__lookupGetter__(n)&&(d[n] instanceof Advice))d[n].execute(d);
	},
	mixInto:function(target){
		if(target instanceof Class){
			let cm=this.__classMembers__,ca={};for(let n in cm)if(!cm.__lookupGetter__(n)&&(cm[n] instanceof Advice))ca[n]=cm[n];
			(function R(c){for(var i=0,s=c.__subclasses__,l=s.length;i<l;i++){for(let n in ca)ca[n].execute(s[i]);R(s[i]);}})(target);
			target.addClassMembers({addClassMembers:this.addClassMembers,addPrototypeMembers:this.addPrototypeMembers});
		}
		Class.mixInto.call(this,target);
		if(!(target instanceof Class)){
			let p=this.prototype;
			for(let n in p)if(!p.__lookupGetter__(n)&&(p[n] instanceof Advice))p[n].execute(target);
		}
	},
	addClassMembers:function(src){
		var old={};for(let n in this)if(!this.__lookupGetter__(n)&&(this[n] instanceof Advice))old[n]=this[n];
		Class.addClassMembers.call(this,src);
		for(let n in old)if(!(n in src))old[n].execute(this,src);
		for(let n in src)if(!src.__lookupGetter__(n)&&(src[n] instanceof Advice))src[n].execute(this);
	},
	addPrototypeMembers:function(src){
		Class.addPrototypeMembers.call(this,src);
		let o=this.prototype.__new__.valueOf(),nn=function(){
			var p=this.__proto__;for(let n in p)if(!p.__lookupGetter__(n)&&(p[n] instanceof Advice))p[n].execute(this);
			this.__new__=o;this.__new__.apply(this,arguments);
		};nn.valueOf=o.valueOf.bind(o);nn.toString=o.toString.bind(o);this.prototype.__new__=nn;
	},
}});





var EnumerableMixinForArray=new Class({
	invoke:function()(let(g=$G(this))(g.invoke.apply(g,arguments).toArray())),
	execute:function()(let(g=$G(this))(g.execute.apply(g,arguments))),
	
	reduce:function(f,i)($G(this).reduce(f,i)),
	shuffle:function(c)($G(this).shuffle(c).toArray()),
	devide:function(c)($G(this).devide(c).toArray()),
	map:function(s,c)($G(this).map(s,c).toArray()),
	unique:function(s,c)($G(this).unique(s,c).toArray()),
	
	during:function(c,o)($G(this).during(c,o).toArray()),
	until:function(c,o)($G(this).until(c,o).toArray()),
	every:function(c,o)($G(this).every(c,o).toArray()),
	some:function(c,o)($G(this).some(c,o).toArray()),
	find:function(c,o)($G(this).find(c,o).toArray()),
	filter:function(c,o)($G(this).filter(c,o).toArray()),
	reject:function(c,o)($G(this).reject(c,o).toArray()),
	
	orderBy:function(s,c)($G(this).orderBy(s,c).toArray()),
	orderByDesc:function(s,c)($G(this).orderByDesc(s,c).toArray()),
	sortBy:function(s,c)($G(this).orderBy(s,c).toArray()),
	sortByDesc:function(s,c)($G(this).orderByDesc(s,c).toArray()),
	groupBy:function(s,g)($G(this).groupBy(s,g).toArray()),
	
	zip:function(r,s)($G(this).zip(r,s).toArray()),
	leftZip:function(r,s)($G(this).leftZip(r,s).toArray()),
	rightZip:function(r,s)($G(this).rightZip(r,s).toArray()),
	innerZip:function(r,s)($G(this).innerZip(r,s).toArray()),
	
	innerJoin:function(r,c,s)($G(this).innerJoin(r,c,s).toArray()),
	leftJoin:function(r,c,s)($G(this).leftJoin(r,c,s).toArray()),
	rightJoin:function(r,c,s)($G(this).rightJoin(r,c,s).toArray()),
	crossJoin:function(r,s)($G(this).crossJoin(r,s).toArray()),
	
	unionAll:function(g,p)($G(this).unionAll(g,p).toArray()),
	union:function(g,s,c)($G(this).union(g,s,c).toArray()),
	expand:function(s,c)($G(this).expand(s,c).toArray()),
});
EnumerableMixinForArray.mixInto(Array.prototype);


var EnumerableMixin=new Class(EnumerableMixinForArray,{
	slice:function(s,e)($G(this).slice(s,e).toArray()),
	tail:function(c)($G(this).tail(c).toArray()),
	last:function()($G(this).last()),
	
	head:function(c)($G(this).head(c).toArray()),
	first:function()($G(this).first()),
	reverse:function()($G(this).reverse().toArray()),
	toArray:function()($G(this).toArray()),
	sort:function(f)($G(this).sort(f).toArray()),
	
	count:function(f)($G(this).count()),
	max:function(s,c)($G(this).max(s,c)),
	min:function(s,c)($G(this).min(s,c)),
	sum:function(s,c)($G(this).sum(s,c)),
	avg:function(s,c)($G(this).avg(s,c)),
});
var EnumerableMixinForCountable=new Class(EnumerableMixinForArray,{
	last:function()(this.item(this.count-1)),
	tail:function(c){
		var a=new Array(c);
		var s=this.count-c;
		for(var i=0;i<c;i++){
			a[i]=this.item(s+i);
		}
		return(a);
	},
	slice:function(from,to,step){
		step=Math.abs(step||1);
		from=Number(from);
		to=Number(to||(this.count));
		from=Math.max(0,Math.min(this.count,(from>0)?from:(this.count+from)));
		to=Math.max(0,Math.min(this.count,(to>0)?to:(this.count+to)));
		if(from>to){
			[from,to]=[to,from];
			step=-step;
		}
		var a=new Array(to-from);
		for(var i=from,l=to;i<l;i+=step){
			a[i-from]=this.item(i);
		}
		return(a);
	},
	
	head:function(c)($G(this).head(c).toArray()),
	first:function()($G(this).first()),
	slice:function(s,e)($G(this).slice(s,e).toArray()),
	reverse:function()($G(this).reverse().toArray()),
	toArray:function()($G(this).toArray()),
	sort:function(f)($G(this).sort(f).toArray()),
	
	max:function(s,c)($G(this).max(s,c)),
	min:function(s,c)($G(this).min(s,c)),
	sum:function(s,c)($G(this).sum(s,c)),
	avg:function(s,c)($G(this).avg(s,c)),
});





let(__void__={}){
	var Dictionary=new Class({
		__class__:{
		},
		__new__:function(obj){
			this.__keys__=[];
			this.__values__=[];
			for(var i=0,l=arguments.length;i<l;i++){
				var a=arguments[i];
				if(a instanceof Array){
					this.set(a[0],a[1]);
				}
			}
		},
		has:function(key)((this.__keys__.indexOf(key)!=-1)?this:void(0)),
		get:function(key){
			var i=this.__keys__.indexOf(key);
			if(i!=-1){
				return(this.__values__[i]);
			}
		},
		set:function(key,value){
			var i=this.__keys__.indexOf(key);
			if(i!=-1){
				this.__values__[i]=value;
			}else{
				this.__keys__.push(key);
				this.__values__.push(value);
			}
			return(value);
		},
		setPairs:function(){
			for(var i=0,l=arguments.length;i<l;i++){
				var a=arguments[i];
				if(a instanceof Array){
					this.set(a[0],a[1]);
				}
			}
			return(this);
		},
		unset:function(key){
			for(var i=0,l=arguments.length;i<l;i++){
				var idx=this.__keys__.indexOf(key);
				if(idx!=-1){
					this.__keys__[idx]=__void__;
				}
			}
			return(this);
		},
		merge:function(obj)(this.clone().update(obj)),
		update:function(obj){
			for each(let [n,v] in Iterator(obj||{})){
				this.set(n,v);
			}
			return(this);
		},
		clone:function(){
			var res=new this.constructor();
			res.__keys__=this.__keys__.slice(0);
			res.__values__=this.__values__.slice(0);
			return(res);
		},
		__iterator__:function(noValue){
			if(noValue){
				for(var i=0,k=this.__keys__,l=k.length;i<l;i++){
					if(k[i]!==__void__){
						yield(k[i]);
					}
				}
			}else{
				for(var i=0,k=this.__keys__,v=this.__values__,l=k.length;i<l;i++){
					if(k[i]!==__void__){
						yield([k[i],v[i]]);
					}
				}
			}
		},
	});
}







var FirstInstanceMixin=new Class({
	__getFirstInstance__:function()let(i,t)((i=this.__instanceIdentifier__)?((t=this.constructor.__firstInstances__)[i]||(t[i]=this)):this),
	__removeFirstInstance__:function()(this.__instanceIdentifier__&&(delete(this.constructor.__firstInstances__[String(this.__instanceIdentifier__)]))),
});

var FindInstanceMixin=new Class({
	__class__:{
		select:function(){
			if(arguments.length==0){
				for(let o in this.all){
					yield(o);
				}
			}else{
				for(let o in this.all){
					let f;
					for(var i=0,l=arguments.length;(i<l)&&!f;i++){
						var c=arguments[i];
						c=(c instanceof RegExp)?({__instanceText__:[c]}):((typeof(c)!='object')?({__instanceName__:[c]}):c);
						f=true;
						for each(let [n,v] in Iterator(c)){
							let f2,x,m=o[n];
							for(let i=0,l=(v=(v instanceof Array)?v:[v]).length;(i<l)&&!f2;i++){
								switch(typeof(x=v[i])){
									case('object'):			f2=(x instanceof RegExp)?(x.test(m)):(('__instanceIdentifier__' in x)?(m.__instanceIdentifier__==x.__instanceIdentifier__):(m===x));
									break;case('function'):	f2=x(o);
									break;default:			f2=m==x;
								}
							}
							if(!f2){
								f=false;
								break;
							}
						}
					}
					if(f){
						yield(o);
					}
				}
			}
		},
		find:function(){
			for(var o in this.select.apply(this,arguments)){
				return(o);
			}
		},
		waitExists:function(cond,timeout,interval){
			var r;
			cond=(cond instanceof Array)?cond:[cond];
			var deadline=timeout?((new Date()).getTime()+timeout):Number.POSITIVE_INFINITY;
			while(!(r=this.find.apply(this,cond))){
				if((new Date()).getTime()>deadline){
					break;
				}
				sleep(interval||20);
			}
			return(r);
		},
		waitExtinct:function(cond,timeout,interval){
			cond=(cond instanceof Array)?cond:[cond];
			var deadline=timeout?((new Date()).getTime()+timeout):Number.POSITIVE_INFINITY;
			while(r=this.find.apply(this,cond)){
				if((new Date()).getTime()>deadline){
					return(r);
				}
				sleep(interval||20);
			}
		},
		
	},
});



var EventMixin=(new Class({},FirstInstanceMixin,{
	__class__:{
		__observe__:Function.doNothing,
		__observeFirst__:Function.doNothing,
		__unobserve__:Function.doNothing,
		__unobserveLast__:Function.doNothing,
		isObserved:function(name)(!!(this.__events__&&this.__events__[name])),
		
		unobserveAll:function(){
			var e=this.__events__;
			if(e){
				delete(this.__events__);
				for(let n in e){
					this.__observe__(n,true);
				}
				delete(this.__events__);
				this.__unobserveLast__();
			}
			return(this);
		},
		unobserve:function(name,func){
			if(!this.__events__ || !this.__events__[name]){
			}else if(name instanceof Array){
				for(var i=0,l=name.length;i<l;i++){
					this.unobserve(name[i],func);
				}
			}else{
				var ary=[];
				if(func){
					if(!(func instanceof Array)){
						func=[func];
					}
					for(var i=0,a=this.__events__[name],l=a.length;i<l;i++){
						if(func.indexOf(a[i])==-1){
							ary.push(a[i]);
						}
					}
				}
				if((this.__events__[name]=ary).length==0){
					delete(this.__events__[name]);
					this.__unobserve__(name);
					try{
						for(let n in Iterator(this.__events__)) throw(1);
						delete(this.__events__);
						this.__unobserveLast__();
					}catch(e){}
					
				}
			}
			return(this);
		},
		
		observe:function(name,func,stop){
			if(name instanceof Array){
				for(var i=0,l=name.length;i<l;i++){
					this.observe(name[i],func,stop);
				}
			}else{
				if(!this.__events__){
					this.__events__={};
					this.__observeFirst__();
				}
				if(!this.__events__[name]){
					this.__events__[name]=[];
					this.__observe__(name,false);
				}
				if(func instanceof Array){
					for(var i=0,l=func.length;i<l;i++){
						this.__events__[name].push(func[i]);
					}
				}else{
					this.__events__[name].push(func);
				}
			}
			return(this);
		},
		fire:function(name,obj){
			(obj=obj||{}).event=name;
			var a=(this.__events__||{})[name]||[];
			var s=false;
			try{
				for(var i=a.length-1;i>=0;i--){
					s=a[i].call(this,obj,s)||s;
				}
			}catch(e if e===obj){
				s=true;
			}
			return(s?void(0):obj);
		},
		
		wait:function(name,timeout){
			try{
				var s=new Signal();
				var cb=function(){s.pulse();}
				this.observe(name,cb);
				return(s.wait(timeout)&&this);
			}finally{
				this.unobserve(name,cb);
				s.free();
			}
		},
		
	},
	__observe__:Function.doNothing,
	__observeFirst__:Function.doNothing,
	__unobserve__:Function.doNothing,
	__unobserveLast__:Function.doNothing,
	__observable__:function()(true),
	
	observe:function(name,func){
		var obj=this.__getFirstInstance__();
		if(obj.__observable__){
			return(this.constructor.observe.call(obj,name,func));
		}
	},
	isObserved:function(name)(this.constructor.isObserved.call(this.__getFirstInstance__(),name)),
	unobserve:function(name,func)(this.constructor.unobserve.call(this.__getFirstInstance__(),name,func)),
	unobserveAll:function()(this.constructor.unobserveAll.call(this.__getFirstInstance__())),
	fire:function(name,obj)(this.constructor.fire.call(this.__getFirstInstance__(),name,obj)),
	
	wait:function(name,timeout){
		try{
			var s=new Signal();
			var cb=function(){s.pulse();}
			this.observe(name,cb);
			return(s.wait(timeout));
		}finally{
			s.free();
			this.unobserve(name,cb);
		}
	},
	
	inheritEvents:function(){
		var e=this.__events__||(this.__events__={});
		for each(let [n,v] in Iterator(this.constructor.__events__)){
			if(!(n in e)){
				this.__observe__(n,false);
			}
			e[n]=v.slice(0);
		}
		return(this);
	},
}));


/*
EventMixin.addMembers({
	observe:EventMixin.observe,
	unobserve:EventMixin.unobserve,
	unobserveAll:EventMixin.unobserveAll,
	fire:EventMixin.fire,
});


*/








let(MemAlloc=__NG__Alloc, MemFree=__NG__Free, MemMove=__NG__MoveMemory){
	var Buffer=new Class({
		__class__:{
			get read()(let(ptr=this.pointer)(function(addr)new ptr(addr))),
			get write()(let(s=this.size)(s?(function(a,v)((v instanceof Pointer)&&MemMove(a,v.valueOf(),s))):Function.doNothing)),
			get pointer()(this.hasOwnProperty('__pointerClass__')?this.__pointerClass__:(this.__pointerClass__=new Class(Pointer,{__class__:{entity:this}}))),
			alloc:function(){
				if(!this.size){
					return(Object.extend(new ((this===Buffer)?Byte.pointer:this.pointer)(MemAlloc(arguments[0]||1)),{size:arguments[0]||1}));
				}else if(arguments.length>0){
					var count=1,dim=Array.slice(arguments);
					for(var i=0,l=dim.length;i<l;i++){
						count*=dim[i];
					}
					var ptr=new (this.pointer)(MemAlloc(this.size*count));
					ptr.dimensions=dim;
					ptr.count=count;
					return(ptr);
				}else{
					return(new (this.pointer)(MemAlloc(this.size)));
				}
			},
		},
	});
	
	var Primitive=new Class(Class,{
		__new__:function(char,size,getter,setter)(
			new Class({},Buffer,{
				__class__:{symbol:char, size:size, read:getter, write:setter},
				__new__:function(value){this.valueOf=function()value||0},
				free:Function.doNothing,
			})
		)
	});
	var UInt,UShort,UChar;
	var Int			=new Primitive('i',4,__NG__GetInt,		__NG__SetInt);
	var Dword=UInt	=new Primitive('u',4,__NG__GetUInt,		__NG__SetUInt);
	var Short		=new Primitive('s',2,__NG__GetShort,	__NG__SetShort);
	var Word=UShort	=new Primitive('w',2,__NG__GetWord,		__NG__SetWord);
	var Char		=new Primitive('c',1,__NG__GetChar,		__NG__SetChar);
	var Byte=UChar	=new Primitive('b',1,__NG__GetByte,		__NG__SetByte);
	var Double		=new Primitive('d',8,__NG__GetDouble,	__NG__SetDouble);
	var Float		=new Primitive('f',4,__NG__GetFloat,	__NG__SetFloat);
	var Pointer=new Class(UInt,{
		__class__:{
			get entity()(new Class({},Buffer,{__class__:{pointer:this}})),
			from:function(obj){
				if(obj==null){
					return(new this(0));
				}else{
					var e=this.entity,p=e.alloc();
					e.write(p.valueOf(),obj);
					return(p);
				}
			},
		},
		
		get size()(this.constructor.entity.size*(this.count||1)),
		
		offset:function(pos){
			if(typeof(pos.length)=='undefined'){
				pos=arguments;
			}
			if(this.dimensions && pos.length){
				var offset=0,m=1;
				for(var i=0,d=this.dimensions,l=d.length;i<l;i++){
					offset+=(pos[i]||0)*m;
					m*=d[i];
				}
				return(offset);
			}else{
				return(pos[0]||0);
			}
			
		},
		
		inc:function(count){
			var s=this.constructor.entity.size;
			if(!s){
				throw(new TypeError('unknown size type'));
			}
			return(new this.constructor(this.valueOf()+s*(count||0)));
		},
		
		item:function(){
			var e=this.constructor.entity;
			var r=e.read(this.valueOf()+this.offset(arguments)*e.size);
			return(e.entity?(new e(r)):r);
		},
		update:function(){
			var e=this.constructor.entity;
			if(this.dimensions && (arguments[0] instanceof Array)){
				var s=e.size,dim=this.dimensions;
				(function f(p,a,d){
					if(d==0){
						for(var i=0,l=dim[0];i<l;i++){
							e.write(p,a[i]);
							p+=s;
						}
					}else{
						for(var i=0,l=dim[d];i<l;i++){
							p=f(p,a[i]||[],d-1);
						}
					}
					return(p);
				})(this.valueOf(),arguments[0],dim.length-1);
			}else{
				e.write(this.valueOf()+this.offset(Array.slice(arguments,1))*e.size,arguments[0]);
			}
			return(this);
		},
		
		copy:function(dest,len){
			MemMove(dest,this.valueOf(),this.constructor.entity.size*(len||this.length||this.count||1));
		},
		
		clone:function(){
			var res=new this.constructor(MemAlloc(this.size));
			MemMove(res.valueOf(),this.valueOf(),this.size);
			return(res);
		},
		
		toArray:function(){
			if('count' in this){
				var l=this.count,a=new Array(l);
				var m=('toObject' in this)?'toObject':'toString';
				for(var i=0;i<l;i++){
					a[i]=this.inc(i)[m]();
				}
				return(a);
			}else{
				return([('toObject' in this)?this.toObject():this.toString()]);
			}
		},
		
		convert:function(){
			var res=(this.toObject||this.toString).call(this);
			this.free();
			return(res);
		},
		free:function(){
			if(!this.freed){
				MemFree(this.valueOf());
				this.freed=true;
			}
		},
	});
	
	var PInt=Int.pointer;
	var PDword=UInt.pointer;
	var PShort=Short.pointer;
	var PWord=UShort.pointer;
	var PChar=Char.pointer;
	var PByte=UChar.pointer;
	
	var WChar=new Class(UShort);
	var WideString=WChar.pointer;
	WideString.addMembers({
		__class__:{
			from:function(obj)(new this((obj==null)?0:__NG__ToPWStr(String(obj)))),
		},
		update:function(v){
			if(v instanceof Array){
				Pointer.prototype.update.call(this,v);
			}else if(typeof(v)=='number'){
				UShort.write(this.valueOf(),v);
			}else{
				__NG__SetWStr(this.valueOf(),v);
			}
		},
		toString:function()(this.valueOf()?__NG__GetWStr(this.valueOf()):""),
	});
	
	
	var MultiWideString=new Class(WideString,{
		__class__:{
			from:function(obj){
				if(obj==null){
					return(new this(0));
				}else{
					var a=$A(obj),size=0;
					for(var i=0,l=a.length;i<l;i++){
						a[i]=a[i].toString();
						size+=a[i].length+1;
					}
					size++;
					var p=WChar.alloc(size);
					var pos=p.valueOf();
					for(var i=0,l=a.length;i<l;i++){
						__NG__SetWStr(pos,a[i]);
						pos+=a[i].length*2+2;
					}
					return(new this(p.valueOf()));
				}
			},
		},
		toArray:function(){
			var a=[];
			var p=this.valueOf();
			while(1){
				var s=(new WideString(p)).toString();
				if(s==""){
					break;
				}
				a.push(s);
				p+=s.length*2+2;
			}
			return(a);
		},
		toString:function()(this.toArray().join('\n')),
	});
	
	
	
	var Struct=new Class(Class,{
		__new__:function(){
			var klass,ptr;
			if(arguments[0] && arguments[0].defineMembers==Struct.defineMembers){
				klass=new Class(arguments[0]);
				ptr=(klass.pointer=new Class(arguments[0].pointer,{__class__:{entity:klass}}));
				for(var i=1,l=arguments.length;i<l;i++){
					ptr.addMembers(arguments[i]);
				}
			}else{
				klass=new Class({},Buffer,{__class__:{pointer:null,align:4,defineMembers:Struct.defineMembers}});
				ptr=(klass.pointer=new Class(Pointer,{__class__:{entity:klass}}));
				
				var f=false;
				for(var i=0,l=arguments.length;i<l;i++){
					if(typeof(arguments[i])=='number'){
						klass.align=([1,2,4,8,16,32].indexOf(arguments[i])!=-1)?arguments[i]:klass.align;
					}
				}
				for(var i=0,l=arguments.length;i<l;i++){
					if(typeof(arguments[i])=='number'){
					}else if(!arguments[i]){
						f=true;
					}else if(!f){
						klass.defineMembers(arguments[i]);
						f=true;
					}else{
						ptr.addMembers(arguments[i]);
					}
				}
			}
			return(klass);
		},
	});
	Struct.defineMembers=function(mems){
		var mtds={}, size=0, bitoffset=0, maxFieldSize=0, ptr=this.pointer,align=this.align;
		for each(let [n,v] in Iterator(mems)){
			if((v instanceof Array) && (v.length>0) && (typeof(v[0])!='number')){
				if(v.length==1){
					v=v[0].pointer;
				}else{
					let c=1, d=v.slice(1), p=v[0].pointer;
					for(let i=0;i<d.length;i++)c*=d[i];
					v={ maxFieldSize:v[0].maxFieldSize||v[0].size, size:v[0].size*c,
						read:function(a){var pt=new p(a);pt.dimensions=d;pt.count=c;return(pt);},
						write:function(a,v){var pt=new p(addr);pt.dimensions=d;pt.count=c;pt.update(v);},
					};
				}
			}
			if((typeof(v)=='number') || (v instanceof Array)){
				let t=null;
				if(v instanceof Array){
					t=v[1]||t;
					v=v[0];
				}
				let len=Math.abs(v);
				if((bitoffset+len)>align*8){
					size+=align;
					bitoffset=0;
				}
				let o=size, top=32-bitoffset-len, btm=32-len, r=UInt.read, w=UInt.write, R=Int.read;
				mtds.__defineGetter__(n,(v>0)?(t?(function()(new t((r(this.valueOf()+o)<<top)>>>btm)))
													:(function()((r(this.valueOf()+o)<<top)>>>btm))
												):(t?(function()(new t((R(this.valueOf()+o)<<top)>>btm)))
													:(function()((R(this.valueOf()+o)<<top)>>btm))
				));
				let m=(-1<<btm)>>>top;
				mtds.__defineSetter__(n,function(v)(w(this.valueOf()+o,(r(this.valueOf()+o)|m)&((v<<btm)>>>top))));
				bitoffset+=len;
				maxFieldSize=Math.max(maxFieldSize,align);
			}else{
				if(bitoffset>0){
					size+=align;
					bitoffset=0;
				}else if(align>1){
					size+=let(l=Math.min(align,v.maxFieldSize||v.size))(l-((size%l)||l));
				}
				let r=v.read,w=v.write,o=size;
				if(v.entity){
					mtds.__defineGetter__(n,let(vv=v)function() new vv(r(this.valueOf()+o)));
				}else{
					mtds.__defineGetter__(n,function() r(this.valueOf()+o));
				}
				mtds.__defineSetter__(n,function(v) w(this.valueOf()+o,v));
				
				
				size+=v.size;
				maxFieldSize=Math.max(maxFieldSize,v.maxFieldSize||v.size);
			}
		}
		size=let(l=Math.min(align,maxFieldSize))(size+l-((size%l)||l));
		this.addClassMembers({
			size:size,		maxFieldSize:maxFieldSize,		members:mems,
			write:function(a,v){
				if(v instanceof Pointer){
					MemMove(a,v.valueOf(),size);
				}else{
					var p=new ptr(a);
					for(let n in mems)p[n]=v[n];
				}
			},
			
		});
		mtds.toObject=function(){
			var r={};
			for(let n in ptr.__prototypeMembers__){
				r[n]=let(v=this[n])(v.toObject?v.toObject():v.toString());
			}
			return(r);
		};
		this.pointer.addPrototypeMembers(mtds);
	};

	
	
	var Union=new Class(Class,{
		__new__:function(){
			var klass=new Class({},Buffer,{__class__:{pointer:null,align:4,defineMembers:Union.defineMembers}});
			var ptr=(klass.pointer=new Class(Pointer,{__class__:{entity:klass}}));
			if(typeof(arguments[0])=='number'){
				klass.align=([1,2,4,8,16,32].indexOf(arguments[0])!=-1)?arguments[0]:4;
				arguments=Array.slice(arguments,1);
			}
			if(arguments.length>0){
				if(arguments[0]){
					klass.defineMembers(arguments[0]);
				}
				arguments=Array.slice(arguments,1);
			}
			for(var i=0,l=arguments.length;i<l;i++){
				ptr.addMembers(arguments[i]);
			}
			return(klass);
		},
	});
	Union.defineMembers=function(mems){
		var mtds={}, size=0, maxFieldSize=0;
		for each(let [n,v] in Iterator(mems)){
			if(v instanceof Array){
				if(v.length==1){
					mems[n]=v=v[0].pointer;
				}else{
					let c=1, d=v.slice(1), p=v[0].pointer;
					for(let i=0;i<d.length;i++)c*=d[i];
					mems[n]=v={ maxFieldSize:v[0].maxFieldSize||v[0].size, size:v[0].size*c,
						read:function(a){var pt=new p(a);pt.dimensions=d;pt.count=c;return(pt);},
						write:function(a,v){var pt=new p(a);pt.dimensions=d;pt.count=c;pt.update(v);},
					};
				}
			}
			let r=v.read,w=v.write;
			mtds.__defineGetter__(n,function() r(this.valueOf()));
			mtds.__defineSetter__(n,function(v) w(this.valueOf(),v));
			size=Math.max(size,v.size);
			maxFieldSize=Math.max(maxFieldSize,v.maxFieldSize||v.size);
		}
		
		size=let(l=Math.min(this.align,maxFieldSize))(size+l-((size%l)||l));
		this.addClassMembers({
			size:size,		maxFieldSize:maxFieldSize,		members:mems,
			write:function(a,v){
				if(v instanceof Pointer){
					MemMove(a,v.valueOf(),size);
				}else{
					var p=new ptr(a);
					for each(let [n,t] in Iterator(mems)){
						if(v instanceof t){
							p[n]=v;
							break;
						}
					}
				}
			},
			
		});
		
		this.pointer.addPrototypeMembers(mtds);
	};
	
	
	
	
	
	
	
	var BitFlags=new Class(Class,{
		__new__:function(fields){
			var mems={__class__:fields};
			for each(let [n,v] in Iterator(fields)){
				let value=v;
				if(v.toString(2).match(/^0*10*$/)){
					mems.__defineGetter__(n,function()!!(this.valueOf()&value));
				}else{
					let offset=v.toString(2).match(/0*$/)[0].length;
					mems.__defineGetter__(n,function()(this.valueOf()&value)>>offset);
				}
			}
			var klass=new Class(UInt,mems);
			klass.addClassMembers({
				read:function(a)(new klass(UInt.read(a))),
			});
			return(klass);
		},
	});
	
	
	var Enum=new Class(Class,{
		__new__:function(pairs){
			var klass=new Class(Int,{
				__class__:{
					addValues:function(obj){
						this.nameValue=this.nameValue||{};
						this.valueName=this.valueName||{};
						for each(let [n,v] in Iterator(obj)){
							if(!(n in this.nameValue)){
								this.nameValue[n]=v;
							}
							if(!(v in this.valueName)){
								this.valueName[v]=n;
							}
							if(!(n in this)){
								this[n]=v;
							}
							if(!(v in this)){
								this[v]=n;
							}
						}
					},
					setValue:function(name,value){
						var o={};
						o[name]=value;
						this.addValues(o);
					},
					getName:function(v)(this.valueName[(typeof(v)=='string')?this.nameValue[v]:v]),
					getValue:function(v)((typeof(v)=='string')?this.nameValue[v]:v),
					from:function(obj)(new klass(obj)),
					read:function(a)(new klass(Int.read(a))),
					write:function(a,v)(Int.write(a,(typeof(v)=='number')?v:(klass.nameValue[v]||0))),
				},
				__new__:function(v){
					var n;
					[n,v]=(typeof(v)=='number')?[klass.valueName[v],v]:[v,klass.nameValue[v]||0];
					this.valueOf=function()v;
					this.toString=function()n;
				},
				free:Function.doNothing,
			});
			if(pairs){
				klass.addValues(pairs);
			}
			return(klass);
		},
	});
	
	
	
	
	
	var UInt64=new Struct({
		low:UInt,
		high:UInt,
	},{
		__class__:{
			from:function(v){
				var res=this.entity.alloc();
				__NG__SetUInt64(res.valueOf(),v);
				return(res);
			},
		},
		get numberizable()((this.high>>20)==0),
		toObject:function()__NG__GetUInt64(this.valueOf()),
		toNumber:function()this.toObject(),
	}).addClassMembers({
		write:function(a,v){
			if(typeof(v)=='number'){
				__NG__SetUInt64(a,v);
			}else{
				__NG__SetUInt(a,v.low||0);
				__NG__SetUInt(a+4,v.high||0);
			}
		},
	});
	
	var Int64=new Struct({
		low:UInt,
		high:UInt,
	},{
		__class__:{
			from:function(val){
				var res=this.entity.alloc();
				__NG__SetInt64(res.valueOf(),v);
				return(res);
			},
		},
		get numberizable()(((this.high<<20)>>20)==this.high),
		toObject:function()__NG__GetInt64(this.valueOf()),
		toNumber:function()this.toObject(),
	}).addClassMembers({
		write:function(a,v){
			if(typeof(v)=='number'){
				__NG__SetInt64(a,v);
			}else{
				__NG__SetUInt(a,v.low||0);
				__NG__SetUInt(a+4,v.high||0);
			}
		},
	});
	
	
	
	
	
	
	
	
	var Library=new Class(UInt,{
		__class__:{
			load:function(name){
				var h=__NG__LoadLibrary(name);
				if(!h){
					if(arguments.length>1){
						return(this.load.apply(this,Array.slice(arguments,1)));
					}else{
						throw(new Error('failed to load library "'+name+'"'));
					}
				}
				var res=new this(h);
				for(let [n,v] in Iterator(this)){
					if(v instanceof NativeFunction){
						var a=__NG__GetProcAddress(h,n);
						if(a){
							res[n]=(new v(a)).wrap();
						}
					}
				}
				res.name=name;
				return(res);
			},
		},
		free:function(){
			if(this.valueOf()){
				__NG__FreeLibrary(this.valueOf());
				this.valueOf=function()0;
			}
		},
		getCFunction:function(name)((this.__functions__||(this.__functions__={}))[name]||(this.__functions__[name]=Object.extend(new NativeFunction(__NG__GetProcAddress(this.valueOf(),name)),{module:this.name||'',name:name}))),
		getStdCallFunction:function(name)((this.__functions__||(this.__functions__={}))[name]||(this.__functions__[name]=Object.extend(new StdCallFunction(__NG__GetProcAddress(this.valueOf(),name)),{module:this.name||'',name:name}))),
		proc:function(n,a,r,e){
			var p=this.getCFunction(n);
			if(p.valueOf()==0){
				throw('Library error: function not found. ('+n+')');
			}
			p.__name__=n;
			return(p.toFunction(a,r,null,e));
		},
	});
	
	
	var WinLibrary=new Class(Library,{
		proc:function(n,a,r,e){
			var p=this.getStdCallFunction(n);
			if(p.valueOf()==0){
				throw('Library error: function not found. ('+n+')');
			}
			p.__name__=n;
			return(p.toFunction(a,r,null,e));
		},
	});
	var crt=new Library(__NG__LoadLibrary("mozcrt19.dll"));
	var kernel32=new WinLibrary(__NG__GetModuleHandle('kernel32.dll'));
	var ntdll=new WinLibrary(__NG__GetModuleHandle('ntdll.dll'));
	var user32=new WinLibrary(__NG__GetModuleHandle('user32.dll'));
	var jsapi=new WinLibrary(__NG__GetModuleHandle('js3250.dll'));
	var stdcall={};
	var NativeFunction=new Class(Pointer,{
		__class__:{
			isolate:false,
			stdcall:false,
			argtypes:[],
			restype:Int,
			vargtype:null,
			useLastError:false,
			define:function(at,rt,va,le)(new Class(this,{__class__:{argtypes:at||this.argtypes,restype:rt||this.restype,vargtype:(typeof(va)=='undefined')?this.vargtype:va,useLastError:(typeof(le)=='undefined')?this.useLastError:le,}})),
			from:function(obj){
				if(typeof(obj)=='function'){
					var at=this.argtypes.slice(0),rt=this.restype,va=this.vargtype, s='function(){',ac=[],wrap=false;
					for(var i=0,l=at.length;i<l;i++){
						if(at[i] instanceof Array){
							at[i]=at[i][0].symbol?at[i][0]:at[i][0].pointer;
							s+='let(t=new at['+i+'](arguments['+i+'])){arguments['+i+']=t.to'+(at[i].prototype.toObject?'Object':'String')+'();t.free();}';
							wrap=true;
						}else if((at[i]=at[i].symbol?at[i]:at[i].pointer).from){
							s+='arguments['+i+']=new at['+i+'](arguments['+i+']);';
							wrap=true;
						}
						ac.push(at[i].symbol);
					}
					if(!this.stdcall && va){
						if(va instanceof Array){
							va=va[0].symbol?va[0]:va[0].pointer;
							s+='Array.push(arguments,let(va=arguments['+i+'],c={})(function(n){if(!(n in c)){'
								+'var t=at['+i+'].read(va+(n||0)*4);c[n]=t.to'+(va.prototype.toObject?'Object':'String')+'();t.free();}return(c[n]);}));';
						}else{
							va=va.symbol?va:va.pointer;
							s+='Array.push(arguments,let(va=arguments['+i+'])(function(n)at['+i+'].read(va+(n||0)*4)));';
						}
						at.push(va);
						ac.push('*');
						wrap=true;
					}
					if(rt instanceof Array)rt=rt[0];
					if(!rt.symbol)rt=rt.pointer;
					if(rt.from){
						s+='return(let(r=f.apply(null,arguments))((r instanceof rt)?r:rt.from(r)));}';
						wrap=true;
					}else{
						s+='return(f.apply(null,arguments));}';
					}
					if(wrap){
						obj=this.__wrapExported__(s,obj,at,rt);
					}
					var r=new this(__NG__ExportFunction(obj,ac.join(''),rt.symbol,(this.stdcall?0:1)|(this.isolate?0x10000:0)));
					r.original=obj;
					return(r);
				}
			},
			__wrapExported__:function(s,f,at,rt)(eval(s)),
		},
		wrap:function(at,rt,va,ue)(this.toFunction(at,rt,va,ue)),
		toFunction:function(at,rt,va,la){
			if(!this.valueOf()){
				throw('function pointer is null');
			}
			at=(at||this.constructor.argtypes).slice(0);
			rt=rt||this.constructor.restype;
			va=(typeof(va)=='undefined')?this.constructor.vargtype:va;
			la=(typeof(la)=='undefined')?this.constructor.useLastError:la;
			var s='', ac=[], free=false, wrap=false, stdcall=(typeof(va)=='undefined')?this.constructor.stdcall:(va===stdcall);
			for(var i=0,l=at.length;i<l;i++){
				if(at[i] instanceof Array){
					at[i]=at[i][0].from?at[i][0]:at[i][0].pointer;
					s+='if(!(arguments['+i+'] instanceof at['+i+']))arguments['+i+']=at['+i+'].from(arguments['+i+']);';
					wrap=true;
				}else if((at[i]=at[i].symbol?at[i]:at[i].pointer).from){
					s+='if(!(arguments['+i+'] instanceof at['+i+']))f.push(arguments['+i+']=at['+i+'].from(arguments['+i+']));';
					free=wrap=true;
				}
				ac.push(at[i].symbol);
			}
			if(!this.constructor.stdcall && va){
				if(va instanceof Array){
					va=va[0].symbol?va[0]:va[0].pointer;
					s+='for(var i='+i+',l=arguments.length;i<l;i++)if(!(arguments[i] instanceof at['+i+']))arguments[i]=at['+i+'].from(arguments[i]);';
					wrap=true;
				}else if((va=va.symbol?va:va.pointer).from){
					s+='for(var i='+i+',l=arguments.length;i<l;i++)if(!(arguments[i] instanceof at['+i+']))f.push(arguments[i]=at['+i+'].from(arguments[i]));';
					free=wrap=true;
				}
				at.push(va);
			}
			if(rt instanceof Array){
				rt=rt[0].symbol?rt[0]:rt[0].pointer;
				s+='var ro=new rt(w.apply(this,arguments));var r=ro.to'+(rt.prototype.toObject?'Object':'String')+'();ro.free();';
				wrap=true;
			}else if((rt=rt.symbol?rt:rt.pointer).superClass){
				s+='var r=new rt(w.apply(this,arguments));';
				wrap=true;
			}else{
				s+='var r=w.apply(this,arguments);';
			}
			var imp=__NG__ImportFunction(this.valueOf(),ac.join(''),rt.symbol,(stdcall?0x00:0x01)|((la||(la===0))?0x02:0x00));
			if(la||(la===0)){
				if(typeof(la)=='number'){
					return(wrap
						?this.__wrapImported__('(function(){try{'+(free?'try{var f=[];'+s+'}finally{for(var i=f.length;i--;)f[i].free();}':s)+'return(r);}catch(e if(e&&(e.result!=='+la+'))){return(e.result);}catch(e){throw(Object.extend(new Error('+(this.__name__||"anonymousNativeFunction").quote()+'+" "+e),{code:e.code,result:e.result}));}})',imp,at,rt)
						:this.__wrapImported__('(function(){try{'+s+'return(r);}catch(e if(e&&(e.result!=='+la+'))){return(e.result);}catch(e){throw(Object.extend(new Error('+(this.__name__||"anonymousNativeFunction").quote()+'+" "+e),{code:e.code,result:e.result}));}})',imp,at,rt));
				}else if(typeof(la)=='object'){
					if('unless' in la){
						return(wrap
							?this.__wrapImported__('(function(){try{'+(free?'try{var f=[];'+s+'}finally{for(var i=f.length;i--;)f[i].free();}':s)+'return(r);}catch(e if(e&&(e.result=='+la.unless+'))){return(e.result);}catch(e){throw(Object.extend(new Error('+(this.__name__||"anonymousNativeFunction").quote()+'+" "+e),{code:e.code,result:e.result}));}})',imp,at,rt)
							:this.__wrapImported__('(function(){try{'+s+'return(r);}catch(e if(e&&(e.result=='+la.unless+'))){return(e.result);}catch(e){throw(Object.extend(new Error('+(this.__name__||"anonymousNativeFunction").quote()+'+" "+e),{code:e.code,result:e.result}));}})',imp,at,rt));
					}else if('gt' in la){
						return(wrap
							?this.__wrapImported__('(function(){try{'+(free?'try{var f=[];'+s+'}finally{for(var i=f.length;i--;)f[i].free();}':s)+'return(r);}catch(e if(e&&(e.result<'+la.gt+'))){return(e.result);}catch(e){throw(Object.extend(new Error('+(this.__name__||"anonymousNativeFunction").quote()+'+" "+e),{code:e.code,result:e.result}));}})',imp,at,rt)
							:this.__wrapImported__('(function(){try{'+s+'return(r);}catch(e if(e&&(e.result<'+la.gt+'))){return(e.result);}catch(e){throw(Object.extend(new Error('+(this.__name__||"anonymousNativeFunction").quote()+'+" "+e),{code:e.code,result:e.result}));}})',imp,at,rt));
					}else if('lt' in la){
						return(wrap
							?this.__wrapImported__('(function(){try{'+(free?'try{var f=[];'+s+'}finally{for(var i=f.length;i--;)f[i].free();}':s)+'return(r);}catch(e if(e&&(e.result>'+la.lt+'))){return(e.result);}catch(e){throw(Object.extend(new Error('+(this.__name__||"anonymousNativeFunction").quote()+'+" "+e),{code:e.code,result:e.result}));}})',imp,at,rt)
							:this.__wrapImported__('(function(){try{'+s+'return(r);}catch(e if(e&&(e.result>'+la.lt+'))){return(e.result);}catch(e){throw(Object.extend(new Error('+(this.__name__||"anonymousNativeFunction").quote()+'+" "+e),{code:e.code,result:e.result}));}})',imp,at,rt));
					}else{
						return(wrap
							?this.__wrapImported__('(function(){try{'+(free?'try{var f=[];'+s+'}finally{for(var i=f.length;i--;)f[i].free();}':s)+'return(r);}catch(e){throw(Object.extend(new Error('+(this.__name__||"anonymousNativeFunction").quote()+'+" "+e),{code:e.code,result:e.result}));}})',imp,at,rt)
							:this.__wrapImported__('(function(){try{'+s+'return(r);}catch(e){throw(Object.extend(new Error('+(this.__name__||"anonymousNativeFunction").quote()+'+" "+e),{code:e.code,result:e.result}));}})',imp,at,rt));
					}
				}else{
					return(wrap
						?this.__wrapImported__('(function(){try{'+(free?'try{var f=[];'+s+'}finally{for(var i=f.length;i--;)f[i].free();}':s)+'return(r);}catch(e){throw(Object.extend(new Error('+(this.__name__||"anonymousNativeFunction").quote()+'+" "+e),{code:e.code,result:e.result}));}})',imp,at,rt)
						:this.__wrapImported__('(function(){try{'+s+'return(r);}catch(e){throw(Object.extend(new Error('+(this.__name__||"anonymousNativeFunction").quote()+'+" "+e),{code:e.code,result:e.result}));}})',imp,at,rt));
				}
			}else{
				return(wrap?this.__wrapImported__('(function(){'+(free?'try{var f=[];'+s+'}finally{for(var i=f.length;i--;)f[i].free();}':s)+'return(r);})',imp,at,rt):imp);
			}
		},
		__wrapImported__:function(s,w,at,rt)(eval(s)),
	});
	var CFunction=NativeFunction;
	var StdCallFunction=new Class(NativeFunction,{__class__:{stdcall:true}});
	var ThreadSafeCallback=new Class(NativeFunction,{__class__:{isolate:true}});
	var ThreadSafeStdCallback=new Class(StdCallFunction,{__class__:{isolate:true}});
}















let(__hexToByteMapping__={"00":0,"01":1,"02":2,"03":3,"04":4,"05":5,"06":6,"07":7,"08":8,"09":9,"0a":10,"0A":10,"0b":11,"0B":11,"0c":12,"0C":12,"0d":13,"0D":13,"0e":14,"0E":14,"0f":15,"0F":15,"10":16,"11":17,"12":18,"13":19,"14":20,"15":21,"16":22,"17":23,"18":24,"19":25,"1a":26,"1A":26,"1b":27,"1B":27,"1c":28,"1C":28,"1d":29,"1D":29,"1e":30,"1E":30,"1f":31,"1F":31,"20":32,"21":33,"22":34,"23":35,"24":36,"25":37,"26":38,"27":39,"28":40,"29":41,"2a":42,"2A":42,"2b":43,"2B":43,"2c":44,"2C":44,"2d":45,"2D":45,"2e":46,"2E":46,"2f":47,"2F":47,"30":48,"31":49,"32":50,"33":51,"34":52,"35":53,"36":54,"37":55,"38":56,"39":57,"3a":58,"3A":58,"3b":59,"3B":59,"3c":60,"3C":60,"3d":61,"3D":61,"3e":62,"3E":62,"3f":63,"3F":63,"40":64,"41":65,"42":66,"43":67,"44":68,"45":69,"46":70,"47":71,"48":72,"49":73,"4a":74,"4A":74,"4b":75,"4B":75,"4c":76,"4C":76,"4d":77,"4D":77,"4e":78,"4E":78,"4f":79,"4F":79,"50":80,"51":81,"52":82,"53":83,"54":84,"55":85,"56":86,"57":87,"58":88,"59":89,"5a":90,"5A":90,"5b":91,"5B":91,"5c":92,"5C":92,"5d":93,"5D":93,"5e":94,"5E":94,"5f":95,"5F":95,"60":96,"61":97,"62":98,"63":99,"64":100,"65":101,"66":102,"67":103,"68":104,"69":105,"6a":106,"6A":106,"6b":107,"6B":107,"6c":108,"6C":108,"6d":109,"6D":109,"6e":110,"6E":110,"6f":111,"6F":111,"70":112,"71":113,"72":114,"73":115,"74":116,"75":117,"76":118,"77":119,"78":120,"79":121,"7a":122,"7A":122,"7b":123,"7B":123,"7c":124,"7C":124,"7d":125,"7D":125,"7e":126,"7E":126,"7f":127,"7F":127,"80":128,"81":129,"82":130,"83":131,"84":132,"85":133,"86":134,"87":135,"88":136,"89":137,"8a":138,"8A":138,"8b":139,"8B":139,"8c":140,"8C":140,"8d":141,"8D":141,"8e":142,"8E":142,"8f":143,"8F":143,"90":144,"91":145,"92":146,"93":147,"94":148,"95":149,"96":150,"97":151,"98":152,"99":153,"9a":154,"9A":154,"9b":155,"9B":155,"9c":156,"9C":156,"9d":157,"9D":157,"9e":158,"9E":158,"9f":159,"9F":159,"a0":160,"A0":160,"a1":161,"A1":161,"a2":162,"A2":162,"a3":163,"A3":163,"a4":164,"A4":164,"a5":165,"A5":165,"a6":166,"A6":166,"a7":167,"A7":167,"a8":168,"A8":168,"a9":169,"A9":169,"aa":170,"aA":170,"Aa":170,"AA":170,"ab":171,"aB":171,"Ab":171,"AB":171,"ac":172,"aC":172,"Ac":172,"AC":172,"ad":173,"aD":173,"Ad":173,"AD":173,"ae":174,"aE":174,"Ae":174,"AE":174,"af":175,"aF":175,"Af":175,"AF":175,"b0":176,"B0":176,"b1":177,"B1":177,"b2":178,"B2":178,"b3":179,"B3":179,"b4":180,"B4":180,"b5":181,"B5":181,"b6":182,"B6":182,"b7":183,"B7":183,"b8":184,"B8":184,"b9":185,"B9":185,"ba":186,"bA":186,"Ba":186,"BA":186,"bb":187,"bB":187,"Bb":187,"BB":187,"bc":188,"bC":188,"Bc":188,"BC":188,"bd":189,"bD":189,"Bd":189,"BD":189,"be":190,"bE":190,"Be":190,"BE":190,"bf":191,"bF":191,"Bf":191,"BF":191,"c0":192,"C0":192,"c1":193,"C1":193,"c2":194,"C2":194,"c3":195,"C3":195,"c4":196,"C4":196,"c5":197,"C5":197,"c6":198,"C6":198,"c7":199,"C7":199,"c8":200,"C8":200,"c9":201,"C9":201,"ca":202,"cA":202,"Ca":202,"CA":202,"cb":203,"cB":203,"Cb":203,"CB":203,"cc":204,"cC":204,"Cc":204,"CC":204,"cd":205,"cD":205,"Cd":205,"CD":205,"ce":206,"cE":206,"Ce":206,"CE":206,"cf":207,"cF":207,"Cf":207,"CF":207,"d0":208,"D0":208,"d1":209,"D1":209,"d2":210,"D2":210,"d3":211,"D3":211,"d4":212,"D4":212,"d5":213,"D5":213,"d6":214,"D6":214,"d7":215,"D7":215,"d8":216,"D8":216,"d9":217,"D9":217,"da":218,"dA":218,"Da":218,"DA":218,"db":219,"dB":219,"Db":219,"DB":219,"dc":220,"dC":220,"Dc":220,"DC":220,"dd":221,"dD":221,"Dd":221,"DD":221,"de":222,"dE":222,"De":222,"DE":222,"df":223,"dF":223,"Df":223,"DF":223,"e0":224,"E0":224,"e1":225,"E1":225,"e2":226,"E2":226,"e3":227,"E3":227,"e4":228,"E4":228,"e5":229,"E5":229,"e6":230,"E6":230,"e7":231,"E7":231,"e8":232,"E8":232,"e9":233,"E9":233,"ea":234,"eA":234,"Ea":234,"EA":234,"eb":235,"eB":235,"Eb":235,"EB":235,"ec":236,"eC":236,"Ec":236,"EC":236,"ed":237,"eD":237,"Ed":237,"ED":237,"ee":238,"eE":238,"Ee":238,"EE":238,"ef":239,"eF":239,"Ef":239,"EF":239,"f0":240,"F0":240,"f1":241,"F1":241,"f2":242,"F2":242,"f3":243,"F3":243,"f4":244,"F4":244,"f5":245,"F5":245,"f6":246,"F6":246,"f7":247,"F7":247,"f8":248,"F8":248,"f9":249,"F9":249,"fa":250,"fA":250,"Fa":250,"FA":250,"fb":251,"fB":251,"Fb":251,"FB":251,"fc":252,"fC":252,"Fc":252,"FC":252,"fd":253,"fD":253,"Fd":253,"FD":253,"fe":254,"fE":254,"Fe":254,"FE":254,"ff":255,"fF":255,"Ff":255,"FF":255}){
	var HexAlternative=new Class({__class__:{
		encode:function(obj,format){
			if(obj instanceof Pointer){
				var l=obj.size;
				var a=new Array(l);
				var ptr=new (Byte.pointer)(obj.valueOf());
				for(var i=0;i<l;i++){
					a[i]=ptr.item(i).toString(16);
				}
				return(a.join(" "));
			}else{
				throw(new TypeError('object is not a instance of Pointer'));
			}
		},
		decode:function(str,type){
			try{
				if(type){
					var r=Byte.alloc(str.match(/[0-9a-f]{2}/ig).length);
					var ptr=r.inc(0);
					str.replace(/[0-9a-f]{2}/ig,function($0){
						ptr=ptr.update(__hexToByteMapping__[$0]).inc(1);
					});
					if(type instanceof Array){
						type=type[0];
						f=true;
					}
					if(!type.symbol){
						type=type.pointer;
					}
					r=new type(r);
					if(f){
						r=r.convert();
					}
				}
				return(r);
				return(buf);
			}catch(e){
				r&&r.free();
				throw(e);
			}
		},
	}});
}
var crypt32=WinLibrary.load('crypt32.dll');
try{
	let(
		CryptStringToBinary=crypt32.proc('CryptStringToBinaryW',[WideString,UInt,UInt,Pointer,Pointer,Pointer,Pointer],UInt,false),
		CryptBinaryToString=crypt32.proc('CryptBinaryToStringW',[Pointer,UInt,UInt,WideString,Pointer],UInt)
	){
		var StringBinaryCodec=new Class({
			__class__:{
				encode:function(obj,format){
					if(obj instanceof Pointer){
						var s=obj.size;
						try{
							var l=UInt.alloc();
							CryptBinaryToString(obj,s,0x80000000|this.mode,null,l);
							var r=WChar.alloc(l.item());
							CryptBinaryToString(obj,s,0x80000000|this.mode,r,l);
							return(format?r.toString():r.toString().replace(/\s+/g,this.noSpace?"":" ").replace(/^\s|\s$/g,""));
						}finally{
							l&&l.free();
							r&&r.free();
						}
					}else if(typeof(obj)=='string'){
						try{
							var buf=MBString.from(obj,(typeof(format)=='string')?format:void(0));
							return(this.encode(buf,(typeof(format)=='string')?void(0):format));
						}finally{
							buf&&buf.free();
						}
					}else{
						throw(new TypeError('object is not a instance of Pointer'));
					}
				},
				decode:function(str,type){
					if(this.mode==0x04){
						str=str.match(/[0-9a-fA-F]{2}/g).join(' ');
					}
					var c=str.length;
					try{
						var l=UInt.alloc();
						CryptStringToBinary(str,c,this.mode,null,l,null,null);
						var r=Byte.alloc(l.item());
						CryptStringToBinary(str,c,this.mode,r,l,null,null);
						var f=false;
						if(type){
							if(type instanceof Array){
								type=type[0];
								f=true;
							}
							if(!type.symbol){
								type=type.pointer;
							}
							r=new type(r);
							if(f){
								r=r.convert();
							}
						}
						return(r);
					}catch(e){
						r&&r.free();
						throw(e);
					}finally{
						l&&l.free();
					}
				},
			},
		});
		var Hex=new Class(StringBinaryCodec,{__class__:{mode:0x04}});
		var Base64=new Class(StringBinaryCodec,{__class__:{mode:0x01,noSpace:true,}});
	}
}catch(e){
	var Hex=HexAlternative;
}

let(
	memIndexOf=(new CFunction(
		Hex.decode('55 8B EC 83 EC 0C 8B 45 08 89 45 FC 8B 4D 08 03 4D 0C 2B 4D 14 89 4D F4 8B 55 08 3B 55 F4 77 4F C7 45 F8 00 00 00 00 EB 09 8B 45 F8 83 C0 01 89 45 F8 8B 4D F8 3B 4D 14 7D 1A 8B 55 08 03 55 F8 0F BE 02 8B 4D 10 03 4D F8 0F BE 11 3B C2 74 02 EB 02 EB D5 8B 45 F8 3B 45 14 7C 08 8B 45 08 2B 45 FC EB 0E 8B 4D 08 83 C1 01 89 4D 08 EB A9 83 C8 FF 8B E5 5D C3')
	)).toFunction([Pointer,Int,Pointer,Int],Int)
){
	Pointer.addMembers({
		indexOf:function(obj){
			if(obj instanceof Pointer){
				return(memIndexOf(this,this.size||1,obj,obj.size||1));
			}else{
				throw(new Error("parameter is not a Pointer"));
			}
		}
	});
}

var advapi32=WinLibrary.load('advapi32.dll');

Date.SystemTime=(new Struct({
	year:UShort,
	month:UShort,
	day:UShort,
	date:UShort,
	hours:UShort,
	minutes:UShort,
	seconds:UShort,
	milliseconds:UShort,
},{
	__class__:{
		from:function(val){
			val=Date.from(val);
			var p=this.entity.alloc();
			p.year=val.getUTCFullYear();
			p.month=val.getUTCMonth()+1;
			p.date=val.getUTCDate();
			p.hours=val.getUTCHours();
			p.minutes=val.getUTCMinutes();
			p.seconds=val.getUTCSeconds();
			p.milliseconds=val.getUTCMilliseconds();
			return(p);
		},
	},
	toObject:function(){
		var res=new Date();
		res.setUTCFullYear(this.year);
		res.setUTCMonth(this.month-1);
		res.setUTCDate(this.date);
		res.setUTCHours(this.hours);
		res.setUTCMinutes(this.minutes);
		res.setUTCSeconds(this.seconds);
		res.setUTCMilliseconds(this.milliseconds);
		return(res);
	},
	toDate:function()this.toObject(),
}));

Date.FileTime=(new Struct(UInt64,{
	toSystemTime:function(){
		var st=Date.SystemTime.alloc();
		if(Date.FileTimeToSystemTime(this,st)!=0){
			return(st);
		}else{
			st.free();
		}
	},
	toObject:function(){
		try{
			var st=this.toSystemTime();
			return(st&&st.toObject());
		}finally{
			st.free();
		}
	},
	toDate:function()this.toObject(),
	toString:function()this.toObject().toString(),
})).addMembers({
	__class__:{
		from:function(val){
			val=Date.from(val);
			try{
				var st=Date.SystemTime.pointer.from(val);
				var res=Date.FileTime.alloc();
				Date.SystemTimeToFileTime(st,res);
				return(res);
			}finally{
				st && st.free();
			}
		},
	},
});

Date.FileTimeToSystemTime=kernel32.proc('FileTimeToSystemTime',[Date.FileTime,Date.SystemTime],Int);
Date.SystemTimeToFileTime=kernel32.proc('SystemTimeToFileTime',[Date.SystemTime,Date.FileTime],Int);




var mlang=WinLibrary.load('mlang.dll');
var shlwapi=WinLibrary.load('shlwapi.dll');
var MBString=UChar.pointer;
let(
	GetACP=kernel32.proc('GetACP',[],UInt),
	ConvertINetMultiByteToUnicode=mlang.proc('ConvertINetMultiByteToUnicode',[Pointer,UInt,UInt,Pointer,WideString,Pointer],UInt,true),
	ConvertINetUnicodeToMultiByte=mlang.proc('ConvertINetUnicodeToMultiByte',[Pointer,UInt,WideString,Pointer,Pointer,Pointer],UInt),
	MultiByteToWideChar=kernel32.proc('MultiByteToWideChar',[UInt,UInt,UInt,Int,WideString,Int],Int,true),
	
	strstr=crt.proc('strstr',[UInt,UInt],UInt),
	wcsstr=crt.proc('wcsstr',[UInt,UInt],UInt),
	
	strlen=crt.proc('strlen',[UInt],Int),
	wcslen=crt.proc('wcslen',[UInt],Int),
	strpbrk=crt.proc('strpbrk',[UInt,UInt],UInt),
	wcspbrk=crt.proc('wcspbrk',[UInt,WideString],UInt),
	
	qcslen=(new CFunction(Hex.decode(
		"55 8b ec 51 8b 45 08 89 45 fc 8b 4d fc 83 39 00 74 0b 8b 55 fc 83 c2 04 89 55 fc eb ed 8b 45 fc 2b 45 08 c1 f8 02 8b e5 5d c3"
	))).toFunction([UInt],Int),
	StringSearchSafeLength=(new CFunction(Hex.decode(
		"55 8b ec 83 ec 08 8b 45 08 89 45 fc 8b 4d 08 89 4d f8 8b 55 fc 0f be 02 85 c0 74 1b 8b 4d fc 0f be 11 8b 45 fc 83 c0 01 89 45 fc 85 d2 7e 06 8b 4d fc 89 4d f8 eb db 8b 45 f8 2b 45 08 8b e5 5d c3"
	))).toFunction([UInt],Int)
/*,
*/
){
	let __hexCharCodeToValueMapping__={48:0,49:1,50:2,51:3,52:4,53:5,54:6,55:7,56:8,57:9,97:10,65:10,98:11,66:11,99:12,67:12,100:13,68:13,101:14,69:14,102:15,70:15};
	let __noURIEncodeChars__={33:1,35:1,36:1,38:1,39:1,40:1,41:1,42:1,43:1,44:1,45:1,46:1,47:1,48:1,49:1,50:1,51:1,52:1,53:1,54:1,55:1,56:1,57:1,58:1,59:1,61:1,63:1,64:1,65:1,66:1,67:1,68:1,69:1,70:1,71:1,72:1,73:1,74:1,75:1,76:1,77:1,78:1,79:1,80:1,81:1,82:1,83:1,84:1,85:1,86:1,87:1,88:1,89:1,90:1,95:1,97:1,98:1,99:1,100:1,101:1,102:1,103:1,104:1,105:1,106:1,107:1,108:1,109:1,110:1,111:1,112:1,113:1,114:1,115:1,116:1,117:1,118:1,119:1,120:1,121:1,122:1,126:1};
	let __noURIEncodeComponentChars__={33:1,39:1,40:1,41:1,42:1,45:1,46:1,48:1,49:1,50:1,51:1,52:1,53:1,54:1,55:1,56:1,57:1,65:1,66:1,67:1,68:1,69:1,70:1,71:1,72:1,73:1,74:1,75:1,76:1,77:1,78:1,79:1,80:1,81:1,82:1,83:1,84:1,85:1,86:1,87:1,88:1,89:1,90:1,95:1,97:1,98:1,99:1,100:1,101:1,102:1,103:1,104:1,105:1,106:1,107:1,108:1,109:1,110:1,111:1,112:1,113:1,114:1,115:1,116:1,117:1,118:1,119:1,120:1,121:1,122:1,126:1};
	let __noURIDecodeChars__={35:1,36:1,38:1,43:1,44:1,47:1,58:1,59:1,61:1,63:1,64:1};
	
	MBString.addMembers({
		__class__:{
			codepages:new Enum({
				utf8:65001,
				'utf-8':65001,
				'UTF-8':65001,
				sjis:932,
				euc:51932,
				jis:50220,
				ascii:1252,
				unicode:1200,
				unicodeBE:1201,
				utf32:12000,
				utf32BE:12001,
			}),
			
			getCodepageOfEncoding:function(name){
				var v=this.codepages.getValue(name);
				if(v){
					return(v);
				}else{
					var k=new (require("Registry").Registry)("HKCR\\Mime\\Database\\Charset").key(name);
					if(k.exists){
						var a=k.value('AliasForCharset'), e=k.value('InternetEncoding').valueOf();
						if(a.exists){
							e=this.getCodepageOfEncoding(a.valueOf());
						}
						this.codepages.setValue(name,e);
						return(e);
					}else{
						return(65001);
					}
				}
			},
			getEncodingOfCodepage:function(cp)(this.codepages.getName(cp)),
			
			encodingOrder:['utf8','sjis'/*,'euc','jis','ascii'*/],
			defaultCodepage:GetACP(),
			
			encodeURI:function(str,enc){
				if(!enc || (enc=='utf8') || ((enc!='utf-7') && !String(str).match(/[^\x09\x0a\x0d\x20-\x7F]/i))){
					return(encodeURI(str));
				}else{
					try{
						var s=this.from(str,enc);
						return(s.encodeURI());
					}finally{
						s&&s.free();
					}
				}
			},
			encodeURIComponent:function(str,enc){
				if(!enc || (enc=='utf8') || ((enc!='utf-7') && !String(str).match(/[^\x09\x0a\x0d\x20-\x7F]/i))){
					return(encodeURIComponent(str));
				}else{
					try{
						var s=this.from(str,enc);
						return(s.encodeURIComponent());
					}finally{
						s&&s.free();
					}
				}
			},
			decodeURI:function(str,enc){
				if(!enc|| (enc=='utf8') || ((enc!='utf-7') && !String(str).match(/%[0189A-F][0-9A-F]|[^\x09\x0a\x0d\x20-\x7F]/i))){
					return(decodeURI(str));
				}else{
					try{
						var s=this.from(str,enc);
						return(s.decodeURI());
					}finally{
						s&&s.free();
					}
				}
			},
			decodeURIComponent:function(str,enc){
				if(!enc|| (enc=='utf8') || ((enc!='utf-7') && !String(str).match(/%[0189A-F][0-9A-F]|[^\x09\x0a\x0d\x20-\x7F]/i))){
					return(decodeURIComponent(str));
				}else{
					try{
						var s=this.from(str,enc);
						return(s.decodeURIComponent());
					}finally{
						s&&s.free();
					}
				}
			},
			calcSize:function(str,enc)(((!enc||(enc=='utf8'))?encodeURI(str).replace(/%[0-9A-F][0-9A-F]/ig,'_'):String(str).replace(/[^\x00-\xFF]/g,'__')).length),
			
			
			from:function(obj,enc){
				if(obj==null){
					return(new this(0));
				}else if(obj instanceof MBString){
					var r=new this(obj.valueOf());
					r.count=obj.count;
					r.zeroTerminated=obj.zeroTerminated;
					r.codepage=obj.codepage;
					return(r);
				}else{
					try{
						var m=UInt.alloc().update(0);
						var e=enc?this.getCodepageOfEncoding(enc):this.defaultCodepage;
						var c=UInt.alloc().update(0);
						var l=UInt.alloc().update(obj.length);
						ConvertINetUnicodeToMultiByte(m,e,obj.replace(/\0/g,' '),l,null,c);
						var r=UChar.alloc(c.item()+4);
						ConvertINetUnicodeToMultiByte(m,e,obj,l,r,c);
						r.count=c.item();
						r.codepage=e;
						r.zeroTerminated=true;
						return(r);
					}catch(e){
						r&&r.free();
						throw(e);
					}finally{
						m&&m.free();
						c&&c.free();
					}
				}
			},
		},
		encodeURI:function(){
			var a=new Array(this.length);
			for(var i=0,l=this.length;i<l;i++){
				var c=this.item(i);
				if(__noURIEncodeChars__[c]){
					a[i]=String.fromCharCode(c);
				}else{
					a[i]='%'+c.toString(16);
				}
			}
			return(a.join(""));
		},
		encodeURIComponent:function(){
			var a=new Array(this.length);
			for(var i=0,l=this.length;i<l;i++){
				var c=this.item(i);
				if(c==0x20){
					a[i]='+';
				}else if(__noURIEncodeComponentChars__[c]){
					a[i]=String.fromCharCode(c);
				}else{
					a[i]='%'+c.toString(16);
				}
			}
			return(a.join(""));
		},
		
		decodeURIComponent:function(){
			try{
				var buf=Byte.alloc(this.length+1);
				var s=-2;
				var ptr=buf.inc(0);
				for(var i=0,l=this.length;i<l;i++){
					var c=this.item(i);
					switch(s){
						case(-2):{
							if(c==0x25){
								s=-1;
							}else{
								ptr=ptr.update((c==0x2B)?0x20:c).inc(1);
							}
							break;
						}case(-1):{
							if(c in __hexCharCodeToValueMapping__){
								s=c;
							}else{
								ptr=ptr.update(0x25).inc(1).update(c).inc(1);
								s=-2;
							}
							break;
						}default:{
							if(c==0x2B){
								
							}else if(c in __hexCharCodeToValueMapping__){
								ptr=ptr.update((__hexCharCodeToValueMapping__[s]<<4)+__hexCharCodeToValueMapping__[c]).inc(1);
							}else{
								
								ptr=ptr.update(0x25).inc(1).update(s).inc(1).update(c).inc(1);
							}
							s=-2;
							break;
						}
					}
				}
				buf.codepage=this.codepage;
				return(buf.toString());
			}finally{
				buf&&buf.free();
			}
		},
		decodeURI:function(){
			try{
				var buf=Byte.alloc(this.length+1);
				var s=-2;
				var ptr=buf.inc(0);
				for(var i=0,l=this.length;i<l;i++){
					var c=this.item(i),c2;
					switch(s){
						case(-2):{
							if(c==0x25){
								s=-1;
							}else{
								ptr=ptr.update((c==0x2B)?0x20:c).inc(1);
							}
							break;
						}case(-1):{
							if(c in __hexCharCodeToValueMapping__){
								s=c;
							}else{
								ptr=ptr.update(0x25).inc(1).update(c).inc(1);
								s=-2;
							}
							break;
						}default:{
							if((c in __hexCharCodeToValueMapping__) && !__noURIDecodeChars__[c2=(__hexCharCodeToValueMapping__[s]<<4)+__hexCharCodeToValueMapping__[c]]){
								ptr=ptr.update(c2).inc(1);
							}else{
								ptr=ptr.update(0x25).inc(1).update(s).inc(1).update(c).inc(1);
							}
							s=-2;
							break;
						}
					}
				}
				buf.codepage=this.codepage;
				return(buf.toString());
			}finally{
				buf&&buf.free();
			}
		},
		
		
		
		toString:function(resume){
			if(!('count' in this) && !this.zeroTerminated){
				throw("string size is not available");
			}
			try{
				var m=UInt.alloc().update(resume||0);
				var e=this.codepage||this.constructor.defaultCodepage;
				var ptr=this.valueOf()+(this.bomSize||0);
				var s=UInt.alloc().update(this.zeroTerminated?((e==1200||e==1201)?wcslen(ptr)*2:((e==12000||e==12001)?qcslen(ptr)*4:-1)):this.count);
				var c=UInt.alloc().update(-1);
				try{
					ConvertINetMultiByteToUnicode(m,e,ptr,s,null,c);
				}catch(e){
				}
				var r=WChar.alloc(c.item()+1);
				try{
					ConvertINetMultiByteToUnicode(m,e,ptr,s,r,c);
				}catch(e){
				}
				this.validBytes=s.item();
				this.decodeContext=m.item();
				
				return(r.toString());
			}finally{
				m&&m.free();
				s&&s.free();
				r&&r.free();
				c&&c.free();
			}
		},
		get length(){
			if(this.zeroTerminated){
				return(strlen(this.valueOf()));
			}else if(this.count){
				return(this.count);
			}else{
				return(void(0));
			}
		},
		
		get encoding()(this.codepage && this.constructor.getEncodingOfCodepage(this.codepage)),
		set encoding(n)(this.codepage=this.constructor.getCodepageOfEncoding(n)),
		
		detectEncoding:function(){
			var ptr=this.valueOf();
			if(this.count>=8){
				if(UInt.read(ptr+this.count-4)==0){
					var mlen=Math.ceil(strlen(ptr)/4);
					var wlen=Math.ceil(wcslen(ptr)/2);
					var qlen=qcslen(ptr);
					
					if(mlen<qlen){
						if(wlen<mlen){
							var bom=UInt.read(ptr);
							if(bom==0x0000FEFF){
								this.codepage=12000;
								this.bomSize=4;
							}else if(bom==0xFFFE0000){
								this.codepage=12001;
								this.bomSize=4;
							}else if(wlen%4!=0){
								this.codepage=12000;
							}else{
								this.codepage=12001;
							}
						}else{
							var bom=WChar.read(ptr);
							if(bom==0xFEFF){
								this.codepage=1200;
								this.bomSize=2;
							}else if(bom==0xFFFE){
								this.codepage=1201;
								this.bomSize=2;
							}else{
								if(wcspbrk(ptr,"\n\r")!=0){
									this.codepage=1200;
								}else if(mlen%2==0){
									this.codepage=1201;
								}else{
									this.codepage=1200;
								}
							}
						}
						return(this.encoding);
					}
				}
			}else if(!('count' in this) && !this.zeroTerminated){
				throw("string size is not available");
			}
			try{
				var l;
				var count=this.zeroTerminated?strlen(ptr):this.count;
				var mincp;
				var minlen=count+1;
				var m=UInt.alloc().update(0);
				var s=UInt.alloc().update(-1);
				var c=UInt.alloc().update(-1);
				for each(var [i,e] in Iterator(this.constructor.encodingOrder)){
					var cp=this.constructor.codepages.getValue(e);
					try{
						ConvertINetMultiByteToUnicode(m.update(0),cp,ptr,s.update(count),null,c.update(-1));
						l=c.item();
					}catch(er){
						try{
							l=MultiByteToWideChar(cp,8,ptr,s.item(),null,0);
						}catch(err if err.code==0x459){
							continue;
						}catch(err){
							l=c.item();
						}
					}
					if(l<minlen && l>(minlen/3-4)){
						mincp=cp;
						minlen=l;
					}
				}
				
				this.codepage=mincp;
				if(this.codepage==65001 && (UInt.read(ptr)&0xFFFFFF)==0xBFBBEF){
					this.bomSize=3;
				}
			}finally{
				m&&m.free();
				s&&s.free();
				c&&c.free();
			}
			return(this.encoding);
		},
	});
	
	
	var ReadTimeout=new Error("stream error: read timeout");
	var WriteTimeout=new Error("stream error: write timeout");
	
	var StreamMixin=(new Class({
		__class__:{
		},
		buffer:function(size,timeout,errorOnTimeout){
			var pos=this.position, size2=(this.bufferedSize||0)-(this.bufferPosition||0) +size;
			var buf=Byte.alloc(size2+4);
			this.bufferedSize=this.readTo(buf.valueOf(),size2,timeout,errorOnTimeout);
			this.bufferedBytes=buf;
			this.bufferPosition=0;
			this.position=pos||0;
			return(this.bufferedSize);
		},
		
		readTo:function(addr,size,timeout,errorOnTimeout){
			if(size==0){
				return(0);
			}
			var addr2=addr, size2=size;
			try{
				if(this.bufferedBytes){
					var remain=this.bufferedSize - this.bufferPosition;
					var ptr=new PByte(this.bufferedBytes.valueOf()+this.bufferPosition);
					ptr.copy(addr2,Math.min(size2,remain));
					if(remain>size2){
						this.bufferPosition+=size2;
						size2=0;
						return(size);
					}else{
						addr2+=remain;
						size2-=remain;
						this.bufferedBytes.free();
						this.bufferedBytes=null;
					}
				}
				var deadline=(typeof(timeout=(typeof(timeout)=='undefined')?this.timeout:timeout)=='undefined')?0:((new Date()).getTime()+timeout);
				while(size2>0 && !this.__eof__){
					var read=this.__read__(addr2,size2);
					this.__position__=(this.__position__||0)+read;
					addr2+=read;
					size2-=read;
					if(!this.__eof__ && deadline && ((new Date()).getTime()>deadline)){
						if((typeof(errorOnTimeout)=='undefined')?this.errorOnTimeout:errorOnTimeout){
							throw(ReadTimeout);
						}else{
							break;
						}
					}
					if(!this.__eof__ && size2>0){
						sleep(10);
					}
					
				}
				
				return(size-size2);
			}finally{
				this.bytesReceived=(this.bytesReceived||0)+size-size2;
				this.position=(this.position||0)+size-size2;
			}
		},
		discard:function(size){
			var read=0, remain=(typeof(size)=='undefined')?(2<<50):size;
			try{
				var bs=this.readBlockSize||8192;
				var buf=Byte.alloc(bs);
				while(remain && !this.eof){
					var s=this.readTo(buf.valueOf(), Math.min(bs,remain));
					remain-=s;
					read+=s;
				}
			}finally{
				buf&&buf.free();
			}
			return(read);
		},
		redirect:function(dest,size){
			var read=0, remain=(typeof(size)=='undefined')?(2<<50):size;
			try{
				var bs=this.readBlockSize||8192;
				var buf=Byte.alloc(bs);
				while(remain && !this.eof){
					var s=this.readTo(buf.valueOf(), Math.min(bs,remain));
					buf.count=s;
					dest.write(buf);
					remain-=s;
					read+=s;
				}
			}finally{
				buf&&buf.free();
			}
			return(read);
		},
		
		
		read:function(type,count,timeout,errorOnTimeout){
			try{
				var res,cnt,f=type instanceof Array;
				if(typeof(type=f?type[0]:type)=='number'){
					res=this.read(Byte,type,timeout,errorOnTimeout);
				}else if(type && (type.entity||!type.alloc) ){
					res=count?this.read(Byte,count,timeout,errorOnTimeout):this.readAll(timeout,errorOnTimeout);
					cnt=res.count;
					res=new type(res.valueOf());
					res[type.entity?'count':'size']=cnt;
				}else{
					res=(type||Byte).alloc(count=count||1);
					res.count=Math.floor(this.readTo(res.valueOf(),(type.size||1)*count,timeout,errorOnTimeout)/(type.size||1));
				}
				return(f?res.convert():res);
			}catch(e){
				res&&res.free();
				throw(e);
			}
		},
		readBytes:function(count,timeout,errorOnTimeout)(this.read(Byte,count,timeout,errorOnTimeout)),
		readAll:function(timeout,errorOnTimeout){
			if(this.size){
				return(this.read(Byte,this.size-(this.position||0),timeout,errorOnTimeout));
			}else{
				try{
					var sum=0, bufs=[], block=this.readBlockSize||8192;
					while(!this.eof){
						var buf=Byte.alloc(block);
						var read=this.readTo(buf.valueOf(),block,timeout,errorOnTimeout);
						sum+=(buf.count=read);
						bufs.push(buf);
						if(read<block){
							break;
						}
					}
					var res=Byte.alloc(sum);
					for(var i=0,l=bufs.length,addr=res.valueOf();i<l;i++){
						bufs[i].copy(addr,bufs[i].count);
						addr+=bufs[i].count;
					}
					return(res);
				}catch(e){
					res&&res.free();
					throw(e);
				}finally{
					while(bufs.length) bufs.pop().free();
				}
			}
		},
		
		
		readText:function(s,timeout,errorOnTimeout){
			try{
				if(typeof(s)=='string' || s instanceof Array){
					var deadline=(typeof(timeout=(typeof(timeout)=='undefined')?this.timeout:timeout)=='undefined')?0:((new Date()).getTime()+timeout);
					var offset=0, found, enc, finder,finder2,counter,csize,sep,sepLen;
					try{
						while(true){
							if(this.bufferedBytes){
								var b=new PByte(this.bufferedBytes.valueOf()+this.bufferPosition);
								b.zeroTerminated=true;
								if(!enc){
									enc=this.encoding||this.detectedEncoding||(this.detectedEncoding=b.detectEncoding());
									[finder,finder2,counter,csize,sep]={unicode:[wcsstr,wcspbrk,wcslen,2,WideString.from(String(s))],
																}[enc]||[strstr,strpbrk,strlen,1,MBString.from(String(s),enc)];
									if(s instanceof Array){
										finder=finder2;
										sepLen=csize;
									}else{
										sepLen=counter(sep)*csize;
									}
								}
								if(found=finder(b.valueOf()+offset,sep)){
									try{return(this.readText(found-b.valueOf()));}finally{(s instanceof Array) || this.readText(sepLen);}
								}else if(this.__eof__){
									return(this.readText());
								}else if(deadline && ((new Date()).getTime()>deadline)){
									if((typeof(errorOnTimeout)=='undefined')?this.errorOnTimeout:errorOnTimeout){
										throw(ReadTimeout);
									}else{
										return(this.readText(void(0),20,false));
									}
								}else{
									offset=Math.max(0,(this.bufferedSize-this.bufferPosition)-sepLen);
								}
							}
							this.buffer(this.readBlockSize||1024,20,false);
						}
					}finally{
						sep&&sep.free();
					}
				}else{
					var buf,cnt=-(this.position||0);
					if(s==0){
						return("");
					}else if(typeof(s)!='undefined'){
						buf=Byte.alloc(4+s);
						this.readTo(buf.valueOf(),s,timeout,errorOnTimeout);
						buf.zeroTerminated=true;
						cnt+=(this.position||0);
					}else{
						buf=this.readAll(timeout,errorOnTimeout);
						cnt=buf.count;
					}
					buf.encoding=this.encoding||this.detectedEncoding||(this.detectedEncoding=buf.detectEncoding());
					var res=buf.toString(this.__multiByteContext__||0);
					this.__multiByteContext__=buf.decodeContext;
					var broken=cnt-buf.validBytes;
					if(broken){
						if(this.bufferedBytes){
							this.bufferPosition-=broken;
						}else{
							this.bufferedBytes=Byte.alloc(broken+4);
							(new PByte(buf.valueOf()+buf.validBytes)).copy(this.bufferedBytes.valueOf(),broken);
							this.bufferedSize=broken;
							this.bufferPosition=0;
						}
					}
					return(res);
				}
			}finally{
				buf&&buf.free();
				sep&&sep.free();
			}
		},
		readLine:function(to,eto){
			if(this.lineSeparator){
				return(this.readText(this.lineSeparator,to,eto));
			}else if(this.detectedLineSeparator=="\r"){
				var res=this.readText("\r",to,eto);
				if(res.slice(0,1)=='\n'){
					this.detectedLineSeparator="\r\n";
					this.readText(1);
					return(res.slice(1));
				}else{
					return(res);
				}
			}else if(this.detectedLineSeparator){
				return(this.readText(this.detectedLineSeparator,to,eto));
			}else{
				var res=this.readText(["\r\n"],to,eto);
				this.detectedLineSeparator=this.readText(1);
				return(res);
			}
		},
		readln:function(to,eto)(this.readLine(to,eto)),
		
		get lines(){while(!this.eof)yield(this.readLine());},
		
		
		write:function(obj,to,eto){
			if(this.bufferedBytes&&(this.__seek__||this.__move__)){
				this.move(this.position);
			}
			try{
				var buf,addr,len;
				if(obj instanceof Array){
					if(obj.length>1){
						buf=obj[0].alloc((obj[1] instanceof Array)?obj[1].length:1).update(obj[1]);
						addr=buf.valueOf();
						len=obj[0].size*(buf.count||1);
					}else{
						obj=obj[0];
						buf=obj;
						addr=obj.valueOf();
						len=let(l=obj.length,s=obj.constructor.entity.size)(l?(l*s):(obj.size||obj.count*s||s||1));
					}
				}else if(obj instanceof Pointer){
					addr=obj.valueOf();
					len=let(l=obj.length,s=obj.constructor.entity.size)(l?(l*s):(obj.size||obj.count*s||s||1));
				}else{
					buf=MBString.from(obj,this.encoding||this.detectedEncoding||MBString.defaultCodepage);
					addr=buf.valueOf();
					len=buf.length;
				}
				var len2=len;
				var deadline=(typeof(to=(typeof(to)=='undefined')?this.timeout:to)=='undefined')?0:((new Date()).getTime()+to);
				var errorOnTimeout=(typeof(eto)=='undefined')?this.errorOnTimeout:eto;
				while(len2>0 && !this.__eof__){
					var written=this.__write__(addr,len2);
					this.__position__=(this.__position__||0)+written;
					this.bytesSent=(this.bytesSent||0)+written;
					addr+=written;
					len2-=written;
					if(this.__closed__){
						break;
					}
					if(deadline && ((new Date()).getTime()>deadline)){
						if(errorOnTimeout){
							throw(WriteTimeout);
						}else{
							break;
						}
					}
					if(len2>0){
						sleep(20);
					}
				}
				return(len-len2);
			}finally{
				buf && buf.free();
			}
		},
		writeText:function(obj,to,eto)(this.write(String(obj))),
		writeLine:function(str,to,eto)(this.write(String(str)+(this.lineSeparator||"\n"))),
		writeln:  function(str,to,eto)(this.write(String(str)+(this.lineSeparator||"\n"))),
		
		
		seek:function(offset){
			this.bufferedBytes && (this.bufferedBytes=this.bufferedBytes.free());
			if(this.__seek__){
				this.__seek__((this.position||0)+(offset||0)-(this.__position__||0));
			}else{
				this.__move__((this.position||0)+(offset||0));
			}
			this.position=this.__position__=(this.position||0)+(offset||0);
			return(this);
		},
		move:function(pos){
			this.bufferedBytes && (this.bufferedBytes=this.bufferedBytes.free());
			if(this.__move__){
				this.__move__((pos||0));
			}else{
				this.__seek__((pos||0)-(this.position||0));
			}
			this.position=this.__position__=(pos||0);
			return(this);
		},
		moveEnd:function(pos){
			if(typeof(this.size)=='undefined'){
				throw(new Error("stream error: eof is unavailable"));
			}
			this.move(this.size-(pos||0));
			return(this);
		},
		
		get eof()((this.__eof__&&(!this.bufferedBytes||((this.bufferedSize - this.bufferPosition)<1)))||(this.size&&(this.position>=this.size))),
		get size()(this.__size__),
		get closed()(this.__closed__),
		
		flush:function()(this.__flush__&&this.__flush__()),
		close:function(read,write){
			if(typeof(this.__close__)=='function'){
				this.__close__(read,write);
			}
		},
		free:function(){
			this.bufferedBytes && (this.bufferedBytes=this.bufferedBytes.free());
			if(typeof(this.__free__)=='function'){
				this.__free__();
			}
			return(this);
		},
		
		
		finish:function(){
			this.bufferedBytes && (this.bufferedBytes=this.bufferedBytes.free());
			if(typeof(this.__finish__)=='function'){
				this.__finish__();
			}
			return(this);
		},
		
	}));
};



var FileAttributes=new BitFlags({
	readOnly:	0x1,
	hidden:		0x2,
	system:		0x4,
	volumeLabel:0x8,
	directory:	0x10,
	archive:	0x20,
	device:		0x40,
	normal:		0x80,
	temporary:	0x100,
	sparse:		0x200,
	junction:	0x400,
	compressed:	0x800,
	offline:	0x1000,
	notIndexed:	0x2000,
	encrypted:	0x4000,
});

/*
var ByHandleFileInformation=new Struct({
	attributes:			FileAttributes,
	creationTime:		Date.FileTime,
	lastAccessTime:		Date.FileTime,
	lastWriteTime:		Date.FileTime,
	volumeSerialNumber:	UInt,
	sizeHigh:			UInt,
	sizeLow:			UInt,
	numberOfLinks:		UInt,
	fileIndexHigh:		UInt,
	fileIndexLow:		UInt,
});

var ACL=new Struct({
	aclRevision:UChar,
	sbz1:UChar,
	aclSize:Word,
	aceCount:Word,
	sbz2:Word,
});
var SecurityDescriptor=new Struct({
	revision:UChar,
	sbz1:UChar,
	control:UInt,
	owner:Pointer,
	group:Pointer,
	sacl:[ACL],
	dacl:[ACL],
});
*/
var SecurityAttributes=new Struct({
	nLength:UInt,
	lpSecurityDescriptor:Pointer,
	bInheritHandle:UInt,
});

var netapi=WinLibrary.load('netapi32.dll');
let(
	NetServerEnum=		netapi.proc("NetServerEnum",[UInt,UInt,Pointer,UInt,Pointer,Pointer,UInt,WideString,UInt],UInt),
	NetShareEnum=		netapi.proc("NetShareEnum",[WideString,UInt,Pointer,UInt,Pointer,Pointer,UInt],UInt),
	NetApiBufferFree=	netapi.proc('NetApiBufferFree',[Pointer]),
	ServerInfo101=new Struct({
		platformId:		UInt,
		name:			WideString,
		versionMajor:	UInt,
		versionMinor:	UInt,
		type:			UInt,
		comment:		WideString,
	}),
	ShareInfo1=new Struct({
		name:		WideString,
		type:		UInt,
		comment:	WideString,
	}),
	
	
	GetLogicalDriveStrings=kernel32.proc('GetLogicalDriveStringsW',[MultiWideString,UInt],UInt),
	GetDriveType=		kernel32.proc('GetDriveTypeW',[WideString],UInt),
	GetDiskFreeSpace=	kernel32.proc('GetDiskFreeSpaceExW',[WideString,UInt64,UInt64,UInt64],Int),
	GetVolumeInformation=kernel32.proc('GetVolumeInformationW',[WideString,WideString,UInt,Pointer,Pointer,Pointer,WideString,UInt],Int),

	CreateDirectory=	kernel32.proc('CreateDirectoryW',[WideString,SecurityAttributes],Int),
	RemoveDirectory=	kernel32.proc('RemoveDirectoryW',[WideString],Int),
	
	CopyFile=			kernel32.proc('CopyFileW',[WideString,WideString,UInt],Int),
	MoveFile=			kernel32.proc('MoveFileExW',[WideString,WideString,UInt],Int),
//	CreateHardLink=		kernel32.proc('CreateHardLinkW',[WideString,WideString,UInt],Int),
	CreateHardLink=		void(0),
	DeleteFile=			kernel32.proc('DeleteFileW',[WideString],Int),
	
	GetDevicePowerState=	kernel32.proc('GetDevicePowerState',[UInt,Pointer],Int),
	CreateFile=			kernel32.proc('CreateFileW',[WideString,UInt,UInt,SecurityAttributes,UInt,UInt,Int],Int),
	CloseHandle=		kernel32.proc('CloseHandle',[Int],Int),
	
	PeekNamedPipe=		kernel32.proc('PeekNamedPipe',[UInt,Pointer,UInt,Pointer,Pointer,Pointer],UInt,true),
	ReadFile=			kernel32.proc('ReadFile',[UInt,UInt,UInt,Pointer,Pointer],Int,true),
	WriteFile=			kernel32.proc('WriteFile',[UInt,UInt,UInt,Pointer,Pointer],Int,true),
	SetFilePointerEx=	kernel32.proc('SetFilePointerEx',[UInt,UInt,UInt,Int64,UInt],Int),
	FlushFileBuffers=	kernel32.proc('FlushFileBuffers',[UInt],UInt),
	SetEndOfFile=		kernel32.proc('SetEndOfFile',[UInt],UInt),
	GetFileType=		kernel32.proc('GetFileType',[UInt],UInt),
	
	GetLongPathName=	kernel32.proc('GetLongPathNameW',[WideString,WideString,UInt],UInt),
	GetShortPathName=	kernel32.proc('GetShortPathNameW',[WideString,WideString,UInt],UInt),
	GetFileAttributes=	kernel32.proc('GetFileAttributesW',[WideString],FileAttributes,true),
	GetFileSizeEx=		kernel32.proc('GetFileSizeEx',[UInt,UInt64],Int,true),
	GetFileTime=		kernel32.proc('GetFileTime',[UInt,Pointer,Pointer,Pointer],Int),
	
	SetFileAttributes=	kernel32.proc('SetFileAttributesW',[WideString,UInt],UInt),
	SetFileTime=		kernel32.proc('SetFileTime',[UInt,Pointer,Pointer,Pointer],Int),
	
	NtQueryInformationFile=ntdll.proc('NtQueryInformationFile',[UInt,Pointer,Pointer,UInt,UInt],UInt),
	IoStatusBlock=new Struct({
		status:		UInt,
		pointer:	UInt,
	}),
	FileStreamInformation=new Struct({
		nextOffset:		UInt,
		nameLength:		UInt,
		size:			UInt64,
		allocationSize:	UInt64,
	}),
	
	
	FindData=new Struct({
		attributes:FileAttributes,
		ctime:Date.FileTime,
		atime:Date.FileTime,
		mtime:Date.FileTime,
		size:UInt64,
		res0:UInt,
		res1:UInt,
		name:[WChar,260],
		altName:[WChar,14],
	}),
	FindFirstFile=		kernel32.proc('FindFirstFileExW',[WideString,UInt,Pointer,UInt,UInt,UInt],UInt,true),
	FindNextFile=		kernel32.proc('FindNextFileW',[UInt,Pointer],UInt,true),
	FindClose=			kernel32.proc('FindClose',[UInt],UInt),
	
	
	Overlapped=new Struct({
		internal:		UInt,
		internalHigh:	UInt,
		offset:			UInt,
		offsetHigh:		UInt,
		hEvent:			UInt,
	}),
	FileIOCompletionRoutine=StdCallFunction.define([UInt,UInt,Pointer],UInt),
	
	
	FileNotifyInformation=new Struct({
		nextEntryOffset:	UInt,
		action:				UInt,
		fileNameLength:		UInt,
	}),
	ReadDirectoryChanges=	kernel32.proc('ReadDirectoryChangesW',[UInt,Pointer,UInt,UInt,UInt,Pointer,Pointer,Pointer],UInt),
	CancelIo=				kernel32.proc('CancelIo',[UInt],UInt),
	SleepEx=				kernel32.proc('SleepEx',[UInt,UInt],UInt)
	
	
){
	var FileStream=new Class({},StreamMixin,{
		__new__:function(handle){
			this.handle=handle;
			this.type=GetFileType(handle);
		},
		get __size__(){
			if(this.type!=1){
				return(void(0));
			}
			try{
				var v=UInt64.alloc();
				GetFileSizeEx(this.handle,v);
				return(v.toObject());
			}catch(e){
				if(e.code==109 || e.code==38 ||e.code==0x06){
					this.__closed__=true;
				}
				return(0);
			}finally{
				v&&v.free();
			}
		},
		__read__:function(addr,size){
			try{
				var v=UInt.alloc();
				if(this.type==3){
					PeekNamedPipe(this.handle,null,0,null,v,null);
					if(v.item()==0){
						return(0);
					}
				}
				ReadFile(this.handle,addr,size,v,null);
				this.__eof__=v.item()==0;
				return(v.item());
			}catch(e){
				if(e.code==109 || e.code==38){
					this.__eof__=true;
				}
				return(v.item());
			}finally{
				v&&v.free();
			}
		},
		__write__:function(addr,size){
			try{
				var v=UInt.alloc();
				WriteFile(this.handle,addr,size,v,null);
				return(v.item());
			}catch(e){
				this.__closed__=true;
				return(v.item());
			}finally{
				v&&v.free();
			}
		},
		__seek__:function(offset){
			try{
				var p=Int64.alloc().update(offset);
				SetFilePointerEx(this.handle,p.low,p.high,p,1);
				return(p.item());
			}finally{
				p&&p.free();
			}
		},
		__move__:function(pos){
			try{
				var p=Int64.alloc().update(pos);
				SetFilePointerEx(this.handle,p.low,p.high,p,0);
				return(p.item());
			}catch(e){
			}finally{
				p&&p.free();
			}
		},
		
		__flush__:function(){
			if(this.type==1){
				FlushFileBuffers(this.handle);
			}
		},
		
		__free__:function(){
			CloseHandle(this.handle);
			this.__closed__=true;
		},
		
		
	});
	
	
	
	var DirectoryMixin=(new Class({
		toString:function()this.path,
		buildPath:function(path){
			path=String(path);
			var d=AbstractFile.pathDelimiter;
			var c=(path.slice(-1)==d)?Directory:File;
			try{
				return(path?new c(path):this);
			}catch(e){
				return((path==d)?(this.root||this):new c((path.slice(0,1)==d)?this.root.path+path:this.path+d+path));
			}
		},
		
		find:function(pattern,mode){
			try{
				var d=FindData.alloc();
				var h=FindFirstFile(this.extendedPath+"\\"+pattern,0,d,(mode==2)?1:0,0,0);
				do{
					var n=String(d.name);
					if(n=='.' || n=='..'){
					}else if(mode!=1 && d.attributes.directory){
						yield(new Directory(this.path+"\\"+n));
					}else if(mode!=2 && !d.attributes.directory){
						yield(new File(this.path+"\\"+n));
					}
				}while(FindNextFile(h,d));
			}catch(e){
				throw((e.code==18)?StopIteration:e);
			}finally{
				d && d.free();
				h && FindClose(h);
			}
		},
		get children()(this.find("*")),
		get files()(this.find("*",1)),
		get directories()(this.find("*",2)),
		get descendants(){
			for(let f in this.find("*")){
				yield(f);
				if(f instanceof Directory && !f.attributes.junction){
					for(let d in f.descendants){
						yield(d);
					}
				}
			}
		},
		file : function(n)(this.buildPath(n)),
		directory:function(n)(this.buildPath(n+"\\")),
		get isEmpty(){
			for(let f in this.files){
				return(false);
			}
			for(let d in this.directories){
				return(false);
			}
			return(true);
		},
	}));
	
	
	var FileServer=(new Class({
		__class__:{
			get all(){
				try{
					var b=ServerInfo101.pointer.alloc();
					var c=UInt.alloc();
					var t=UInt.alloc();
					NetServerEnum(0,101,b,0xffffffff,c,t,3,null,0);
					for(var i=0,l=c.item();i<l;i++){
						var item=b.item().item(i);
						yield(new this(item.name.toString(),item.comment.toString()));
					}
				}finally{
					b&&b.item()&&NetApiBufferFree(b.item());
					b&&b.free();
					c&&c.free();
					t&&t.free();
				}
			},
		},
		__new__:function(hostname,comment){
			this.host=this.name=hostname.replace(/\\/,"");
			this.path="\\\\"+this.host;
			this.comment=comment;
		},
		get directories(){
			try{
				var b=ShareInfo1.pointer.alloc();
				var c=UInt.alloc();
				var t=UInt.alloc();
				NetShareEnum(this.host,1,b,0xffffffff,c,t,0);
				for(var i=0,l=c.item();i<l;i++){
					var item=b.item().item(i);
					if(item.type==0 && !item.name.toString().match(/\$/)){
						yield(new SharedDirectory(this,item.name.toString(),item.comment.toString()));
					}
				}
			}finally{
				b&&b.item()&&NetApiBufferFree(b.item());
				b&&b.free();
				c&&c.free();
				t&&t.free();
			}
		},
	}));
	
	var SharedDirectory=(new Class({},DirectoryMixin,{
		__new__:function(parent,name,comment){
			this.parent=(typeof(parent)=='string')?new FileServer(parent):parent;
			this.path=parent.path+"\\"+name;
			this.host=parent.name;
			this.name=name;
			this.comment=comment;
			this.extendedPath="\\\\?\\UNC\\"+this.host+"\\"+this.name;
		},
		type:'shared',
	}));
	
	var LocalDrive=(new Class({},DirectoryMixin,{
		__class__:{
			__observeFirst__:function(){
				this.__observedWindow__=require('Window').MessageReceiver.create();
				this.__observedWindow__.observe(0x219,function(obj){
				});
			},
			__unobserveLast__:function(){
				this.__observedWindow__.close(true);
			},
			
			get all(){
				try{
					var b=WChar.alloc(1024);
					var h=GetLogicalDriveStrings(1024,b);
					var a=(new MultiWideString(b)).toArray();
					for(var i=0,l=a.length;i<l;i++){
						yield(new this(a[i]));
					}
				}finally{
					b&&b.free();
					h&&FindVolumeClose(h);
				}
			},
		},
		__new__:function(letter){
			this.letter=letter.slice(0,1);
			this.name=this.path=this.letter+":";
			this.extendedPath="\\\\?\\"+this.path;
		},
		
		get power(){
			try{
				var h=CreateFile(this.extendedPath,0x00000000,7,null,3,0,0);
				var p=Int.alloc();
				GetDevicePowerState(h,p);
				return(0!=p.item());
			}finally{
				CloseHandle(h);
				free(p);
			}
		},
		
		get label(){
			try{
				var b=WChar.alloc(260);
				if(GetVolumeInformation(this.path+"\\",b,260,null,null,null,null,0)){
					return(b.toString());
				}
			}finally{
				b&&b.free();
			}
		},
		get serial(){
			try{
				var v=UInt.alloc();
				if(GetVolumeInformation(this.path+"\\",null,0,v,null,null,null,0)){
					return(v.item());
				}
			}finally{
				v&&v.free();
			}
		},
		get fileSystem(){
			try{
				var b=WChar.alloc(64);
				if(GetVolumeInformation(this.path+"\\",null,0,null,null,null,b,64)){
					return(b.toString());
				}
			}finally{
				b&&b.free();
			}
		},
		
		get type()(['unknown','noRootDir','removable','fixed','remote','cdrom','ramDisk'][GetDriveType(this.path+"\\")]),
		get exists()(GetDriveType(this.path+"\\")>1),
		
		get totalSpace(){
			try{
				var v=UInt64.alloc();
				if(GetDiskFreeSpace(this.path+"\\",null,v,null)){
					return(v.toObject());
				}
			}finally{
				v&&v.free();
			}
		},
		get availableSpace(){
			try{
				var v=UInt64.alloc();
				if(GetDiskFreeSpace(this.path+"\\",v,null,null)){
					return(v.toObject());
				}
			}finally{
				v&&v.free();
			}
		},
		get freeSpace(){
			try{
				var v=UInt64.alloc();
				if(GetDiskFreeSpace(this.path+"\\",null,null,v)){
					return(v.toObject());
				}
			}finally{
				v&&v.free();
			}
		},
		get usedSpace()(this.totalSpace-this.freeSpace),
		
	}));
	
	var AbstractFile=(new Class({
		__class__:{
			pathIsAbsolute:function(path)(String(path).match(/\\\\|:/)),
			
			pathDelimiter:"\\",
			__invalidCharsRegExp__:new RegExp('[\\x00-\\x1F'+RegExp.escape('\\:/"*?<>|')+']','g'),
			replaceInvalidChars:function(str,replacement)str.replace(this.__invalidCharsRegExp__,replacement||''),
		},
		__new__:function(path){
			path=String(path).replace(/\//g,'\\').replace(/^\\\\\?\\UNC\\/,"\\\\").replace(/^\\\\\?\\/,"");
			if(!(this.root=let(m=path.match(/^(?:\\\\([^\\]+)\\([^\\]+)|(.):)/))(m&&(m[1]?new SharedDirectory(new FileServer(m[1]),m[2]):new LocalDrive(m[3]))))){
				throw(new Error('path error: parse failed ('+path+')'));
			}
			
			
			for(var d=(this.pathFromRoot=path.slice(this.root.path.length)).split(/[\\\/]/),d2=[],i=0,l=d.length;i<l;i++){
				if(d[i]=='..'){
					d2.pop();
				}else if(d[i]!='.' && d[i]!=''){
					d2.push(d[i]);
				}
			}
			[this.path,this.extendedPath]=let(p=(d2.length>0)?"\\"+d2.join("\\"):"")([this.root.path+p,this.root.extendedPath+p]);
		},
		
		get url()('file:'+((this.root instanceof SharedDirectory)?'':'///')+this.path.replace(/\\/g,'/')),
		
		toString:function()this.path,
		get fullName()this.path,
		get name()(this.path.slice(this.path.lastIndexOf(this.constructor.pathDelimiter)+1)),
		get baseName()(this.name.replace(/\.[^\.]+$/,'')),
		get extension()((this.name.match(/\.[^\.]+$/)||[])[0]),
		
		get extLC()((this.extension||'').toLowerCase()),
		
		get long()(new this.constructor(this.longPath)),
		get longName()(this.long.name),
		get longPath(){
			try{
				var buf=WChar.alloc(8192);
				GetLongPathName(this.path,buf,8191);
				return((buf.toString()||this.path).replace(/^\\\\\?\\UNC\\/,"\\\\").replace(/^\\\\\?\\/,''));
			}finally{
				free(buf);
			}
		},
		
		get short()(new this.constructor(this.shortPath)),
		get shortName()(this.short.name),
		get shortPath(){
			try{
				var buf=WChar.alloc(8192);
				GetShortPathName(this.extendedPath,buf,8191);
				return((buf.toString()||this.path).replace(/^\\\\\?\\UNC\\/,"\\\\").replace(/^\\\\\?\\/,''));
			}finally{
				free(buf);
			}
		},
		
		
		getNonexistent:function(pattern){
			var f=this;
			try{
				GetFileAttributes(f.extendedPath);
				for(var n in (pattern||"([1-])").expand()){
					f=new this.constructor(this.parent.buildPath(this.baseName+n+this.extension));
					GetFileAttributes(f.extendedPath);
				}
			}catch(e){
				return(f);
			}
		},
		
		
		
		
		get parent(){
			if(this.path==this.root.path){
				return(void(0));
			}
			var p=this.path.slice(0,this.path.lastIndexOf(this.constructor.pathDelimiter));
			if(p==this.root.path){
				return(this.root);
			}else{
				return(new Directory(p));
			}
		},
		
		changeExtension:function(ext)(new this.constructor(this.path.replace(/(?:\.[^\\\/]+|)$/,ext||""))),
		
		
		get attributes(){
			try{
				return(GetFileAttributes(this.extendedPath));
			}catch(e){
				return(void(0));
			}
		},
		set attributes(v)(SetFileAttributes(this.extendedPath,v)!=0),
		get isDirectory()(this.attributes.directory),
		
		get timeCreated(){
			try{
				var h=CreateFile(this.extendedPath,0x80000000,3,null,3,0x02000000,0);
				var t=Date.FileTime.alloc();
				if((h!=-1)&&(GetFileTime(h,t,null,null)!=0)){
					return(t.toObject());
				}
			}finally{
				h&&CloseHandle(h);
				t&&t.free();
			}
		},
		set timeCreated(time){
			try{
				var h=CreateFile(this.extendedPath,0x80000100,3,null,3,0x02000000,0);
				if(h!=-1){
					var t=Date.FileTime.from(time);
					SetFileTime(h,t,null,null);
				}
			}finally{
				h&&CloseHandle(h);
				t&&t.free();
			}
		},
		
		get timeLastModified(){
			try{
				var h=CreateFile(this.extendedPath,0x80000000,3,null,3,0x02000000,0);
				var t=Date.FileTime.alloc();
				if((h!=-1)&&(GetFileTime(h,null,null,t)!=0)){
					return(t.toObject());
				}
			}finally{
				h&&CloseHandle(h);
				t&&t.free();
			}
		},
		set timeLastModified(time){
			try{
				var h=CreateFile(this.extendedPath,0x80000100,3,null,3,0x02000000,0);
				if(h!=-1){
					var t=Date.FileTime.from(time);
					SetFileTime(h,null,null,t);
				}
			}finally{
				h&&CloseHandle(h);
				t&&t.free();
			}
		},
		get timeLastAccessed(){
			try{
				var h=CreateFile(this.extendedPath,0x80000000,3,null,3,0x02000000,0);
				var t=Date.FileTime.alloc();
				if((h!=-1)&&(GetFileTime(h,null,t,null)!=0)){
					return(t.toObject());
				}
			}finally{
				h&&CloseHandle(h);
				t&&t.free();
			}
		},
		set timeLastAccessed(time){
			try{
				var h=CreateFile(this.extendedPath,0x80000100,3,null,3,0x02000000,0);
				if(h!=-1){
					var t=Date.FileTime.from(time);
					SetFileTime(h,null,t,null);
				}
			}finally{
				h&&CloseHandle(h);
				t&&t.free();
			}
		},
	
		copy:function(dest,overwrite){
			if(dest instanceof Directory){
				return(this.copy(String(dest)+this.constructor.pathDelimiter+this.name,overwrite));
			}else if(String(dest).slice(-1)==this.constructor.pathDelimiter){
				return(this.copy(dest+this.name,overwrite));
			}
			var d=new this.constructor(this.buildPath(String(dest)).path);
			if(this.isLeaf){
				return((0!=CopyFile(this.extendedPath,d.extendedPath,overwrite?0:1)) && d);
			}else{
				if(d.exists){
					if(!overwrite){
						return(false);
					}
				}else{
					d.create();
					if(!d.exists){
						return(false);
					}
				}
				var f=true;
				for(let c in this.children){
					if(!c.copy(d.buildPath(c.name),overwrite)){
						if(overwrite){
							f=false;
						}else{
							return(false);
						}
					}
				}
				return(f && d);
			}
		},
		
		move:function(dest,overwrite){
			if(dest instanceof Directory){
				return(this.move(String(dest)+this.constructor.pathDelimiter+this.name,overwrite));
			}else if(String(dest).slice(-1)==this.constructor.pathDelimiter){
				return(this.move(dest+this.name,overwrite));
			}
			var d=new this.constructor(this.buildPath(String(dest)).path);
			if(this.root.path==d.root.path){
				if(d.exists){
					if(overwrite){
						d.remove();
					}else{
						return(false);
					}
				}
				return((0!=MoveFile(this.extendedPath,d.extendedPath,overwrite?1:0)) && d);
			}else{
				return(this.copy(d.path,overwrite) && this.remove() && d);
			}
		},
		rename:function(name)(this.move(this.parent.buildPath(name))),
		
	})).addAliases({
		ctime:'timeCreated',
		atime:'timeLastAccessed',
		mtime:'timeLastModified',
		timeAccessed:'timeLastAccessed',
		timeModified:'timeLastModified',
		ext:'extension',
		
	}).classMethodize(
		'parent',
		'timeCreated','ctime',
		'timeLastAccessed','atime',
		'timeLastModified','mtime',
		'exists'
	);
	
	
	var FileStreamOperationMixin=(new Class({
		get size(){
			var h=CreateFile(this.extendedPath,0x80000000,0,null,3,0,0);
			if(h==-1){
				return(void(0));
			}else{
				var val=UInt64.alloc();
				GetFileSizeEx(h,val);
				var res=val.toObject();
				val.free();
				CloseHandle(h);
				return(res);
			}
		},
		open:function(mode,share,createFlag,attr){
			if(mode&0x40000000){
				if(this.parent.create){
					this.parent.create();
				}
				if(!this.parent.exists){
					throw(new Error("file error: failed to create directory ("+this.parent.path+")"));
				}
			}
			var h=CreateFile(this.extendedPath,mode,share,null,createFlag,attr,0);
			if(h!=-1){
				return(new FileStream(h));
			}else{
				throw(new Error('file error: open failure('+this.path+')'));
			}
		},
		openRead:	function(blockWrite)(this.open(0x80000000,blockWrite?1:3,4,0)),
		openWrite:	function(blockRead)(this.open(0xC0000000,blockRead?0:1,4,0)),
		openAppend:	function(blockRead)(this.open(0xC0000000,blockRead?0:1,4,0).moveEnd()),
		openNew:	function(blockRead)(this.open(0xC0000000,blockRead?0:1,2,0)),
		
		get exists(){
			try{
				return(!GetFileAttributes(this.extendedPath).directory && this);
			}catch(e){
				return(false);
			}
		},
		create:function(){
			this.openWrite().free();
			return(this);
		},
		remove:function(force){
			if(force){
				this.attributes=0x80;
			}
			return(0!=DeleteFile(this.extendedPath));
		},
		load:function(type){
			try{
				var s=this.openRead();
				if(!type || typeof(type)=='string'){
					s.encoding=type||this.encoding;
					return(s.readText());
				}else{
					return(s.read(type));
				}
			}finally{
				s&&s.free();
			}
		},
		loadBytes:function(){
			try{
				var s=this.openRead();
				return(s.readAll());
			}catch(e){
			}finally{
				s&&s.free();
			}
			
		},
		loadJSON:function(encoding)((new ScriptFile(this)).eval()),
		saveJSON:function(value)(this.update(value.toSource(),"utf8")),
		save:function(value)(this.update(value)),
		update:function(value,cs){
			try{
				var s=this.openNew(true);
				s.encoding=cs;
				s.write(value);
				return(this);
			}finally{
				s&&s.free();
			}
		},
		append:function(value,cs){
			try{
				var s=this.openAppend(true);
				s.charset=cs;
				s.write(value);
				return(this);
			}finally{
				s&&s.free();
			}
		},
		get lines(){
			try{
				var s=this.openRead();
				s.lineSeparator=this.lineSeparator;
				s.encoding=this.encoding;
				while(!s.eof){
					yield(s.readLine());
				}
			}finally{
				s&&s.free();
			}
		},
	}));
	
	var File=(new Class(AbstractFile,FileStreamOperationMixin,EventMixin,{
		isLeaf:true,
		get streams(){
			try{
				var h=CreateFile(this.extendedPath,0x80000000,1,null,4,0,0);
				var o=IoStatusBlock.alloc();
				var s=1024;
				var b=Byte.alloc(s);
				if(h!=-1){
					while(NtQueryInformationFile(h,o,b,s,22)!=0){
						b.free();
						b=Byte.alloc(s=s*2);
					}
					var pos=b.valueOf();
					while(true){
						var inf=new FileStreamInformation.pointer(pos);
						var name=Object.extend((new WideString(pos+24)),{count:inf.nameLength}).toString().match(/:(.+):/);
						if(name){
							yield(new FileSubStream(this,name[1]));
						}
						if(inf.nextOffset==0){
							break;
						}
						pos+=inf.nextOffset;
					}
				}
			}finally{
				h&&CloseHandle(h);
				o&&o.free();
				b&&b.free();
			}
		},
		buildPath:function(path)(this.parent.buildPath(path)),
		stream:function(name)(new FileSubStream(this,name)),
		link:function(dest){
			if(!CreateHardLink){
				CreateHardLink=kernel32.proc('CreateHardLinkW',[WideString,WideString,UInt],Int);
			}
			CreateHardLink(this.extendedPath,(new File(dest)).extendedPath,0);
		},
		__observeFirst__:function(){
			var _this=this;
			this.__ovservedParent__=this.parent;
			this.__ovservedEventHandler__=function(o){if(o.file.path==_this.path){_this.fire(o.event);}};
			this.__ovservedEventHandlerAdd__=function(o){if(o.file.path==_this.path){_this.fire('create');}};
			this.__ovservedEventHandlerRename__=function(o){
				if(o.old.path==_this.path){
					_this.fire('renameTo',{file: o.file});
				}else if(o.file.path==_this.path){
					_this.fire('renameFrom',{file: o.old});
				}
			};
			this.__ovservedParent__.observe('add',this.__ovservedEventHandlerAdd__);
			this.__ovservedParent__.observe('remove',this.__ovservedEventHandler__);
			this.__ovservedParent__.observe('modify',this.__ovservedEventHandler__);
			this.__ovservedParent__.observe('rename',this.__ovservedEventHandlerRename__);
		},
		__unobserveLast__:function(){
			if(this.__ovservedParent__){
				this.__ovservedParent__.unobserveAll();
				this.__ovservedParent__=null;
			}
		},
	}));
	
	var FileSubStream=(new Class({},FileStreamOperationMixin,{
		__new__:function(parent,name){
			this.name=name;
			this.parent=parent;
			this.root=parent.root;
			this.path=parent.path+":"+name;
			this.extendedPath=parent.extendedPath+":"+name;
		},
		
	}));
	
	
	var Directory=(new Class(AbstractFile,DirectoryMixin,EventMixin,{
		__observeFirst__:function(){
			var _this=this;
			this.__observed__=true;
			this.__observerThread__=Thread.create(function(){
				try{
					var handle=CreateFile(_this.extendedPath,1,3,null,3,0x42000000,0);
					var size=32768;
					var buf=Byte.alloc(size);
					var read=UInt.alloc();
					var sig=_this.__observerThread__.signal=new Signal();
					var ol=Overlapped.alloc();
					ol.hEvent=sig.handle;
					var oldname;
					while(_this.__observed__ && ReadDirectoryChanges(handle,buf,size,1,_this.observeFlags||0x15F,read,ol,null) && sig.wait()){
						sig.turnOff();
						if(!_this.__observed__){
							break;
						}
						var p=buf;
						while(true){
							var inf=new FileNotifyInformation.pointer(p);
							try{
								var len=inf.fileNameLength;
								var name=WChar.alloc(len+1);
								(new Byte.pointer(inf.inc(1))).copy(name,len);
								var n=name.toString();
								var ac=inf.action;
								if(ac==4){
									oldname=n;
								}else{
									var obj={file: _this.file(n+"\\").exists||_this.file(n)};
									if(ac==5){
										obj.old=_this.file(oldname+((obj.file instanceof Directory)?"\\":""));
									}
									_this.fire(['','add','remove','modify','','rename'][ac],obj);
								}
							}catch(e){
							}finally{
								name && name.free();
							}
							if(inf.nextEntryOffset){
								p=p.inc(inf.nextEntryOffset);
							}else{
								break;
							}
						}
					}
				}finally{
					CloseHandle(handle);
					free(buf,read,sig,ol);
				}
			});
			Main.reside();
			Main.observe('exit',function(){_this.unobserveAll()});
		},
		__unobserveLast__:function(){
			this.__observed__=false;
			this.__observerThread__.signal.turnOn();
			this.__observerThread__.waitExit();
			this.__observerThread__.free();
			this.__observerThread__=null;
			Main.unreside();
		},
		
		get exists(){
			try{
				return(GetFileAttributes(this.extendedPath).directory && this);
			}catch(e){
				return(false);
			}
		},
		
		create:function(){
			if(this.parent && this.parent.root && !this.parent.exists){
				this.parent.create();
			}
			CreateDirectory(this.extendedPath,null);
			return(this);
		},
		
		remove:function(force){
			var f=true;
			for(let f in this.children){
				if(!f.remove(force)){
					if(force){
						f=false;
					}else{
						return(false);
					}
				}
			}
			return(f && (0!=RemoveDirectory(this.extendedPath)));
		},
		
	}));
}



var Unit=new Class({
	__class__:{
		__loaded__:{},
		load:function(name){
			name=String(name);
			var baseName=name.replace(/\..*$/,'');
			var d=Main.directory.directory("lib");
			if(d.directory(name).exists){
				var dir=d.directory(name);
				var file=dir.file(baseName+".ng");
				var func=__NG__EvalString(file.load(),file.path,1);
				var unit=new this(func,name,baseName,file,dir);
				this.__loaded__[name.toLowerCase()]=unit;
				return(unit);
			}else{
				var name2=[i.name for(i in d.find(name+".*",2))].sort().pop();
				if(name2){
					return(this.require(name2));
				}else{
					throw('Unit error: not found('+name+')');
				}
			}
		},
		__call__:function(){
			var res=[];
			for(var i=0,l=arguments.length;i<l;i++){
				res[res.length]='for(let [n,v] in Iterator(require("'+arguments[i]+'")))if(["name","baseName","file","directory"].indexOf(n)==-1)eval("let "+n+"=v;");';
			}
			return(res.join(''));
		},
		require:function(name)(this.__loaded__[String(name).toLowerCase()]||this.load(name)),
	},
	__new__:function(func,name,baseName,file,directory){
		this.name=name;
		this.baseName=baseName||name;
		this.file=file;
		this.directory=directory;
		func.call(this);
	},
	extend:function(target){
		target=target||global;
		var exclude=['name','baseName','file','directory'];
		for(let [n,v] in Iterator(this)){
			if(exclude.indexOf(n)==-1){
				target[n]=v;
			}
		}
		return(target);
	},
});
var require=function(name)(Unit.require(name));
var use=function(){
	for(var i=0,l=arguments.length;i<l;i++){
		Unit.require(arguments[i]).extend();
	}
};



var Pluggable=new Class({
	__new__:function(name,itemClass){
		this.name=name;
		this.itemClass=itemClass||Plugin;
		this.__items__={};
	},
	item:function(name)(this.__items__[name]|| (this.__items__[name]=new (this.itemClass)(name,this))),
	get items(){
		var d=[pref('plugins\\'+this.name+'\\')
			,Main.scriptDirectory.directory("plugins\\"+this.name)];
		if(Main.directory.path!=Main.scriptDirectory.path){
			d.push(Main.directory.directory("plugins\\"+this.name));
		}
		var found={};
		for(var i=0,l=d.length;i<l;i++){
			if(d[i] && d[i].exists){
				for(let f in d[i].files){
					if((f.extension=='.ng') && !found[f.baseName]){
						yield(this.item(f.baseName));
						found[f.baseName]=true;
					}
				}
				for(let f in d[i].directories){
					if(!found[f.name]){
						yield(this.item(f.name));
						found[f.name]=true;
					}
				}
			}
		}
	},
	select:function(target,withAdp){
		var res=[];
		for(let v in this.items){
			try{
				var s=v.load().test(target);
				if(s){
					res.push({item:v,score:(typeof(s)=='number')?s:1});
				}
			}catch(e){
			}
		}
		res.sort(function(a,b)(b.score-a.score));
		return(withAdp?res:res.pluck('item'));
	},
	find:function(target)(this.select(target)[0]),
	pluck:function(name,target){
		var res=[];
		if(target){
			for(var items=this.select(target),i=0,l=items.length;i<l;i++){
				res.push(items[i].load()[name]);
			}
		}else{
			for(var p in this.items){
				res.push(p.load()[name]);
			}
		}
		return(res);
	},
});


var Plugin=new Class({
	__new__:function(name,parent){
		this.name=name;
		this.parent=parent;
		this.exists=this;
		var f=Main.directory.path!=Main.scriptDirectory.path;
		var e;
		if(e=pref('plugins\\'+parent.name+'\\'+name+".ng").exists){
			this.inUserDir=true;
			this.file=e;
			this.directory=e.parent.directory(name);
		}else if(e=pref('plugins\\'+parent.name+'\\'+name+"\\").exists){
			this.inUserDir=true;
			this.file=e.file(name+".ng");
			this.directory=e;
		}else if(e=Main.scriptDirectory.file("plugins\\"+parent.name+"\\"+name+".ng").exists){
			this.file=e;
			this.directory=e.parent.directory(name);
		}else if(e=Main.scriptDirectory.file("plugins\\"+parent.name+"\\"+name+"\\").exists){
			this.file=e.file(name+".ng");
			this.directory=e;
		}else if(f && (e=Main.directory.file("plugins\\"+parent.name+"\\"+name+".ng").exists)){
			this.file=e;
			this.directory=e.parent.directory(name);
		}else if(f && (e=Main.directory.file("plugins\\"+parent.name+"\\"+name+"\\").exists)){
			this.file=e.file(name+".ng");
			this.directory=e;
		}else{
			this.exists=void(0);
		}
	},
	load:function(noError){
		if(this.exists){
			if(!this.loaded){
				try{
					Object.extend(this,(new ScriptFile(this.file.path)).eval());
					this.loaded=true;
					this.init();
					return(this);
				}catch(e){
					println(e);
					if(noError){
						return(void(0));
					}else{
						throw(e);
					}
				}
			}else{
				return(this);
			}
		}
	},
	reload:function(){
		this.unload();
		return(this.load());
	},
	unload:function(){
		if(this.loaded){
			this.free();
			for(let n in this){
				if(this.hasOwnProperty(n) && !n.match(/^(name|exists|parent|file|directory|inUserDir)$/)){
					delete(this[n]);
				}
			}
		}
		return(this);
	},
	pref:function(n,w)(this.exists && (w?let(p=this.pref())(p && p.file(n)):let(d=this.directory)(
		n?(d.file('config\\'+n).exists
			||(!this.inUserDir && !d.file('config\\').exists && d.file('users\\'+System.userName+'\\'+n).exists)
			||d.file('users\\default\\'+n).exists
		):(d.file('config\\').exists||(!this.inUserDir && d.file('users\\'+System.userName+'\\').create().exists)||d.file('config\\').create().exists)
	))),
	resource:function(n)(this.exists && let(d=this.directory)(
		d.file('res\\custom\\'+n).exists
		||d.file('res\\'+System.locale.langName+'\\'+n).exists
		||d.file('res\\default\\'+n).exists
	)),
	init:Function.doNothing,
	free:Function.doNothing,
	test:function()1,
});





var shell32=WinLibrary.load('shell32.dll');
var psapi=WinLibrary.load('psapi.dll');
let(
	ShellExecute=					shell32.proc('ShellExecuteW',[UInt,WideString,WideString,WideString,WideString,Int],Int),
	OpenProcess=					kernel32.proc('OpenProcess',[UInt,UInt,UInt],Int,true),
	GetExitCodeProcess=				kernel32.proc('GetExitCodeProcess',[UInt,Pointer],Int),
	GetPriorityClass=				kernel32.proc('GetPriorityClass',[UInt],Int),
	SetPriorityClass=				kernel32.proc('SetPriorityClass',[UInt,UInt],Int),
	TerminateProcess=				kernel32.proc('TerminateProcess',[UInt,UInt],UInt),
	GetStdHandle=					kernel32.proc("GetStdHandle",[UInt],UInt),
	
	
	GetModuleFileNameEx=			psapi.proc('GetModuleFileNameExW',[UInt,UInt,WideString,UInt],UInt),
	GetModuleBaseName=				psapi.proc('GetModuleBaseNameW',[UInt,UInt,WideString,UInt],UInt),
	GetProcessId=					kernel32.proc('GetProcessId',[UInt],UInt),
	
	addrCommandLine=				UInt.read(kernel32.getCFunction('GetCommandLineW').valueOf()+1),
	
	
	VirtualAllocEx=					kernel32.proc('VirtualAllocEx',[UInt,UInt,UInt,UInt,UInt],UInt),
	VirtualFreeEx=					kernel32.proc('VirtualFreeEx',[UInt,UInt,UInt,UInt],UInt),
	ReadProcessMemory=				kernel32.proc('ReadProcessMemory',[UInt,UInt,Pointer,UInt,Pointer],UInt,true),
	WriteProcessMemory=				kernel32.proc('WriteProcessMemory',[UInt,UInt,UInt,UInt,Pointer],UInt),
	
	StartupInfo=new Struct({
		cb:			UInt,
		reserved:	UInt,
		desktop:	WideString,
		title:		WideString,
		x:			UInt,
		y:			UInt,
		width:		UInt,
		height:		UInt,
		cols:		UInt,
		rows:		UInt,
		attributes:	UInt,
		flags:		UInt,
		showWindow:	Word,
		reserved2:	Word,
		reserved3:	UInt,
		stdIn:		UInt,
		stdOut:		UInt,
		stdError:	UInt
	}),
	
	ProcessInformation=new Struct({
		hProcess:	UInt,
		hThread:	UInt,
		processId:	UInt,
		threadId:	UInt
	}),
	
	
	ProcessEntry32=new Struct({
		cb:				UInt,
		usage:			UInt,
		processID:		UInt,
		defaultHeapID:	UInt,
		moduleID:		UInt,
		threadsCount:	UInt,
		parentPID:		UInt,
		basePriorityClass:	Int,
		flags:			UInt,
		fileName:		[WChar,260],
	}),
	ThreadEntry32=new Struct({
		cb:				UInt,
		usage:			UInt,
		threadId:		UInt,
		ownerPID:		UInt,
		priority:		UInt,
		deltaPri:		UInt,
		flags:			UInt,
	}),
	
	CreateToolhelp32Snapshot=	kernel32.proc('CreateToolhelp32Snapshot',[UInt,UInt],UInt),
	Process32First=				kernel32.proc('Process32FirstW',[UInt,Pointer],UInt,true),
	Process32Next=				kernel32.proc('Process32NextW',[UInt,Pointer],UInt,true),
	Thread32First=				kernel32.proc('Thread32First',[UInt,Pointer],UInt,true),
	Thread32Next=				kernel32.proc('Thread32Next',[UInt,Pointer],UInt,true),
	
	
	ProcessMemoryCounters=new Struct({
		cb:							UInt,
		pageFaultCount:				UInt,
		peakWorkingSetSize:			UInt,
		workingSetSize:				UInt,
		quotaPeakPagedPoolUsage:	UInt,
		quotaPagedPoolUsage:		UInt,
		quotaPeakNonPagedPoolUsage:	UInt,
		quotaNonPagedPoolUsage:		UInt,
		pagefileUsage:				UInt,
		peakPagefileUsage:			UInt,
		privateUsage:				UInt,
	}),
	GetProcessMemoryInfo=psapi.proc('GetProcessMemoryInfo',[UInt,Pointer,UInt],Int),
	
	WaitForSingleObject=	kernel32.proc('WaitForSingleObject',[UInt,UInt],UInt,true),
	WaitForMultipleObjects=kernel32.proc('WaitForMultipleObjects',[UInt,Pointer,UInt,UInt],UInt),
	WaitForInputIdle=		user32.proc('WaitForInputIdle',[UInt,UInt],UInt),
	
	CreateFile=				kernel32.proc('CreateFileW',[WideString,UInt,UInt,SecurityAttributes,UInt,UInt,Int],Int),
	CreatePipe=				kernel32.proc('CreatePipe',[Pointer,Pointer,SecurityAttributes,UInt],UInt),
	DuplicateHandle=		kernel32.proc('DuplicateHandle',[UInt,UInt,UInt,Pointer,UInt,UInt,UInt],UInt),
	CreateProcess=			kernel32.proc('CreateProcessW',[WideString,WideString,SecurityAttributes,SecurityAttributes,UInt,UInt,UInt,WideString,Pointer,Pointer],UInt),
	CreateProcessWithLogon=	advapi32.proc('CreateProcessWithLogonW',[WideString,WideString,WideString,UInt,WideString,WideString,UInt,UInt,WideString,Pointer,Pointer],UInt),
	
	ThreadStartRoutine=		ThreadSafeStdCallback.define([UInt],UInt),
	CreateThread=			kernel32.proc('CreateThread',[SecurityAttributes,UInt,Pointer,UInt,UInt,Pointer],UInt,true),
	OpenThread=				kernel32.proc('OpenThread',[UInt,UInt,UInt],Int,true),
	GetCurrentThreadId=		kernel32.proc('GetCurrentThreadId',[],UInt),
	
	SuspendThread=			kernel32.proc('SuspendThread',[UInt],UInt),
	ResumeThread=			kernel32.proc('ResumeThread',[UInt],UInt),
	TerminateThread=		kernel32.proc('TerminateThread',[UInt,UInt],UInt),
	
	GetThreadPriority=		kernel32.proc('GetThreadPriority',[UInt],Int),
	SetThreadPriority=		kernel32.proc('SetThreadPriority',[UInt,Int],UInt),
	GetExitCodeThread=		kernel32.proc('GetExitCodeThread',[UInt,Pointer],Int),
	
	NtQueryInformationThread=	ntdll.proc('NtQueryInformationThread',[UInt,UInt,Pointer,UInt,Pointer],UInt),
	
	CloseHandle=			kernel32.proc('CloseHandle',[Int],Int)
){
	var exec=function(file,opr,opt){
		var f=5;
		if(typeof(opr)=='number'){
			f=opr;
			opr=void(0);
		}else if(typeof(opr)=='object'){
			opt=opr;
			opr=opt.command;
		}else if(typeof(opt)=='string'){
			f=({hide:0,min:6,max:3})[opt]||5;
			opt={};
		}else if(typeof(opt)=='number'){
			f=opt;
			opt={};
		}else{
			opt=opt||{};
			if('show' in opt){
				f=({hide:0,min:6,max:3})[opt.show]||5;
			}else if(opt.hide){
				f=0;
			}else if(opt.min){
				f=6;
			}else if(opt.max){
				f=3;
			}
		}
		ShellExecute(0,opr||null,file,opt.params||null,opt.workdir||null,f);
		return(true);
	}

	
	var Process=(new Class({},EventMixin,FindInstanceMixin,{
		__class__:{
			priority:new Enum({
				suspended:		0x04,
				idle:			0x40,
				belowNormal:	0x4000,
				normal:			0x20,
				aboveNormal:	0x8000,
				high:			0x80,
				realtime:		0x100,
			}),
			__firstInstances__:{},
			create:function(cmd,op){
				try{
					var show=(typeof(op)=='number')?op:((typeof(op)=='object')?((op.stdin||op.stdout||op.stderr||op.shareConsole)?0:(('show' in op)?op.show:1)):((typeof(op)=='undefined')?1:(op?1:0)));
					op=(typeof(op)=='object')?Object.extend({},op):{};
					
					var p=0x00000400|(op.priority||0);
					
					var hMain=Main.process.handle;
					var si=StartupInfo.alloc(), flags=0;
					var pi=ProcessInformation.alloc();
					
					si.cb=68;
					if(show){
						p|=0x00000010;
						flags|=0x1;
						si.showWindow=show;
						
						if(op.width||op.height){
							flags|=0x2;
							si.width=(typeof(op.width)!='undefined')?op.width:op.height;
							si.height=(typeof(op.height)!='undefined')?op.height:op.width;
						}
						if(op.x||op.y){
							flags|=0x4;
							si.x=op.x||0;
							si.y=op.y||0;
						}
						if(op.cols||op.rows){
							flags|=0x8;
							si.cols=(typeof(op.cols)!='undefined')?op.cols:op.rows;
							si.rows=(typeof(op.rows)!='undefined')?op.rows:op.cols;
						}
						if(('color' in op)||('bgcolor' in op)){
							si.attributes=({black:0x0,darkblue:0x1,darkgreen:0x2,darkcyan:0x3,darkred:0x4,darkmagenta:0x5,darkyellow:0x6,silver:0x7,
										gray:0x8,blue:0x9,green:0xA,cyan:0xB,red:0xC,magenta:0xD,yellow:0xE,white:0xF}[op.color||'white']
									|{black:0x00,darkblue:0x10,darkgreen:0x20,darkcyan:0x30,darkred:0x40,darkmagenta:0x50,darkyellow:0x60,silver:0x70,
										gray:0x80,blue:0x90,green:0xA0,cyan:0xB0,red:0xC0,magenta:0xD0,yellow:0xE0,white:0xF0}[op.bgcolor||'black']);
							flags|=0x10;
						}
					}else if(!op.shareConsole){
						flags|=0x101;
						var ir=new UInt.pointer(si.valueOf()+56);
						if(op.stdin==''){
							op.stdin=CreateFile('NUL',0xC0000000,3,null,3,0,0);
						}
						if(op.stdout==''){
							op.stdout=CreateFile('NUL',0xC0000000,3,null,3,0,0);
						}
						if(op.stderr==''){
							op.stderr=CreateFile('NUL',0xC0000000,3,null,3,0,0);
						}
						if(op.stdin){
							DuplicateHandle(hMain,op.stdin.stdout?op.stdin.stdout.handle:(op.stdin.handle||((typeof(op.stdin)!='number')?(cwd().file(op.stdin).openRead().handle):op.stdin)) ,hMain,ir,0,1,(op.shareStream || op.shareStdin)?2:3);
						}else{
							var iw=UInt.alloc();
							CreatePipe(ir,iw,null,0);
							DuplicateHandle(hMain,ir.item(),hMain,ir,0,1,3);
						}
						var ow=new UInt.pointer(si.valueOf()+60);
						if(op.stdout){
							DuplicateHandle(hMain,op.stdout.stdin?op.stdout.stdin.handle:(op.stdout.handle||((typeof(op.stdout)!='number')?(cwd().file(op.stdout)).openWrite().handle:op.stdout)) ,hMain,ow,0,1,(op.shareStream || op.shareStdout)?2:3);
						}else{
							var or=UInt.alloc();
							CreatePipe(or,ow,null,0);
							DuplicateHandle(hMain,ow.item(),hMain,ow,0,1,3);
						}
						var ew=new UInt.pointer(si.valueOf()+64);
						if(op.stderr){
							DuplicateHandle(hMain,op.stderr.stdin?op.stderr.stdin.handle:(op.stderr.handle||((typeof(op.stderr)!='number')?(cwd().file(op.stderr)).openWrite().handle:op.stderr)) ,hMain,ew,0,0,(op.shareStream || op.shareStderr)?2:3);
						}else{
							var er=UInt.alloc();
							CreatePipe(er,ew,null,0);
							DuplicateHandle(hMain,ew.item(),hMain,ew,0,0,3);
						}
					}
					si.flags=flags;
					
					if(0!=(op.password?CreateProcessWithLogon(op.user,op.domain||System.computer.name,op.password,op.logonFlags||0
																,null,cmd,p,0,op.workdir||null,si,pi)
									:CreateProcess(null,cmd,null,null,1,p ,0,op.workdir||null,si,pi))
					){
						if(!show && !op.shareConsole){
							CloseHandle(ow.item());
							CloseHandle(ew.item());
							CloseHandle(ir.item());
						}
						var res=new this(pi.processId,pi.hProcess, new Thread(pi.threadId,pi.hThread));
						if(('stdin' in op)&&!op.stdin){
							CloseHandle(iw.item());
						}else if(iw){
							res.stdin=new FileStream(iw.item());
							res.stdin.encoding=op.encoding||MBString.defaultCodepage;
						}
						if(('stdout' in op)&&!op.stdout){
							CloseHandle(or.item());
						}else if(or){
							res.stdout=new FileStream(or.item());
							res.stdout.encoding=op.encoding||MBString.defaultCodepage;
						}
						if(('stderr' in op)&&!op.stderr){
							CloseHandle(er.item());
						}else if(er){
							res.stderr=new FileStream(er.item());
							res.stderr.encoding=op.encoding||MBString.defaultCodepage;
						}
						if(op.free){
							res.free();
						}else if(op.noHandle){
							CloseHandle(pi.hProcess);
							CloseHandle(pi.hThread);
							res.handle=null;
							res.__mainThread__.handle=null;
						}
						
						return(res);
					}else if(!show){
						ir&&CloseHandle(ir.item());
						ow&&CloseHandle(ow.item());
						ew&&CloseHandle(ew.item());
						iw&&CloseHandle(iw.item());
						or&&CloseHandle(or.item());
						er&&CloseHandle(er.item());
					}
				}finally{
					si	&&	si.free();
					pi	&&	pi.free();
					iw	&&	iw.free();
					or	&&	or.free();
					er	&&	er.free();
				}
			},
			
			get all(){
				try{
					var s=ProcessEntry32.alloc();
					var h=CreateToolhelp32Snapshot(2,0);
					s.cb=556;
					Process32First(h,s);
					do{
						yield(Object.extend(new this(s.processID),{
							__parentPID__:s.parentPID,
						}));
					}while(Process32Next(h,s));
				}catch(e if e.code==18){
				}finally{
					s&&s.free();
					h&&CloseHandle(h);
				}
			},
		},
		
		waitExit:function(to)(this.waitForExit(to)),
		waitForExit:function(timeout){
			try{
				var h=OpenProcess(0x00100000,0,this.id);
				return((0==WaitForSingleObject(h,(typeof(timeout)=='undefined')?0xFFFFFFFF:timeout))&&this.exitCode);
			}finally{
				h&&CloseHandle(h);
			}
		},
		__observe__:function(name){
			if((name=='exit') && !this.__waitExitThread__){
				var sig=new Signal();
				this.__waitExitThread__=Thread.create(function(p){
					try{
						var h=p.handle||OpenProcess(0x00100000,0,p.id);
						var buf=UInt.alloc(2).update([h,sig.handle]);
						var func=function()(p.unobserveAll());
						Main.reside();
						Main.observe('exit',func);
						if(WaitForMultipleObjects(2,buf,0,0xFFFFFFFF)==0){
							p.fire('exit');
						}
						Main.unreside();
						Main.unobserve('exit',func);
					}finally{
						if(h!=p.handle){
							CloseHandle(h);
						}
						sig&&sig.free();
						buf&&buf.free();
					}
				},[this]);
				this.__waitExitThread__.signal=sig;
			}
		},
		__unobserveLast__:function(){
			if(this.__waitExitThread__){
				this.__waitExitThread__.signal.turnOn();
				this.__waitExitThread__.waitExit();
				this.__waitExitThread__.free();
				this.__waitExitThread__=null;
			}
		},
		
		get __instanceText__()(this.commandline),
		get __instanceName__()(this.name),
		
		__new__:function(id,handle,thread){
			this.__instanceIdentifier__=this.id=(typeof(id)!='undefined')?id:GetProcessId(handle);
			this.handle=handle||void(0);
			this.__mainThread__=thread;
		},
		free:function(){
			if(this.handle){
				CloseHandle(this.handle);
			}
			if(this.__mainThread__){
				this.__mainThread__.free();
			}
			this.stdin	&&	this.stdin.free();
			this.stdout	&&	this.stdout.free();
			this.stderr	&&	this.stderr.free();
		},
		
		get exitCode()(this.result),
		get result(){
			try{
				if(!this.__result__){
					var h=OpenProcess(0x400,0,this.id);
					var v=UInt.alloc();
					GetExitCodeProcess(h,v);
					if(v.item()==259){
						this.__result__="";
					}else{
						this.__result__=v.item();
					}
				}
				return(this.__result__);
			}catch(e){
			}finally{
				h&&CloseHandle(h);
				v&&v.free();
			}
		},
		
		get exists(){
			if(typeof(this.result)=='undefined'){
				try{
					var s=ProcessEntry32.alloc();
					var h=CreateToolhelp32Snapshot(2,0);
					s.cb=556;
					Process32First(h,s);
					do{
						if(s.processID==this.id){
							return(true);
						}
					}while(Process32Next(h,s));
				}catch(e){
				}finally{
					s&&s.free();
					h&&CloseHandle(h);
				}
			}else{
				return(typeof(this.result)!='number');
			}
		},
		
		get priority(){
			try{
				var h=OpenProcess(0x400,0,this.id);
				return(GetPriorityClass(h));
			}catch(e){
			}finally{
				h&&CloseHandle(h);
			}
		},
		set priority(v){
			try{
				var h=OpenProcess(0x0200,0,this.id);
				SetPriorityClass(h,(typeof(v)=='number')?v:Process.priority.getValue(v));
				return(true);
			}catch(e){
				return(false);
			}finally{
				h&&CloseHandle(h);
			}
		},
		
		terminate:function(code){
			try{
				var h=OpenProcess(0x1,0,this.id);
				TerminateProcess(h,code||0);
				return(true);
			}catch(e){
				return(false);
			}finally{
				h&&CloseHandle(h);
			}
		},
		
		read:function()(this.stdout.read.apply(this.stdout,arguments)),
		readln:function()(this.stdout.readLine.apply(this.stdout,arguments)),
		readText:function()(this.stdout.readText.apply(this.stdout,arguments)),
		readAll:function()(this.stdout.readAll.apply(this.stdout,arguments)),
		write:function()(this.stdin.write.apply(this.stdin,arguments)),
		writeln:function()(this.stdin.writeLine.apply(this.stdin,arguments)),
		get eof()(this.stdout.eof),
		get encoding()(this.stdout&&(this.stdout.encoding||this.stdout.detectedEncoding)),
		set encoding(e)(this.stderr.encoding=this.stdout.encoding=this.stdin.encoding=e),
		
		
		close:function(){
			this.stdin && this.stdin.free();
			this.stdin=null;
		},
		
		
		getInformationBySnapshot:function(name){
			try{
				var s=ProcessEntry32.alloc();
				var h=CreateToolhelp32Snapshot(2,0);
				s.cb=556;
				Process32First(h,s);
				do{
					if(s.processID==this.id){
						return(name=='fileName'?(s[name].toString()):(s[name]*1));
					}
				}while(Process32Next(h,s));
			}catch(e){
			}finally{
				s&&s.free();
				h&&CloseHandle(h);
			}
		},
		get threads(){
			try{
				var s=ThreadEntry32.alloc();
				var h=CreateToolhelp32Snapshot(4,0);
				s.cb=28;
				Thread32First(h,s);
				do{
					if(s.ownerPID==this.id){
						yield(new Thread(s.threadId));
					}
				}while(Thread32Next(h,s));
			}catch(e){
			}finally{
				s&&s.free();
				h&&CloseHandle(h);
			}
		},
		get threadsCount()(this.getInformationBySnapshot('threadsCount')),
		
		get parent()(new Process(this.__parentPID__||this.getInformationBySnapshot('parentPID'))),
		get file(){
			try{
				var h=OpenProcess(0x410,0,this.id);
				var b=WChar.alloc(1024);
				GetModuleFileNameEx(h,0,b,1024);
				return(new File(b.toString()));
			}catch(e){
			}finally{
				h&&CloseHandle(h);
				b&&b.free();
			}
		},
		get name(){
			try{
				var h=OpenProcess(0x410,0,this.id);
				var b=WChar.alloc(261);
				GetModuleBaseName(h,0,b,260);
				return(b.toString());
			}catch(e){
				return(this.getInformationBySnapshot('fileName'));
			}finally{
				h&&CloseHandle(h);
				b&&b.free();
			}
		},
		get commandline(){
			try{
				var h=OpenProcess(0x10,0,this.id);
				var p=UInt.alloc();
				var b=WChar.alloc(1024);
				if(ReadProcessMemory(h,addrCommandLine,p,4,null)&&ReadProcessMemory(h,p.item(),b,2044,null)){
					return(b.toString());
				}
			}catch(e){
			}finally{
				h&&CloseHandle(h);
				p&&p.free();
				b&&b.free();
			}
		},
		
		get memoryInfo(){
			try{
				var h=OpenProcess(0x400,0,this.id);
				var b=ProcessMemoryCounters.alloc();
				b.cb=44;
				GetProcessMemoryInfo(h,b,44);
				return(b.toObject());
			}catch(e){
				return({
					pageFaultCount:				void(0),
					peakWorkingSetSize:			void(0),
					workingSetSize:				void(0),
					quotaPeakPagedPoolUsage:	void(0),
					quotaPagedPoolUsage:		void(0),
					quotaPeakNonPagedPoolUsage:	void(0),
					quotaNonPagedPoolUsage:		void(0),
					pagefileUsage:				void(0),
					peakPagefileUsage:			void(0),
					privateUsage:				void(0),
				});
			}finally{
				h&&CloseHandle(h);
				b&&b.free();
			}
		},
		get pageFaultCount()			(this.memoryInfo.pageFaultCount),
		get peakWorkingSetSize()		(this.memoryInfo.peakWorkingSetSize),
		get workingSetSize()			(this.memoryInfo.workingSetSize),
		get quotaPeakPagedPoolUsage()	(this.memoryInfo.quotaPeakPagedPoolUsage),
		get quotaPagedPoolUsage()		(this.memoryInfo.quotaPagedPoolUsage),
		get quotaPeakNonPagedPoolUsage()(this.memoryInfo.quotaPeakNonPagedPoolUsage),
		get quotaNonPagedPoolUsage()	(this.memoryInfo.quotaNonPagedPoolUsage),
		get pagefileUsage()				(this.memoryInfo.pagefileUsage),
		get peakPagefileUsage()			(this.memoryInfo.peakPagefileUsage),
		get privateUsage()				(this.memoryInfo.privateUsage),
		
		allocMemory:function(size){
			try{
				var h=OpenProcess(0x8,0,this.id);
				return(VirtualAllocEx(h,0,size,0x1000,0x40));
			}catch(e){
			}finally{
				h&&CloseHandle(h);
			}
		},
		freeMemory:function(address){
			try{
				var h=OpenProcess(0x8,0,this.id);
				VirtualFreeEx(h,address,0,0x8000);
				return(this);
			}finally{
				h&&CloseHandle(h);
			}
		},
		readMemory:function(address,type,count){
			var f,e;
			type=type||[UInt];
			if(type instanceof Array){
				f=true;
				type=type[0];
			}
			if(typeof(type)=='string'){
				if(!type.match(/^(?:unicode)?$/i)){
					e=type;
					type=Byte;
				}else{
					type=WChar;
				}
				f=true;
			}else if(typeof(type)=='number'){
				count=type;
				type=Byte;
			}
			type=type.entity||type;
			try{
				var h=OpenProcess(0x10,0,this.id);
				var b=type.alloc(count||1);
				ReadProcessMemory(h,address,b,type.size*(count||1),null);
				e&&(b.encoding=e);
				return(f?b.convert():b);
			}finally{
				h&&CloseHandle(h);
			}
		},
		writeMemory:function(obj,address){
			try{
				var buf,src,len,dest;
				if(obj instanceof Array){
					if(obj.length>1){
						buf=obj[0].alloc((obj[1] instanceof Array)?obj[1].length:1).update(obj[1]);
						src=buf.valueOf();
						len=obj[0].size*(buf.count||1);
					}else{
						buf=obj[0];
						src=buf.valueOf();
						len=let(l=buf.length,s=buf.constructor.entity.size)(l?(l*s):(buf.size||buf.count*s||s||1));
					}
				}else if(obj instanceof Pointer){
					src=obj.valueOf();
					len=let(l=obj.length,s=obj.constructor.entity.size)(l?(l*s):(obj.size||obj.count*s||s||1));
				}else{
					buf=MBString.from(obj,this.encoding||this.detectedEncoding||MBString.defaultCodepage);
					src=buf.valueOf();
					len=buf.length;
				}
				dest=address || this.allocMemory(len);
				var h=OpenProcess(0x28,0,this.id);
				var c=UInt.alloc();
				WriteProcessMemory(h,dest,src,len,c);
				return(c.item());
			}finally{
				buf && buf.free();
				c   && c.free();
				h   && CloseHandle(h);
			}
		},
		createThread:function(addr,param,suspended){
			try{
				var h=OpenProcess(0x43A,0,this.id);
				var t=UInt.alloc();
				return(new Thread(CreateRemoteThread(h,null,0,addr,param,suspended?4:0,t),t.item()));
			}finally{
				h&&CloseHandle(h);
				t&&t.free();
			}
		},
	}));
	
	
	
	
	var Thread=(new Class({},EventMixin,{
		__class__:{
			__firstInstances__:{},
			priority:new Enum({
				idle:			-15,
				low:			-2,
				belowNormal:	-1,
				normal:			0,
				aboveNormal:	1,
				high:			2,
				critical:		15,
			}),
			get current(){
				var id=GetCurrentThreadId();
				return((this.__instances__||{})[id]||new this(id));
			},
			
			reside:function(e,f){
			},
			unreside:function(e,f){
			},
			
			
			__gc__:function(){
				try{
					this.__gcMutex__.lock();
					if(this.__countToGC__>32){
						var o=this.__instances__||{};
						for(let [id,item] in Iterator(o)){
							if(!item.exists){
								item.__startRoutine__.free();
								item.free();
								delete(o[id]);
							}
						}
						this.__countToGC__=0;
					}
				}finally{
					this.__gcMutex__.unlock();
				}
			},
			__countToGC__:0,
			create:function(func,params,suspended)(this.__create__(func,params,suspended)),
			__create__:function(f,p,suspended){
				try{
					var p2=$A(p);
					var func=f;
					var func2=function(){
						try{
							(func||Function.doNothing).apply(res,p2);
						}catch(e){
							res.exception=e;
						}finally{
							try{
								res.fire('exit');
								Thread.__gc__();
							}catch(e){
							}
						}
					};
					var fp=ThreadStartRoutine.from(func2);
					var t=UInt.alloc();
					var th=CreateThread(null,0,fp,0,4,t);
					var res=new Thread(t.item(),th);
					res.__executedFunction__=func;
					res.__startRoutineOriginalFunction__=func2;
					res.__startRoutine__=fp;
					res.__params__=p2;
					(Thread.__instances__||(Thread.__instances__={}))[res.id]=res;
					if(!suspended){
						res.resume();
					}
					return(res);
				}finally{
					t&&t.free();
				}
			},
		},
		
		
		__new__:function(id,handle){
			this.__instanceIdentifier__=this.id=((typeof(id)!='undefined')?id:GetThreadId(handle));
			this.handle=handle||void(0);
		},
		free:function(){
			this.handle&&CloseHandle(this.handle);
			this.handle=null;
		},
		
		get exitCode()(this.result),
		get result(){
			try{
				if(!this.__result__){
					var h=OpenThread(0x40,0,this.id);
					var v=UInt.alloc();
					GetExitCodeThread(h,v);
					if(v.item()==259){
						this.__result__="";
					}else{
						this.__result__=v.item();
					}
				}
				return(this.__result__);
			}catch(e){
			}finally{
				h&&CloseHandle(h);
				v&&v.free();
			}
		},
		__observe__:function(name,un){
			if(un){
			}else if(name!='exit'){
			}else if(this.__startRoutine__){
			}else if(!this.__waitExitThread__){
				var sig=new Signal();
				this.__waitExitThread__=Thread.create(function(t){
					try{
						var h=p.handle||OpenThread(0x00100000,0,t.id);
						var buf=UInt.alloc(2).update([h,sig.handle]);
						var func=function()(p.unobserveAll());
						Main.reside();
						Main.observe('exit',func);
						if(WaitForMultipleObjects(2,buf,0,0xFFFFFFFF)==0){
							p.fire('exit');
						}
						Main.unreside();
						Main.unobserve('exit',func);
					}finally{
						if(h!=p.handle){
							CloseHandle(h);
						}
						sig&&sig.free();
						buf&&buf.free();
					}
				},[this]);
				this.__waitExitThread__.signal=sig;
			}
		},
		__unobserveLast__:function(){
			if(this.__waitExitThread__){
				this.__waitExitThread__.signal.turnOn();
				this.__waitExitThread__.waitExit();
				this.__waitExitThread__.free();
				this.__waitExitThread__=null;
			}
		},
		waitExit:function(to)(this.waitForExit(to)),
		waitForExit:function(timeout){
			try{
				var h=OpenThread(0x00100000,0,this.id);
				return((0==WaitForSingleObject(h,(typeof(timeout)=='undefined')?0xFFFFFFFF:timeout))&&this.exitCode);
			}finally{
				h&&CloseHandle(h);
			}
		},
		get exists(){
			if(!this.id){
				return(false);
			}
			switch(typeof(this.result)){
				case('number'):return(false);
				case('string'):return(true);
				default:return(typeof(this.getInformationBySnapshot('threadId'))!='undefined');
			}
		},
		
		get priority(){
			try{
				var h=OpenThread(0x40,0,this.id);
				return(GetThreadPriority(h));
			}catch(e){
			}finally{
				h&&CloseHandle(h);
			}
		},
		set priority(v){
			try{
				var h=OpenThread(0x020,0,this.id);
				SetThreadPriority(h,(typeof(v)=='number')?v:Thread.priority.getValue(v));
			}catch(e){
			}finally{
				h&&CloseHandle(h);
			}
		},
		getInformationBySnapshot:function(name){
			try{
				var s=ThreadEntry32.alloc();
				var h=CreateToolhelp32Snapshot(4,0);
				s.cb=28;
				Thread32First(h,s);
				do{
					if(s.threadId==this.id){
						return(s[name]);
					}
				}while(Thread32Next(h,s));
			}catch(e){
			}finally{
				s&&s.free();
				h&&CloseHandle(h);
			}
		},
		owner:function()(new Process(this.getInformationBySnapshot('ownerPID'))),
		
		get startAddress(){
			if(this.__startRoutine__){
				return(this.__startRoutine__.valueOf());
			}
			try{
				var h=OpenThread(0x40,0,this.id);
				var v=UInt.alloc();
				var s=UInt.alloc();
				NtQueryInformationThread(h,9,v,4,s);
				return(v.item());
			}catch(e){
			}finally{
				h&&CloseHandle(h);
				v&&v.free();
				s&&s.free();
			}
		},
		
		suspend:function(){
			try{
				var h=OpenThread(2,0,this.id);
				SuspendThread(h);
				return(true);
			}catch(e){
				return(false);
			}finally{
				h&&CloseHandle(h);
			}
		},
		resume:function(){
			try{
				var h=OpenThread(2,0,this.id);
				ResumeThread(h);
				return(true);
			}catch(e){
				return(false);
			}finally{
				h&&CloseHandle(h);
			}
		},
		terminate:function(code){
			try{
				var h=OpenThread(1,0,this.id);
				TerminateThread(h,code||0);
				return(true);
			}catch(e){
				return(false);
			}finally{
				h&&CloseHandle(h);
			}
		},
		
		
	}));
}


let(
	validateName=		function(name)(name.slice(-255).replace(/\\/g,"/")),
	
	CreateEvent=		kernel32.proc('CreateEventW',[Pointer,UInt,UInt,WideString],UInt),
	OpenEvent=			kernel32.proc('OpenEventW',[UInt,Int,WideString],UInt),
	SetEvent=			kernel32.proc('SetEvent',[UInt],UInt),
	ResetEvent=			kernel32.proc('ResetEvent',[UInt],UInt),
	PulseEvent=			kernel32.proc('PulseEvent',[UInt],UInt),
	CreateMutex=		kernel32.proc('CreateMutexW',[Pointer,Int,WideString],Int),
	ReleaseMutex=		kernel32.proc('ReleaseMutex',[UInt],Int),
	
	CreateSemaphore=	kernel32.proc('CreateSemaphoreW',[Pointer,UInt,UInt,WideString],Int),
	ReleaseSemaphore=	kernel32.proc('ReleaseSemaphore',[UInt,UInt,Pointer],Int),
	
	CreateWaitableTimer=kernel32.proc('CreateWaitableTimerW',[Pointer,Int,WideString],Int),
	SetWaitableTimer=	kernel32.proc('SetWaitableTimer',[UInt,Pointer,UInt,Pointer,UInt,Int],Int),
	CancelWaitableTimer=kernel32.proc('CancelWaitableTimer',[UInt],Int),
	GetCurrentThreadId=	kernel32.proc('GetCurrentThreadId',[],UInt),
	
	MsgWaitForMultipleObjects=user32.proc('MsgWaitForMultipleObjects',[UInt,Pointer,UInt,UInt,UInt],UInt),
	PeekMessage=			user32.proc("PeekMessageW",[Pointer,UInt,UInt,UInt,UInt],Int),
	TranslateMessage=		user32.proc('TranslateMessage',[Pointer],Int),
	DispatchMessage=		user32.proc('DispatchMessageW',[Pointer],Int),
	PostThreadMessage=		user32.proc('PostQuitMessage',[UInt,UInt,UInt,UInt],Int),
	
	SignalObjectAndWait=kernel32.proc('SignalObjectAndWait',[UInt,UInt,UInt,Int],Int),
	__WaitForMultipleObjects=kernel32.proc('WaitForMultipleObjects',[UInt,Pointer,UInt,UInt],UInt),
//	WaitForSingleObject=kernel32.proc('WaitForSingleObject',[UInt,UInt],UInt),
	CloseHandle=		kernel32.proc('CloseHandle',[UInt],UInt)
){
	let MSG=new Struct({
		hwnd:		UInt,
		message:	UInt,
		wParam:		UInt,
		lParam:		UInt,
		time:		UInt,
		x:			Int,
		y:			Int,
	});
	
	
	let WaitForMultipleObjects=function(c,a,f,t){
		try{
			var msg, a2,rr, thread, ex=(new Date()).getTime()+t;
			if(f && (c>1)){
				let cc=c, aa=a, tt=t;
				thread=Thread.create(function(){
					rr=__WaitForMultipleObjects(cc,aa,1,tt);
				});
				c=1;
				a=a2=UInt.alloc().update(thread.handle);
				t=0xFFFFFFFF;
			}
			while(true){
				var r=MsgWaitForMultipleObjects(c,a,0,((t==0xFFFFFFFF)?t:Math.max(0,ex-(new Date()).getTime())),0x4FF);
				if(r==c){
					msg=msg||MSG.alloc();
					while(PeekMessage(msg,0,0,0,1)){
						TranslateMessage(msg);
						DispatchMessage(msg);
					}
				}else{
					return(f?rr:r);
				}
			}
		}finally{
			free(msg,a2);
		}
		
	};
	
	let WaitForSingleObject=function(h,t){
		try{
			var a=UInt.alloc().update(h);
			return(WaitForMultipleObjects(1,a,0,t));
		}finally{
			free(a);
		}
	};
	
	
	var Semaphore=new Class({
		__new__:function(name,maxCount,count){
			this.name=name?validateName(name):null;
			this.maxCount=maxCount||1;
			this.handle=CreateSemaphore(null,(typeof(count)=='undefined')?this.maxCount:count,this.maxCount,this.name);
		},
		inc:function(count)(ReleaseSemaphore(this.handle,count,null)),
		
		lock:function(timeout)(this.locked=(0==WaitForSingleObject(this.handle,(typeof(timeout)=='undefined')?0xFFFFFFFF:timeout))),
		unlock:function(){
			if(this.locked){
				ReleaseSemaphore(this.handle,1,null);
				this.locked=false;
			}
		},
		free:function(){
			if(this.handle){
				if(this.locked){
					this.free();
				}
				CloseHandle(this.handle);
				this.handle=null;
			}
		},
	});
	var Mutex=new Class({
		__class__:{
			handle:CreateMutex(null,0,this.name),
			lockCount:0,
			lock:function(timeout){
				var res=WaitForSingleObject(this.handle,(typeof(timeout)=='undefined')?0xFFFFFFFF:timeout);
				if((res==0)||(res==128)){
					this.lockCount++;
					this.__ownerThreadId__=GetCurrentThreadId();
					return(true);
				}else{
					return(false);
				}
			},
			unlock:function(){
				if((this.__ownerThreadId__==GetCurrentThreadId()) && (this.lockCount>0)){
					this.lockCount--;
					if(this.lockCount==0){
						this.__ownerThreadId__=0;
					}
					ReleaseMutex(this.handle);
				}
			},
			
			waitFor:function(a,all,timeout){
				try{
					var buf=UInt.alloc(a.length);
					var l=a.length;
					for(var i=0;i<l;i++){
						if(!a[i].handle){
							throw(new Error("arguments error(waitFor): unwaitable object"));
						}
						buf.inc(i).update(a[i].handle);
					}
					var res=WaitForMultipleObjects(l,buf,all?1:0,(typeof(timeout)=='undefined')?0xFFFFFFFF:timeout);
					if(res==0x102){
						return(false);
					}else{
						res=res&0x7F;
						if(all){
							for(var i=0;i<l;i++){
								if(a[i] instanceof Mutex){
									a[i].__ownerThreadId__=GetCurrentThreadId();
									a[i].lockCount++;
								}
							}
							return(true);
						}else{
							if(a[res] instanceof Mutex){
								a[res].lockCount++;
								a[res].__ownerThreadId__=GetCurrentThreadId();
							}
							return(a[res]);
						}
					}
				}finally{
					buf&&buf.free();
				}
			},
		},
		__new__:function(name){
			this.name=name?validateName(name):null;
			this.handle=CreateMutex(null,0,this.name);
			this.lockCount=0;
		},
		get locked()(this.__ownerThreadId__),
		
		lock:function(timeout){
			var res=WaitForSingleObject(this.handle,(typeof(timeout)=='undefined')?0xFFFFFFFF:timeout);
			if((res==0)||(res==128)){
				this.lockCount++;
				this.__ownerThreadId__=GetCurrentThreadId();
				return(true);
			}else{
				return(false);
			}
		},
		unlock:function(){
			if((this.__ownerThreadId__==GetCurrentThreadId()) && (this.lockCount>0)){
				this.lockCount--;
				if(this.lockCount==0){
					this.__ownerThreadId__=0;
				}
				ReleaseMutex(this.handle);
			}
		},
		unlockAndWait:function(obj,timeout){
			if(!obj.handle){
				return(this.unlock());
			}else{
				if((this.__ownerThreadId__==GetCurrentThreadId()) && (this.lockCount>0)){
					if(this.lockCount>1){
						throw(new Error("disallowed mutex operation: unlockAndWait while lockCount>1"));
					}
					this.__ownerThreadId__=0;
					this.lockCount--;
					var res=SignalObjectAndWait(this.handle,obj.handle,(typeof(timeout)=='undefined')?0xFFFFFFFF:timeout,0);
					if((res==0)||(res==128)){
						if(obj instanceof Mutex){
							obj.lockCount++;
							obj.__ownerThreadId__=GetCurrentThreadId();
						}
						return(true);
					}else{
						return(false);
					}
				}
			}
		},
		
		free:function(){
			if(this.handle){
				if(this.__ownerThreadId__==GetCurrentThreadId()){
					while(this.lockCount>0){
						this.unlock();
					}
				}
				CloseHandle(this.handle);
				this.handle=null;
			}
		},
	});
	
	var LockableMixin=new Class({
		__class__:{
			lock:function(){
				if(!this.__mutex__){
					Mutex.lock();
					if(!this.__mutex__){
						this.__mutex__=new Mutex();
					}
					Mutex.unlock();
				}
				return(this.__mutex__.lock(timeout));
			},
			unlock:function(){
				if(this.__mutex__ && this.__mutex__.locked){
					this.__mutex__.unlock();
				}
			},
			__exclusivize__:function(f)((typeof(f)=='function')?function(){
				try{
					return(f.apply(this,arguments));
				}finally{
					this.unlock();
				}
			}:f),
			addExclusiveMethods:function(m){
				if(m.__class__){
					var c=m.__class__;
					for(let n in c){
						let g=c.__lookupGetter__(n),s=c.__lookupSetter__(n);
						if(g){
							c.__defineGetter__(n,this.__exclusivize__(g));
							if(s){
								c.__defineSetter__(n,this.__exclusivize__(s));
							}
						}else{
							c[n]=this.__exclusivize__(c[n]);
						}
					}
				}
				for(let n in m){
					if(n!='__class__'){
						let g=m.__lookupGetter__(n),s=m.__lookupSetter__(n);
						if(g){
							m.__defineGetter__(n,this.__exclusivize__(g));
							if(s){
								m.__defineSetter__(n,this.__exclusivize__(s));
							}
						}else{
							m[n]=this.__exclusivize__(m[n]);
						}
					}
				}
				return(this.addMembers(m));
			},
		},
		__freeMutex__:function(){
			this.__mutex__&&this.__mutex__.free();
		},
		lock:function(timeout){
			if(!this.__mutex__){
				Mutex.lock();
				if(!this.__mutex__){
					this.__mutex__=new Mutex();
				}
				Mutex.unlock();
			}
			return(this.__mutex__.lock(timeout));
		},
		unlock:function(){
			if(this.__mutex__ && this.__mutex__.locked){
				this.__mutex__.unlock();
			}
		},
	});
	
	
	var Signal=new Class({
		__class__:{
			waitFor:Mutex.waitFor,
			turnOn:function(name){
				try{
					var h=OpenEvent(2,0,validateName(name));
					return(SetEvent(h)!=0);
				}catch(e){
					return(false);
				}finally{
					h && CloseHandle(h);
				}
			},
			turnOff:function(name){
				try{
					var h=OpenEvent(2,0,validateName(name));
					return(ResetEvent(h)!=0);
				}catch(e){
					return(false);
				}finally{
					h && CloseHandle(h);
				}
			},
			pulse:function(name){
				try{
					var h=OpenEvent(2,0,validateName(name));
					return(PulseEvent(h)!=0);
				}catch(e){
					return(false);
				}finally{
					h && CloseHandle(h);
				}
			},
		},
		__new__:function(name,autoReset){
			this.name=name?validateName(name):null;
			this.autoReset=!!autoReset
			try{
				this.handle=CreateEvent(null,autoReset?0:1, 0,this.name);
			}catch(e if e.code==183){
				this.handle=e.result;
			}
		},
		wait:function(timeout)(0==WaitForSingleObject(this.handle,(typeof(timeout)=='undefined')?0xFFFFFFFF:timeout)),
		turnOn:function()(SetEvent(this.handle)),
		turnOff:function()(ResetEvent(this.handle)),
		pulse:function()(PulseEvent(this.handle)),
		turnOnAndWait:function(obj,timeout){
			if(!obj.handle){
				throw(new Error("argument error(turnOnAndWait): unwaitable object"));
			}
			var res=SignalObjectAndWait(this.handle,obj.handle,(typeof(timeout)=='undefined')?0xFFFFFFFF:timeout,0);
			if((res==0)||(res==128)){
				if(obj instanceof Mutex){
					obj.lockCount++;
					obj.__ownerThreadId__=GetCurrentThreadId();
				}
				return(true);
			}else{
				return(false);
			}
		},
		free:function(){
			this.handle && CloseHandle(this.handle);
			this.handle=null;
		},
	});
	var Timer=new Class({
		__new__:function(func,interval,onlyOnce,useResume){
			if(interval instanceof Date){
				interval=Math.max(0,interval.getTime()-(new Date()).getTime());
				onlyOnce=true;
			}
			if(!func){
				func=Function.doNothing;
			}else if(typeof(func)!='function'){
				let f=func;
				func=function()(eval(f));
			}
			this.procedure=func;
			this.interval=interval;
			this.onlyOnce=onlyOnce;
			this.useResume=useResume;
		},
		run:function(){
			if(this.running){
				return(this);
			}
			var sig=new Signal();
			this.__thread__=Thread.create(function(timer){
				try{
					try{
						
						timer.handle=CreateWaitableTimer(null,0,null);
						var date=new Date();
						date.setTime(date.getTime()+timer.interval);
						var ft=UInt.alloc(2);
						var t=Math.pow(2,52)-timer.interval*10000;
						ft.update(0|t);
						ft.inc(1).update(0xFFF00000|Math.floor(t/0x100000000));
						SetWaitableTimer(timer.handle,ft,timer.onlyOnce?0:timer.interval,null,null,timer.useResume?1:0);
					}catch(e if e.code==50){
						timer.useResume=false;
					}finally{
						ft&&ft.free();
					}
					var sig2=timer.__stopSignal__=new Signal();
					var ary=UInt.alloc(2);
					ary.update(timer.handle);
					ary.inc(1).update(sig2.handle);
					
					timer.running=true;
					Main.reside();
					sig.turnOn();
					while(true){
						if(!timer.running ||(0!=__WaitForMultipleObjects(2,ary,0,0xFFFFFFFF))){
							break;
						}
						timer.executing=true;
						if(timer.procedure()){
							break;
						}
						timer.executing=false;
						if(timer.onlyOnce){
							break;
						}
					}
				}finally{
					ary.free();
					sig2.free();
					timer.__stopSignal__=null;
					timer.executing=false;
					timer.running=false;
					if(timer.handle){
						CancelWaitableTimer(timer.handle);
						CloseHandle(timer.handle);
						timer.handle=null;
					}
					Main.unreside();
				}
			},[this]);
			
			sig.wait();
			sig.free();
			return(this);
		},
		stop:function(){
			if(this.__thread__){
				if(GetCurrentThreadId()==this.__thread__.id){
					throw(arguments.callee);
				}else{
					this.__stopSignal__.turnOn();
					this.__thread__.waitForExit();
				}
				this.__thread__=null;
			}
			return(this);
		},
		free:function(){
			this.stop();
/*
			if(this.handle){
				if(GetCurrentThreadId()==this.__thread__.id){
					throw(arguments.callee);
				}else if(this.executing){
					while(this.__thread__.exists){
						sleep(20);
					}
				}else{
					this.__thread__.terminate();
					CancelWaitableTimer(this.handle);
					CloseHandle(this.handle);
					this.handle=null;
				}
			}
*/
		},
	});
	
	Thread.__gcMutex__=new Mutex();
	Thread.__countToGC__=0;
}


var CommandReceiverMixin=new Class({},LockableMixin,{
	__class__:{
		__minCommandID__:1,
		__maxCommandID__:0xFFFFFFFF,
		addCommands:function(commands){
			this.hasOwnProperty('__commands__')||(this.__commands__=Object.extend({},this.__commands__||{}));
			for each(let [n,v] in Iterator(commands)){
				if(typeof(v)=='function'){
					v={name:n,action:v};
				}else if(typeof(v)=='boolean'){
					v={name:n,active:v};
				}else if(typeof(v)=='string'){
					v={name:n,group:v};
				}else if(v instanceof Array){
					v={name:n,items:v};
				}else if(!v.name){
					v.name=n;
				}
				this.__commands__[n]=(v instanceof Command)?v:(new Command(v));
			}
			return(this);
		},
	},
	addCommands:function(commands){
		this.__commands__||(this.__commands__={});
		for each(let [n,v] in Iterator(commands||{})){
			if(typeof(v)=='function'){
				v={name:n,action:v};
			}else if(typeof(v)=='boolean'){
				v={name:n,active:v};
			}else if(typeof(v)=='string'){
				v={name:n,group:v};
			}else if(v instanceof Array){
				v={name:n,items:v};
			}else if(!v.name){
				v.name=n;
			}
			this.__commands__[n]=(v instanceof Command)?v.bind(this):(new Command(v,this));
		}
		return(this);
	},
	getCommandByID:function(id)((this.__commandByID__||{})[id]),
	getSelection:function(group)((this.__commandSelectionByGroup__||{})[group]),
	executeCommand:function(name,params)(((typeof(name)=='number')?this.getCommandByID(name):this.getCommand(name)).execute(params)),
}).addExclusiveMethods({
	getCommand:function(name){
		this.__commands__||					(this.__commands__={});
		this.__commandByID__||				(this.__commandByID__={});
		this.__commandSelectionByGroup__||	(this.__commandSelectionByGroup__={});
		this.__idsByCommand__||				(this.__idsByCommand__={});
		var cmd=(typeof(name)=='number')?this.__commandByID__[name]:this.__commands__[name];
		if(!cmd){
			if(!(cmd=(this.constructor.__commands__||{})[name])){
				return(void(0));
			}
			cmd=this.__commands__[name]=cmd.bind(this);
		}
		if(cmd.expand){
			var a=cmd.expand()||[];
			var ids=this.__idsByCommand__[name]||[];
			var m=ids.length;
			for(var i=0,l=a.length;i<l;i++){
				if(a[i]){
					if(!(a[i] instanceof Command)){
						a[i]=new Command(a[i],this);
					}
					if(i<m){
						a[i].id=ids[i];
					}else{
						this.__nextID__=(a[i].id=(this.__nextID__||this.constructor.__minCommandID__))+1;
						ids.push(a[i].id);
					}
					this.__commandByID__[a[i].id]=a[i];
					if(a[i].group && a[i].active){
						this.__commandSelectionByGroup__[a[i].group]=a[i];
					}else if(a[i].group && !this.__commandSelectionByGroup__[a[i].group]){
						this.__commandSelectionByGroup__[a[i].group]=a[i];
						a[i].activate();
					}
				}
			}
			this.__idsByCommand__[name]=ids;
			return(a);
		}else{
			if(!cmd.id){
				this.__nextID__=(cmd.id=(this.__nextID__||this.constructor.__minCommandID__))+1;
				if(this.__nextID__>this.constructor.__maxCommandID__){
					this.__nextID__=this.constructor.__minCommandID__;
				}
				this.__commandByID__[cmd.id]=cmd;
			}
			if(cmd.group && cmd.active){
				this.__commandSelectionByGroup__[cmd.group]=cmd;
			}else if(cmd.group && !this.__commandSelectionByGroup__[cmd.group]){
				cmd.activate();
				this.__commandSelectionByGroup__[cmd.group]=cmd;
			}
			return(cmd);
		}
	},
	setSelection:function(group,command){
		var old=(this.__commandSelectionByGroup__||(this.__commandSelectionByGroup__={}))[group];
		if(old){
			old.deactivate();
		}
		command.activate();
		this.__commandSelectionByGroup__[group]=command;
		return(this);
	},
});

var Command=new Class({},EventMixin,{
	__new__:function(options,rcv){
		var _this=this;
		if(typeof(options)=='function'){
			options={action:options};
		}else if(options instanceof Array){
			options={items:options};
		}
		if(options.items||options.getItems){
			this.expand=let(f=options.getItems)((f)?(function()(f.call(_this.receiver))):(function()(options.items)));
			this.isParent=!!options.isParent;
			this.action=this.undo=Function.doNothing;
		}else if('action' in options){
			this.action=options.action;
			this.undo=options.undo;
		}else if(options.group){
			this.group=options.group;
			this.action=function(cx){
				if(!_this.active){
					cx.oldSelection=_this.receiver.getSelection(_this.group);
					_this.activate();
				}
			}
			this.undo=function(cx)(cx.oldSelection && cx.oldSelection.activate());
		}else{
			this.action=this.undo=function()(_this.active=!_this.active);
		}
		this.params=options.params||{};
		this.getActive=options.getActive||function()(_this.__active__);
		this.setActive=options.setActive||function(b)(_this.__active__=b);
		this.__active__=!!options.active;
		this.getEnabled=options.getEnabled||function()(_this.__enabled__);
		this.setEnabled=options.setEnabled||function(b)(_this.__enabled__=b);
		this.__enabled__=(!options.disabled)&&(('enabled' in options)?options.enabled:true);
		this.getDuration=options.getDuration||function()(options.duration);
		for each(let [n,v] in Iterator(options.events||{})){
			this.observe(n,v);
		}
		this.name=options.name;
		this.title=options.title||this.name;
		this.description=options.description||this.title;
		this.receiver=rcv;
		this.__options__=options;
	},
	bind:function(rcv)(new Command(this.__options__,rcv)),
	prepare:function(params)(new CommandContext(this,params)),
	execute:function(params)(this.prepare(params||{}).execute()),
	
	enable:function()(this.enabled=true),
	disable:function()(this.enabled=false),
	get enabled()(this.getEnabled.call(this.receiver)),
	set enabled(b){
		if((!!b!=!!this.enabled) && this.fire(b?'enable':'disable')){
			this.setEnabled.call(this.receiver,b);
		}
	},
	activate:function()(this.active=true),
	deactivate:function()(this.active=false),
	get active()(this.getActive.call(this.receiver)),
	set active(b){
		if((!!b!=!!this.active) && this.fire(b?'activate':'deactivate')){
			this.setActive.call(this.receiver,b);
			if(b && this.group){
				this.receiver.setSelection(this.group,this);
			}
		}
	},
	
});

var CommandContext=new Class({
	__new__:function(cmd,params){
		this.command=cmd;
		this.params=params||{};
		this.timeCreated=new Date();
		this.status="preparing";
	},
	setParams:function(params)(this.params=Object.extend(this.params,params||{})),
	get elapsed()(this.timeExecuted&&(new Date()).getTime()-this.timeExecuted.getTime()),
	get remain()(this.timeExecuted&&this.command.getDuration&&(this.command.getDuration.call(this.command.receiver,this)-(new Date()).getTime()+this.timeExecuted.getTime())),
	execute:function(){
		if(this.status=='preparing' || this.status=='undone'){
			try{
				for each(let [n,v] in Iterator(this.command.params)){
					if(!(n in this.params)){
						this.params[n]=(typeof(v)=='function')?(v.call(this.command.receiver,this)):v;
					}
				}
				if(this.command.fire('execute',{context:this})){
					this.timeExecuted=new Date();
					this.status='running';
					this.result=this.command.action.call(this.command.receiver,this);
					this.command.fire('finish',{context:this});
					this.timeFinished=new Date();
					this.status='finished';
				}
				return(this.result);
			}catch(e){
				this.command.fire('fail',{context:this,exception:e});
				this.status='failed';
			}
		}
	},
	undo:function(){
		try{
			if(this.command.undo && this.status=='finished' && this.command.fire('undo',{context:this})){
				this.status='undoing';
				this.command.undo.call(this.command.receiver,this,this.result);
				this.status='undone';
				this.command.fire('undone',{context:this});
			}
		}catch(e){
			this.command.fire('fail',{context:this,exception:e});
			this.status='failed';
		}
	},
});



let(
	systemInfo=new Struct({
		oemId:						UInt,
		pageSize:					UInt,
		minimumApplicationAddress:	UInt,
		maximumApplicationAddress:	UInt,
		activeProcessorMask:		UInt,
		numberOfProcessors:			UInt,
		processorType:				UInt,
		allocationGranularity:		UInt,
		processorLevel:				Word,
		processorRevision:			Word,
	}),
	GetSystemInfo=			kernel32.proc('GetSystemInfo',[Pointer],UInt),
	GetWindowsDirectory=	kernel32.proc('GetWindowsDirectoryW',[WideString,UInt],UInt),
	GetSystemDirectory=		kernel32.proc('GetSystemDirectoryW',[WideString,UInt],UInt),
	GetTempPath=			kernel32.proc('GetTempPathW',[UInt,Pointer],UInt),
	SHGetSpecialFolderPath=	shell32.proc('SHGetSpecialFolderPathW',[UInt,WideString,Int,Int],Int),
	GetUserName=			advapi32.proc('GetUserNameW',[WideString,Pointer],UInt),
	
	
	GetEnvironmentVariable=	kernel32.proc("GetEnvironmentVariableW",[WideString,WideString,Int],Int),
	SetEnvironmentVariable=	kernel32.proc("SetEnvironmentVariableW",[WideString,WideString],Int),
	ExpandEnvironmentStrings=	kernel32.proc("ExpandEnvironmentStringsW",[WideString,WideString,Int],Int),
	
	
	GetThreadLocale=		kernel32.proc('GetThreadLocale',[],UInt),
	SetThreadLocale=		kernel32.proc('SetThreadLocale',[UInt],UInt),
	GetSystemDefaultLCID=	kernel32.proc("GetSystemDefaultLCID",[],UInt),
	GetUserDefaultLCID=	kernel32.proc("GetUserDefaultLCID",[],Int),
	GetLocaleInfo=	kernel32.proc("GetLocaleInfoW",[UInt,UInt,WideString,Int],Int),
	
	ReadFile=				kernel32.proc('ReadFile',[UInt,Pointer,UInt,Pointer,Pointer],Int,true),

	MessageBox=				user32.proc('MessageBoxW',[UInt,WideString,WideString,UInt],Int),

	GetModuleHandle=		kernel32.proc("GetModuleHandleW",[WideString],UInt),
	GetCurrentDirectory=	kernel32.proc('GetCurrentDirectoryW',[UInt,WideString],UInt),
	SetCurrentDirectory=	kernel32.proc('SetCurrentDirectoryW',[[WideString]],UInt),
	GetCommandLine=			kernel32.proc('GetCommandLineW',[],WideString),
	GetStdHandle=			kernel32.proc("GetStdHandle",[Int],UInt),
	SetStdHandle=			kernel32.proc("SetStdHandle",[Int,UInt],UInt),
	AllocConsole=			kernel32.proc("AllocConsole",[],Int),
	GetFileType=		kernel32.proc('GetFileType',[UInt],UInt),
	FreeConsole=			kernel32.proc("FreeConsole",[],Int,true),
	GetConsoleWindow=		kernel32.proc('GetConsoleWindow',[],UInt),
//	GetConsoleProcessList=	kernel32.proc('GetConsoleProcessList',[Pointer,UInt],UInt),
	AttachConsole=			kernel32.proc('AttachConsole',[Int],Int),
	SetConsoleMode=			kernel32.proc('SetConsoleMode',[UInt,UInt]),
	CreateFile=				kernel32.proc('CreateFileW',[WideString,UInt,UInt,SecurityAttributes,UInt,UInt,Int],Int),
	Sleep=					kernel32.proc("Sleep",[UInt],Int),
	
	
	
	MemoryStatusEx=new Struct({
		length:						UInt,
		load:						UInt,
		totalPhysLow:				UInt,
		totalPhysHigh:				UInt,
		availPhysLow:				UInt,
		availPhysHigh:				UInt,
		totalPageFileLow:			UInt,
		totalPageFileHigh:			UInt,
		availPageFileLow:			UInt,
		availPageFileHigh:			UInt,
		totalVirtualLow:			UInt,
		totalVirtualHigh:			UInt,
		availVirtualLow:			UInt,
		availVirtualHigh:			UInt,
		availExtendedVirtualLow:	UInt,
		availExtendedVirtualHigh:	UInt,
	}),
	GlobalMemoryStatusEx=	kernel32.proc('GlobalMemoryStatusEx',[Pointer],Int),
	
	
	HandlerRoutine=			ThreadSafeStdCallback.define([UInt],Int),
	SetConsoleCtrlHandler=	kernel32.proc('SetConsoleCtrlHandler',[Pointer,Int],Int),
	SetProcessShutdownParameters=kernel32.proc('SetProcessShutdownParameters',[UInt,UInt],Int),
	SystemPowerStatus=new Struct({
		acLineStatus:		Byte,
		batteryFlag:		Byte,
		batteryLifePercent:	Byte,
		res:				Byte,
		batteryLifeTime:	UInt,
		batteryFullLifeTime:UInt,
	}),
	GetSystemPowerStatus=		kernel32.proc('GetSystemPowerStatus',[Pointer],UInt),
	SetThreadExecutionState=	kernel32.proc('SetThreadExecutionState',[UInt],UInt),
	TokenPrivileges=new Struct({
		count:		UInt,
		luidLow:	UInt,
		luidHigh:	Int,
		attributes:	UInt,
	}),
	OpenProcessToken=		advapi32.proc('OpenProcessToken',[UInt,UInt,Pointer],UInt),
	LookupPrivilegeValue=	advapi32.proc('LookupPrivilegeValueW',[WideString,WideString,Pointer],UInt),
	AdjustTokenPrivileges=	advapi32.proc('AdjustTokenPrivileges',[UInt,UInt,Pointer,UInt,Pointer,Pointer],UInt),
	ExitWindowsEx=			user32.proc('ExitWindowsEx',[UInt,UInt],UInt),
	SetSystemPowerState=	kernel32.proc('SetSystemPowerState',[UInt,UInt],UInt)
	
){
	var free=function(){
		for(var i=0,l=arguments.length;i<l;i++){
			if(arguments[i] && (typeof(arguments[i].free)=='function')){
				arguments[i].free();
			}
		}
	};
	var alert=function(msg)(MessageBox(0,String(msg),Main.script.name,0x00010000),msg);
	var confirm=function(msg)(MessageBox(0,String(msg),Main.script.name,0x00010001)==1);
	var prompt=function(message,def,opt){
		opt=opt||{};
		var multi=opt.multiLine;
		var result;
		with(require('Window')){
			var w=Window.create({
				isDialog:true,
				title:opt.title||'NIL prompt',
				width:opt.width||480,
				height:opt.height||(multi?240:120),
				left:opt.x||80,
				top:opt.y||60,
				commands:{
					'cancel':function(){
						this.close(true);
					},
					'ok':function(){
						result=this.edit.text;
						this.close();
					},
				},
				accelerators:{
					'Ctrl+Enter':	'ok',
					'Esc':			'cancel',
				},
				texts:(new StringTable('strings.prompt',{
					'ok':'&OK',
					'cancel':'&Cancel',
				})),
				children:{
					message:{
						type:Static,
						text:String(message),
						top:4,
						left:4,
						right:4,
						height:20,
						noPrefix:true,
					},
					edit:{
						type:Edit,
						noHideSel:true,
						text:def||"",
						wantReturn:!!multi,
						hasVScroll:!!multi,
						hasHScroll:!!multi,
						multiline:!!multi,
						top:28,
						left:4,
						right:4,
						bottom:48,
					},
					cancel:{
						type:Button,
						height:24,
						width:64,
						right:8,
						bottom:8,
						events:{
							click:function()(this.parent.executeCommand('cancel')),
						},
					},
					ok:{
						type:Button,
						isDefault:true,
						height:24,
						width:64,
						right:80,
						bottom:8,
						events:{
							click:function()(this.parent.executeCommand('ok')),
						},
					},
				},
					
			});
			w.moveToCenter();
			if('x' in opt){
				w.x=opt.x;
			}
			if('y' in opt){
				w.y=opt.y;
			}
			w.show().activate(true).focus('edit');
			w.wait('destroy');
			while(w.ownerThread){
				sleep(10);
			}
		}
		return(result);
	};
	var ScriptFile=new Class(File,{
		eval:function()(__NG__EvalString(this.load()||"",this.path,1)),
	});
	
	var Main=new (new Class({},EventMixin,{
		platform:'win32',
		loopInterval:50,
		handle:GetModuleHandle(null),
		get hasConsole()(GetConsoleWindow()!=0),
		allocConsole:function(opt){
			opt=opt||0;
			if(((opt&1)==0) && (GetFileType(GetStdHandle(-10)) || GetFileType(GetStdHandle(-11)))){
				return(false);
			}
			if(this.hasConsole){
				if(!(opt&4)){
					return(false);
				}else{
					FreeConsole();
				}
			}
			if(((opt&2)==0)||(0==AttachConsole(-1))){
				AllocConsole();
			}
			SetStdHandle(-10,CreateFile("CONIN$",0xC0000000,3,null,3,0,0));
			SetStdHandle(-11,CreateFile("CONOUT$",0xC0000000,3,null,3,0,0));
			SetStdHandle(-12,CreateFile("CONOUT$",0xC0000000,3,null,3,0,0));
			SetConsoleMode(GetStdHandle(-10),1);
			return(true);
		},
		
		get stdin() (this.__stdin__  || (this.__stdin__ =new FileStream((this.allocConsole(),GetStdHandle(-10))))),
		get stdout()(this.__stdout__ || (this.__stdout__=new FileStream((this.allocConsole(),GetStdHandle(-11))))),
		get stderr()(this.__stderr__ || (this.__stderr__=new FileStream((this.allocConsole(),GetStdHandle(-12))))),
		set stdin(v) (SetStdHandle(-10,(this.__stdin__ =(v.handle?v:cwd().file(v).openRead())).handle)),
		set stdout(v)(SetStdHandle(-11,(this.__stdout__=(v.handle?v:cwd().file(v).openWrite())).handle)),
		set stderr(v)(SetStdHandle(-12,(this.__stderr__=(v.handle?v:cwd().file(v).openWrite())).handle)),
		
		get window()(this.__window__||(this.__window__=require('Window').Window.create({
			commands:{'exit':function()(exit())},
			texts:new StringTable('standardCommandTitles',{'exit':'終了(&X)'}),
		}))),
		set window(w)(this.__window__=w),
		createNotifyIcon:function(file)(this.window.notifyIcon||this.window.addNotifyIcon({
			icon:file?((typeof(file)=='string')?(cwd().file(file)):file):resource('nil.ico'),
			text:this.script.path,
			contextMenu:['exit'],
		})),
		get notifyIcon()(this.window.notifyIcon),
		
		addCommands:function(o)(this.window.addCommands(o)),
		addTexts:function(o)(this.window.addTexts(o)),
		executeCommand:function(n,p)(this.window.executeCommand(n,p)),
		getSelection:function(g)(this.window.getSelection(g)),
		
		pause:function(msg,timeout){
			this.stdin.readText(0,0);
			echo(msg||"");
			try{
				var buf=Byte.alloc(1);
				var num=UInt.alloc();
				ReadFile(GetStdHandle(-10),buf,1,num,null);
				return(buf.toString());
			}finally{
				buf&&buf.free();
				num&&num.free();
			}
		},
		commandline:GetCommandLine().toString(),
		main:function(){
			var fn=this.arguments[1],f=fn&&((fn.match(/\.\w+$/)?cwd().file(fn):this.directory.file(fn+".ng")));
			if(f.exists){
				this.script=new ScriptFile(f);
			}else if(fn){
				throw('commandline error: 1st argument is not an existing file name("'+f+'")');
			}else{
				throw("usage: "+this.arguments[0]+" [scriptfile [arguments...]");
			}
			this.appName=this.script.baseName;
			this.scriptDirectory=this.script.parent;
			this.script.eval();
		},
		gcInterval:10000,
		execute:function(file){
			try{
				(this.main)();
				if(this.residentCount){
					this.residentMutex=this.residentMutex||new Mutex(this.commandline+":mutex");
					var signal=new Signal(this.commandline+":event");
					this.fire('beginLoop');
					var lastGC=(new Date()).getTime();
					while(!('exitCode' in this) && (this.residentCount>0)){
						try{
							if(signal.wait(0)){
								this.exitReason='newInstance';
								break;
							}
							if(this.fire('loop')){
								sleep(this.loopInterval);
								var curTime=(new Date()).getTime();
								if(curTime>(lastGC+this.gcInterval)){
									__NG__MaybeGC();
									lastGC=curTime;
								}
							}
						}catch(e){
						}
					}
				}
				this.fire('succeed');
			}catch(e if e===this.exit){
				this.fire('succeed');
			}catch(e){
				let obj=this.fire('fail',{exception:e});
				if(obj){
					if(this.isCUI){
						println(obj.exception);
					}else{
						alert(obj.exception);
					}
				}
			}finally{
				if(this.restartArguments){
					var args=[];
					for(var i=0,l=Math.max(this.arguments.length,this.restartArguments.length);i<l;i++){
						var v=String(this.restartArguments[i]||this.arguments[i]||"");
						if(v){
							if(v.indexOf(' ')!=-1){
								v='"'+v+'"';
							}
							args.push(v);
						}
					}
					var obj={};
					if(this.restartWithInitialWorkingDirectory){
						obj.workdir=this.initialWorkingDirectory;
					}
					if(this.restartWithCurrentStdHandles){
						obj.stdin=GetStdHandle(-10);
						obj.stdout=GetStdHandle(-11);
						obj.stderr=GetStdHandle(-12);
						obj.shareStream=1;
					}
					Process.create(args.join(' '),obj);
				}
				try{
					Thread.current.fire("exit");
				}catch(e){
				}
				this.fire('exit');
			}
			return(this.exitCode||0);
		},
		reside:function()(this.residentCount=(this.residentCount||0)+1),
		unreside:function()(Math.max(this.residentCount=(this.residentCount||0)-1,0)),
		exit:function(code,reason){
			this.exitCode=code||0;
			this.exitReason=reason;
			throw(arguments.callee);
		},
		restart:function(args,reuseStdHandles,resetWorkDir){
			this.restartArguments=args||[];
			this.restartWithCurrentStdHandles=reuseStdHandles;
			this.restartWithInitialWorkingDirectory=resetWorkDir;
			this.exit(0,"restart");
		},
		singletonize:function(timeout){
			timeout=timeout||0;
			var mutex=new Mutex(this.commandline+":mutex");
			if(!mutex.lock(0)){
				if(timeout<0){
					throw("process already exists");
				}else if(timeout==0){
					this.exit(0,"instanceExists");
				}else{
					Signal.turnOn(this.commandline+":event");
					if(!mutex.lock(timeout)){
						throw("previous process didn't accept quit event");
					}
					Signal.turnOff(this.commandline+":event");
				}
			}
			this.residentMutex=mutex;
		},
		get arguments(){
			var a=this.commandline.split(' ');
			var r=[];
			var t;
			for(var i=0,l=a.length;i<l;i++){
				if(t){
					if(a[i].slice(-1)=='"'){
						t.push(a[i].slice(0,-1));
						r.push(t.join(" "));
						t=null;
					}else{
						t.push(a[i]);
					}
				}else if(a[i].slice(0,1)=='"'){
					if(a[i].slice(-1)=='"'){
						r.push(a[i].slice(1,-1));
					}else{
						t=[a[i].slice(1)];
					}
				}else if(a[i]){
					r.push(a[i]);
				}
			}
			return(r);
		},
		get params()(this.arguments.slice((this.script.ext=='.js')?1:2)),
		resource:function(name)(
			this.scriptDirectory.file('res\\custom\\'+name).exists
			||this.scriptDirectory.file('res\\'+System.locale.langName+'\\'+name).exists
			||this.scriptDirectory.file('res\\default\\'+name).exists
			||Main.directory.file('res\\'+System.locale.langName+'\\'+name).exists
			||Main.directory.file('res\\default\\'+name).exists
		||null),
			
		pref:function(name,forWriting){
			if(forWriting){
				return(this.pref().file(name));
			}else if(!name){
				return(this.scriptDirectory.file('config\\').exists
					||System.dataDirectory.file(Main.appName+"\\").exists
					||this.scriptDirectory.file('users\\'+System.userName+'\\').create().exists
					||System.dataDirectory.file(Main.appName+"\\").create().exists
					||null
				);
			}else if(this.scriptDirectory.file('config\\').exists){
				return(this.scriptDirectory.file('config\\'+name).exists||this.scriptDirectory.file('users\\default\\'+name).exists||this.pref(name,true));
			}else{
				return(System.dataDirectory.file(Main.appName+"\\"+name).exists
					||this.scriptDirectory.file('users\\'+System.userName+'\\'+name).exists
					||this.scriptDirectory.file('users\\default\\'+name).exists
					||this.pref(name,true)
				);
			}
		},
		createDataDirectory:function(single){
			if(single){
				return(this.scriptDirectory.file('config\\').create().exists);
			}else{
				return(System.dataDirectory.file(Main.appName+"\\").create().exists);
			}
		},
		
		
		sleep:function(t){
			try{
				var sig=new Signal();
				return(sig.wait(t||0));
			}finally{
				free(sig);
			}
		},
		process:new Process(kernel32.proc('GetCurrentProcessId',[],UInt)(),kernel32.proc('GetCurrentProcess',[],UInt)(), new Thread(kernel32.proc('GetCurrentThreadId',[],UInt)())),
		thread:new Thread(kernel32.proc('GetCurrentThreadId',[],UInt)()),
		file :new File(__NG__HostPath()),
		directory:new Directory(__NG__HostPath().replace(/(\\[^\\]+)$/,"")),
		
		get currentDirectory(){
			try{
				var size=GetCurrentDirectory(0,null);
				var buf=WChar.alloc(size);
				GetCurrentDirectory(size,buf);
				return(new Directory(buf.toString()));
			}finally{
				buf && buf.free();
			}
		},
		set currentDirectory(dir)(SetCurrentDirectory((new Directory(String(dir))).extendedPath)),
	}))();
	Main.initialWorkingDirectory=Main.currentDirectory;
	if(Main.isCUI=Main.hasConsole){
		SetConsoleMode(GetStdHandle(-10),1);
	}
	Main.script=new ScriptFile(Main.file.changeExtension('.js'));
	Main.appName=Main.script.baseName;
	Main.scriptDirectory=Main.script.parent;
	
	
	
	var Configuration=new Class({
		__class__:{
			load:function(name,def)((pref(name+'.json')||{loadJSON:function()(def)}).loadJSON()),
		},
		__new__:function(name,def){
			this.__configName__=name;
			Object.extend(this,def||{});
			var f=pref((this.__configName__||Main.appName)+'.json');
			if(f){
				Object.update(this,f.loadJSON());
			}
		},
		get data(){
			var data={};
			for(var n in this){
				switch(n){
					default:data[n]=this[n];
					case('__new__'):case('save'):case('__configName__'):case('data'):;
				}
			}
			return(data);
		},
		save:function(){
			pref((this.__configName__||Main.appName)+'.json',1).saveJSON(this.data);
			return(this);
		},
	});
	
	var StringTable=new Class({
		__new__:function(name,def){
			this.__name__=name||Main.appName;
			var f;
			if(def){
				Object.extend(this,def);
			}else if(f=Main.scriptDirectory.file('res\\default\\'+this.__name__+'.json').exists){
				Object.extend(this,f.loadJSON());
			}
			if(f=Main.scriptDirectory.file('res\\'+System.locale.langName+'\\'+this.__name__+'.json').exists){
				Object.extend(this,f.loadJSON());
			}
			if(f=Main.scriptDirectory.file('res\\custom\\'+this.__name__+'.json').exists){
				Object.extend(this,f.loadJSON());
			}
		},
	});
	
	var Locale=new Class({
		__new__:function(id){
			this.id=id;
		},
		getInfo:function(code){
			try{
				var buf=WChar.alloc(128);
				GetLocaleInfo(this.id,code,buf,126);
				return(buf.toString());
			}finally{
				buf&&buf.free();
			}
		},
		get langID()(this.getInfo(1)),
		get langName()(this.getInfo(0x1001)),
		get langLocalName()(this.getInfo(2)),
		get langShortName()(this.getInfo(0x59)),
		get langNativeName()(this.getInfo(4)),
		
		get countryID()(this.getInfo(5)),
		get countryLocalName()(this.getInfo(6)),
		get countryName()(this.getInfo(0x1002)),
		get countryShortName()(this.getInfo(0x5A)),
		get countryNativeName()(this.getInfo(8)),
		
		get codepage()(1*this.getInfo(0x00001004)),
		
	});

	var thisScript=function()(new ScriptFile((new Error()).stack.split(/\r?\n/)[2].replace(/^.*?@|:\d+$/g,'')));
	var include=function(name){
		var f=(new ScriptFile((new File((new Error()).stack.split(/\r?\n/)[2].replace(/^.*?@|:\d+$/g,''))).parent.file(name)));
		if(f.exists){
			return(f.eval());
		}else{
			throw(new Error('script file not found('+f+')'));
		}
	};
	
	var resource=function(name)(Main.resource(name));
	var pref=function(name,w)(Main.pref(name,w));
	
	var exit=function(code,reason)(Main.exit(code,reason));
	var restart=function(arg)(Main.restart(arg));
	
	var pause=function(msg)(Main.pause(msg));
	var sleep=function(ms)(Main.sleep(ms));
	var echo=function(s)(Main.stdout.write(s));
	var errorDump=function(){
		var a=[];
		for(var i=0,l=arguments.length;i<l;i++){
			a[a.length]=(typeof(arguments[i])=='undefined')?"":(
					(arguments[i] instanceof Error)?
					(arguments[i]+'@'+arguments[i].fileName+':'+arguments[i].lineNumber+"\n"+arguments[i].stack.replace(/[\n\r\s]*$/,"").replace(/^(.{48}).*\)@/mg,'$1 ...)@').indent()):
					String(arguments[i])
				);
		}
		return(a.join('\n'));
	};
	var println=function(){
		var str=errorDump.apply(null,$A(arguments))+"\n";
		for(var j=0,l=str.length;j<l;j+=1024){
			Main.stdout.writeText(str.slice(j,j+1024));
		}
		return(arguments[arguments.length-1]);
	};
	var $P=println;
	var read=function()(Main.stdin.read.apply(Main.stdin,arguments));
	var readln=function()(Main.stdin.readLine());
	var chdir=function(d)(Main.currentDirectory=d);
	var cwd=function()(Main.currentDirectory);
	
	var run=function()(Process.create.apply(Process,arguments));
	
	var setInterval=function(func,ms)((new Timer(func,ms||1)).run());
	var setTimeout=function(func,ms)((new Timer(func,ms||1,true)).run());
	var clearInterval=function(timer){
		if(timer instanceof Timer){
			timer.stop();
			free(timer);
		}
	};
	var clearTimeout=function(timer){
		if(timer instanceof Timer){
			timer.stop();
			free(timer);
		}
	};
	
	
	
	
	let si=systemInfo.alloc();
	let sd=WChar.alloc(261);
	let wd=WChar.alloc(261);
	let un=WChar.alloc(261);
	let ln=UInt.alloc().update(260);
	GetSystemInfo(si);
	GetWindowsDirectory(wd,260);
	GetSystemDirectory(sd,260);
	GetUserName(un,ln);
	
	var System=new Class({},EventMixin,{__class__:{
		__observeFirst__:function(){
			var _this=this;
			SetProcessShutdownParameters(0x4FE,0);
			
			var w=this.__observeWindow__=require('Window').Window.create();
			if(Main.isCUI){
				this.__queryExitHandlerRoutine__=HandlerRoutine.from(function(f){
					return(_this.fire("beforeExit",{suspend:false,shutdown:f==6,logoff:f==5, ctrlC:f==0, ctrlBreak:f==1, consoleClose:f==2})?0:1);
				});
				SetConsoleCtrlHandler(this.__queryExitHandlerRoutine__,1);
			}else{
				this.__queryExitDispatcherProcess__=Process.create('"'+Main.directory.file('lib\\ConsoleCtrlDispatcher.exe').path+'" '+w.handle,0);
			}
			
			w.observe("queryEndSession",function(o){
				if(!_this.fire("beforeExit",{suspend:false, shutDown:!!(o.lparam&0x80000000), logOff:!!(o.lparam&0x80000000), ctrlC:false,ctrlBreak:false,consoleClose:false})){
					o.result=0;
					throw(o);
				}
			});
			w.observe("powerBroadcast",function(o){
				o.result=1;
				switch(o.wparam){
					case(10):{
						_this.fire("powerStatusChange");
						break;
					}case(18):{
						_this.fire("resume",{auto:true});
						break;
					}case(7):{
						_this.fire("resume",{auto:false});
						break;
					}case(4):{
						_this.fire("suspend");
						break;
					}case(32787):{
						_this.fire("powerSettingChange");
						break;
					}case(9):{
						_this.fire("batteryLow");
						break;
					}case(11):{
						_this.fire("oemEvent");
						break;
					}case(0):{
						if(!_this.fire("beforeExit",{suspend:true,shutdown:false,logoff:false,ctrlC:false,ctrlBreak:false,consoleClose:false})){
							o.result=0x424D5144;
							throw(o);
						}
						break;
					}case(2):{
						_this.fire("susppendFailed");
						break;
					}case(6):{
						_this.fire("resume",{critical:true});
						break;
					}
				}
			});
			
		},
		
		
		locale:new Locale(GetSystemDefaultLCID()),
		userLocale:new Locale(GetUserDefaultLCID()),
		get currentLocale()(new Locale(GetThreadLocale())),
		set currentLocale(obj)(SetThreadLocale(obj?(obj.id||obj):1024)),
		
		getEnvVar:function(name){
			try{
				var cnt=GetEnvironmentVariable(name,null,0);
				var buf=WChar.alloc(cnt+2);
				GetEnvironmentVariable(name,buf,cnt+1);
				return(buf.toString());
			}finally{
				buf&&buf.free();
			}
		},
		setEnvVar:function(name,val){
			SetEnvironmentVariable(name,val);
		},
		expandEnvVar:function(str){
			try{
				var cnt=ExpandEnvironmentStrings(str,null,0);
				var buf=WChar.alloc(cnt+2);
				ExpandEnvironmentStrings(str,buf,cnt+1);
				return(buf.toString());
			}finally{
				buf&&buf.free();
			}
		},
		
		processorCount:si.numberOfProcessors,
		processorBitMask:si.activeProcessorMask,
		windowsDirectory:new Directory(wd.toString()),
		systemDirectory:new Directory(sd.toString()),
		get dataDirectory()(new Directory(this.getEnvVar('appdata'))),
		
		get temporaryDirectory(){
			try{
				var buf=WChar.alloc(256);
				GetTempPath(255,buf);
				return(new Directory(buf.toString()));
			}finally{
				free(buf);
			}
		},
		
		get documentsDirectory(){
			try{
				var buf=WChar.alloc(256);
				SHGetSpecialFolderPath(0,buf,0x0005,0);
				return(new Directory(buf.toString()));
			}finally{
				free(buf);
			}
		},
		
		get desktopDirectory(){
			try{
				var buf=WChar.alloc(256);
				SHGetSpecialFolderPath(0,buf,0x0010,0);
				return(new Directory(buf.toString()));
			}finally{
				free(buf);
			}
		},
		
		get userDirectory(){
			try{
				var buf=WChar.alloc(256);
				SHGetSpecialFolderPath(0,buf,0x0028,0);
				return(new Directory(buf.toString()));
			}finally{
				free(buf);
			}
		},
		
		userName:un.toString(),
		computer:new FileServer((function(){
			try{
				var b=WChar.alloc(128);
				var s=UInt.alloc().update(127);
				kernel32.proc('GetComputerNameW',[WideString,Pointer],UInt)(b,s);
				return(b.toString());
			}finally{
				b&&b.free();
				s&&s.free();
			}
		})()),
		
		
		
		__exit__:function(flags,force,reason){
			try{
				var ptkn=UInt.alloc();
				var priv=TokenPrivileges.alloc();
				if(0!=OpenProcessToken(Main.process.handle,0x28,ptkn)){
					priv.count=1;
					LookupPrivilegeValue(null,"SeShutdownPrivilege",(new UInt.pointer(priv)).inc(1));
					priv.attributes=2;
					if(0!=AdjustTokenPrivileges(ptkn.item(),0,priv,16,null,null)){
						if(flags<0){
							SetSystemPowerState((flags<-1)?1:0,force?1:0);
						}else{
							if(!force){
								force=0;
							}else if((typeof(force)=='number')&&(force>1)){
								force=4;
							}else{
								force=0x10;
							}
							ExitWindowsEx((flags||0)|force,reason||0x00040000);
						}
					}
				}
			}finally{
				free(ptkn,priv);
			}
		},
		
		suspend:function(force)(this.__exit__(-2,force)),
		hibernate:function(force)(this.__exit__(-1,force)),
		
		
		suspendFor:function(ms){
			try{
				var s=new Signal();
				var t=new Timer(function(){
					s.turnOn();
				},ms,true,true);
				t.run();
				this.__exit__(-2);
				s.wait();
			}finally{
				free(t,s);
			}
		},
		hibernateFor:function(period){
			try{
				var s=new Signal();
				var t=new Timer(function(){
					s.turnOn();
				},ms,true,true);
				t.run();
				this.__exit__(-1);
				s.wait();
			}finally{
				free(t,s);
			}
		},
		
		
		logoff:function(force,reason)(this.__exit__(0x0,force,reason)),
		restart:function(force,reason)(this.__exit__(0x2,force,reason)),
		shutdown:function(force,reason)(this.__exit__(0x1,force,reason)),
		
		
		awake:function(time)((new Timer(null,time,true,true)).run()),
		keepAwake:function(displayRequired){
			SetThreadExecutionState(0x1 | (displayRequired?0x2:0));
		},
		
		get hasAC(){
			try{
				var state=SystemPowerStatus.alloc();
				if(GetSystemPowerStatus(state)){
					if(state.acLineStatus==255){
						return(void(0));
					}else{
						return(state.acLineStatus!=0);
					}
				}
			}finally{
				free(state);
			}
		},
		get hasBattery(){
			try{
				var state=SystemPowerStatus.alloc();
				if(GetSystemPowerStatus(state)){
					if(state.batteryFlag==255){
						return(void(0));
					}else{
						return(state.batteryFlag!=128);
					}
				}
			}finally{
				free(state);
			}
		},
		get batteryCharging(){
			try{
				var state=SystemPowerStatus.alloc();
				if(GetSystemPowerStatus(state)){
					if(state.batteryFlag==255){
						return(void(0));
					}else{
						return(state.batteryFlag==8);
					}
				}
			}finally{
				free(state);
			}
		},
		get battery(){
			try{
				var state=SystemPowerStatus.alloc();
				if(GetSystemPowerStatus(state)){
					if((state.batteryFullLifeTime!=0xFFFFFFFF)&&(state.batteryLifeTime!=0xFFFFFFFF)){
						return(Math.round(100*(state.batteryLifeTime/state.batteryFullLifeTime)));
					}else if(state.batteryLifePercent!=255){
						return(state.batteryLifePercent);
					}else{
						return({1:70,2:30,4:5}[state.batteryFlag]);
					}
				}
			}finally{
				free(state);
			}
		},
		get batteryMax(){
			try{
				var state=SystemPowerStatus.alloc();
				if(GetSystemPowerStatus(state)){
					if(state.batteryFullLifeTime!=0xFFFFFFFF){
						return(state.batteryFullLifeTime);
					}
				}
			}finally{
				free(state);
			}
		},
		get batteryRemain(){
			try{
				var state=SystemPowerStatus.alloc();
				if(GetSystemPowerStatus(state)){
					if(state.batteryLifeTime!=0xFFFFFFFF){
						return(state.batteryLifeTime);
					}
				}
			}finally{
				free(state);
			}
		},
		
		
		get memory(){
			try{
				var st=MemoryStatusEx.alloc();
				st.length=64;
				if(GlobalMemoryStatusEx(st)){
					var o={
						physical:{
							total:st.totalPhysHigh*0x100000000+st.totalPhysLow,
							avail:st.availPhysHigh*0x100000000+st.availPhysLow,
						},
						pageFile:{
							total:st.totalPageFileHigh*0x100000000+st.totalPageFileLow,
							avail:st.availPageFileHigh*0x100000000+st.availPageFileLow,
						},
						virtual:{
							total:st.totalVirtualHigh*0x100000000+st.totalVirtualLow,
							avail:st.availVirtualHigh*0x100000000+st.availVirtualLow,
						},
					};
					o.physical.used=o.physical.total-o.physical.avail;
					o.pageFile.used=o.pageFile.total-o.pageFile.avail;
					o.virtual.used=o.virtual.total-o.virtual.avail;
					return(o);
				}
			}finally{
				free(st);
			}
		},
		
		
		
	}});
	
	si.free();
	wd.free();
	sd.free();
	un.free();
	ln.free();
}




